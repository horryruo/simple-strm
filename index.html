<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>STRMæ–‡ä»¶ç”Ÿæˆå™¨</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        /* ==================== ä¼˜åŒ–åçš„CSSå˜é‡ ==================== */
        :root {
            /* èƒŒæ™¯è‰² - æ›´æŸ”å’Œçš„ç°è°ƒ */
            --bg-primary: #f2f2f7;
            --bg-secondary: rgba(255, 255, 255, 0.85);
            --bg-tertiary: rgba(250, 250, 252, 0.9);
            --bg-quaternary: rgba(245, 245, 250, 0.95);
            
            /* æ–‡å­—é¢œè‰² - æ›´å¥½çš„å¯¹æ¯”åº¦ */
            --text-primary: #1a1a1f;
            --text-secondary: #6e6e73;
            --text-tertiary: #48484a;
            
            /* å¼ºè°ƒè‰² - ç°ä»£æ¸å˜ */
            --accent-color: #007aff;
            --accent-hover: #0056b3;
            --accent-gradient: linear-gradient(135deg, #6366f1 0%, #8b5cf6 50%, #a855f7 100%);
            --accent-gradient-hover: linear-gradient(135deg, #4f46e5 0%, #7c3aed 50%, #9333ea 100%);
            --accent-soft: rgba(99, 102, 241, 0.12);
            
            /* è¾¹æ¡†å’Œé˜´å½± */
            --border-color: rgba(0, 0, 0, 0.06);
            --border-color-strong: rgba(0, 0, 0, 0.12);
            --shadow-xs: 0 1px 2px rgba(0, 0, 0, 0.04);
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.06), 0 1px 2px rgba(0, 0, 0, 0.04);
            --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.08), 0 2px 4px rgba(0, 0, 0, 0.04);
            --shadow-lg: 0 12px 40px rgba(0, 0, 0, 0.12), 0 4px 12px rgba(0, 0, 0, 0.06);
            --shadow-xl: 0 20px 60px rgba(0, 0, 0, 0.15), 0 8px 20px rgba(0, 0, 0, 0.08);
            --shadow-glow: 0 0 20px rgba(99, 102, 241, 0.3);
            
            /* åœ†è§’ */
            --radius-xs: 6px;
            --radius-sm: 10px;
            --radius-md: 14px;
            --radius-lg: 20px;
            --radius-xl: 28px;
            --radius-full: 9999px;
            
            /* è¿‡æ¸¡åŠ¨ç”» */
            --transition-fast: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
            --transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-slow: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-bounce: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
            
            /* æ¯›ç»ç’ƒæ•ˆæœ - ä¼˜åŒ–æ€§èƒ½ï¼šå‡å°‘blurå€¼ */
            --blur-sm: blur(6px);
            --blur-md: blur(10px);
            --blur-lg: blur(12px);
            
            /* é—´è·ç³»ç»Ÿ */
            --space-xs: 4px;
            --space-sm: 8px;
            --space-md: 16px;
            --space-lg: 24px;
            --space-xl: 32px;
            --space-2xl: 48px;
        }

        [data-theme="dark"] {
            /* æ·±è‰²æ¨¡å¼èƒŒæ™¯ */
            --bg-primary: #0d0d0f;
            --bg-secondary: rgba(28, 28, 32, 0.85);
            --bg-tertiary: rgba(38, 38, 44, 0.9);
            --bg-quaternary: rgba(48, 48, 54, 0.95);
            
            /* æ·±è‰²æ¨¡å¼æ–‡å­— */
            --text-primary: #f5f5f7;
            --text-secondary: #a1a1a6;
            --text-tertiary: #c7c7cc;
            
            /* æ·±è‰²æ¨¡å¼å¼ºè°ƒè‰² */
            --accent-color: #6366f1;
            --accent-hover: #818cf8;
            --accent-soft: rgba(99, 102, 241, 0.2);
            
            /* æ·±è‰²æ¨¡å¼è¾¹æ¡†å’Œé˜´å½± */
            --border-color: rgba(255, 255, 255, 0.08);
            --border-color-strong: rgba(255, 255, 255, 0.15);
            --shadow-xs: 0 1px 2px rgba(0, 0, 0, 0.2);
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.25), 0 1px 2px rgba(0, 0, 0, 0.15);
            --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.3), 0 2px 4px rgba(0, 0, 0, 0.2);
            --shadow-lg: 0 12px 40px rgba(0, 0, 0, 0.4), 0 4px 12px rgba(0, 0, 0, 0.25);
            --shadow-xl: 0 20px 60px rgba(0, 0, 0, 0.5), 0 8px 20px rgba(0, 0, 0, 0.3);
            --shadow-glow: 0 0 30px rgba(99, 102, 241, 0.4);
        }

        /* ==================== åŸºç¡€æ ·å¼é‡ç½® ==================== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'Helvetica Neue', 'PingFang SC', 'Microsoft YaHei', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            transition: var(--transition);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            overflow-x: hidden;
        }

        /* èƒŒæ™¯è£…é¥° - ä¼˜åŒ–ï¼šç§»é™¤åŠ¨ç”»ï¼Œä½¿ç”¨é™æ€èƒŒæ™¯å‡å°‘GPUå‹åŠ› */
        body::before {
            content: '';
            position: fixed;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle at 30% 20%, rgba(99, 102, 241, 0.08) 0%, transparent 40%),
                        radial-gradient(circle at 80% 60%, rgba(168, 85, 247, 0.06) 0%, transparent 40%),
                        radial-gradient(circle at 50% 80%, rgba(59, 130, 246, 0.05) 0%, transparent 40%);
            pointer-events: none;
            z-index: -1;
            /* ç§»é™¤è€—æ€§èƒ½çš„æŒç»­åŠ¨ç”» */
        }

        [data-theme="dark"] body::before {
            background: radial-gradient(circle at 30% 20%, rgba(99, 102, 241, 0.12) 0%, transparent 40%),
                        radial-gradient(circle at 80% 60%, rgba(168, 85, 247, 0.1) 0%, transparent 40%),
                        radial-gradient(circle at 50% 80%, rgba(59, 130, 246, 0.08) 0%, transparent 40%);
        }

        .container {
            max-width: 1100px;
            margin: 0 auto;
            padding: var(--space-2xl) var(--space-lg);
        }

        /* ==================== Header å¤´éƒ¨æ ·å¼ ==================== */
        header {
            text-align: center;
            margin-bottom: var(--space-2xl);
            padding: var(--space-lg) 0;
        }

        .logo {
            font-size: 56px;
            margin-bottom: var(--space-md);
            display: inline-block;
            /* ä¼˜åŒ–ï¼šç§»é™¤æŒç»­åŠ¨ç”»ï¼Œä»…ä¿ç•™é™æ€æ ·å¼ */
            filter: drop-shadow(0 4px 12px rgba(99, 102, 241, 0.3));
            transform: translateZ(0); /* è§¦å‘GPUåŠ é€Ÿ */
        }

        h1 {
            font-size: 44px;
            font-weight: 800;
            letter-spacing: -0.03em;
            margin-bottom: var(--space-sm);
            background: var(--accent-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            /* ä¼˜åŒ–ï¼šç§»é™¤æ¸å˜åŠ¨ç”»ï¼Œä½¿ç”¨é™æ€æ¸å˜ */
            text-shadow: 0 2px 30px rgba(99, 102, 241, 0.3);
        }

        .subtitle {
            font-size: 17px;
            color: var(--text-secondary);
            font-weight: 450;
            letter-spacing: 0.01em;
        }

        /* ==================== ä¸»é¢˜åˆ‡æ¢æŒ‰é’® ==================== */
        .theme-toggle {
            position: fixed;
            top: var(--space-lg);
            right: var(--space-lg);
            width: 52px;
            height: 52px;
            border-radius: var(--radius-full);
            background: var(--bg-secondary);
            backdrop-filter: var(--blur-sm); /* ä¼˜åŒ–ï¼šä½¿ç”¨æ›´å°çš„blur */
            -webkit-backdrop-filter: var(--blur-sm);
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-md);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            transition: transform 0.2s ease, box-shadow 0.2s ease; /* ä¼˜åŒ–ï¼šç®€åŒ–transition */
            z-index: 1000;
            /* ä¼˜åŒ–ï¼šç§»é™¤will-change */
        }

        .theme-toggle:hover {
            transform: scale(1.1) rotate(15deg) translateZ(0);
            box-shadow: var(--shadow-lg), var(--shadow-glow);
            border-color: var(--accent-color);
            will-change: transform;
        }

        .theme-toggle:active {
            transform: scale(0.95);
        }

        /* ==================== å¡ç‰‡æ ·å¼ï¼ˆæ¯›ç»ç’ƒæ•ˆæœï¼‰ ==================== */
        .card {
            background: var(--bg-secondary);
            backdrop-filter: var(--blur-md); /* ä¼˜åŒ–ï¼šé™ä½blurå¼ºåº¦ */
            -webkit-backdrop-filter: var(--blur-md);
            border-radius: var(--radius-xl);
            padding: var(--space-xl);
            margin-bottom: var(--space-lg);
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
            transition: transform 0.25s cubic-bezier(0.4, 0, 0.2, 1),
                        box-shadow 0.25s cubic-bezier(0.4, 0, 0.2, 1),
                        border-color 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            /* ä¼˜åŒ–ï¼šç§»é™¤ will-changeï¼Œä»…åœ¨hoveræ—¶æ·»åŠ  */
            position: relative;
            overflow: hidden;
        }

        /* å¡ç‰‡é¡¶éƒ¨æ¸å˜è£…é¥°çº¿ */
        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--accent-gradient);
            opacity: 0;
            transition: var(--transition);
        }

        .card:hover {
            transform: translateY(-4px) translateZ(0); /* ä¼˜åŒ–ï¼šæ·»åŠ translateZè§¦å‘GPUåŠ é€Ÿ */
            box-shadow: var(--shadow-lg);
            border-color: var(--border-color-strong);
            will-change: transform; /* ä¼˜åŒ–ï¼šä»…åœ¨hoveræ—¶æ·»åŠ will-change */
        }

        .card:hover::before {
            opacity: 1;
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: var(--space-md);
            margin-bottom: var(--space-lg);
        }

        .card-icon {
            width: 48px;
            height: 48px;
            border-radius: var(--radius-md);
            background: var(--accent-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: var(--shadow-sm), 0 4px 12px rgba(99, 102, 241, 0.25);
            transition: var(--transition);
        }

        .card:hover .card-icon {
            transform: scale(1.08) rotate(-3deg);
            box-shadow: var(--shadow-md), 0 6px 20px rgba(99, 102, 241, 0.35);
        }

        .card-title {
            font-size: 21px;
            font-weight: 650;
            letter-spacing: -0.015em;
            color: var(--text-primary);
        }

        /* ==================== æ‹–æ‹½åŒºåŸŸ ==================== */
        .drop-zone {
            border: 2px dashed var(--border-color-strong);
            border-radius: var(--radius-lg);
            padding: var(--space-2xl) var(--space-xl);
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            background: var(--bg-tertiary);
            position: relative;
            overflow: hidden;
        }

        .drop-zone::before {
            content: '';
            position: absolute;
            inset: 0;
            background: var(--accent-gradient);
            opacity: 0;
            transition: var(--transition);
        }

        .drop-zone:hover,
        .drop-zone.dragover {
            border-color: var(--accent-color);
            border-style: solid;
            background: var(--accent-soft);
            transform: scale(1.01);
        }

        .drop-zone.dragover::before {
            opacity: 0.05;
        }

        .drop-zone-icon {
            font-size: 52px;
            margin-bottom: var(--space-md);
            display: inline-block;
            transition: transform 0.3s ease; /* ä¼˜åŒ–ï¼šç®€åŒ–transition */
        }

        .drop-zone:hover .drop-zone-icon {
            transform: translateY(-6px) scale(1.05) translateZ(0); /* ä¼˜åŒ–ï¼šå‡å°å˜åŒ–å¹…åº¦ */
        }

        .drop-zone-text {
            font-size: 17px;
            color: var(--text-tertiary);
            margin-bottom: var(--space-sm);
            font-weight: 500;
        }

        .drop-zone-hint {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .file-input {
            display: none;
        }

        /* ==================== æ–‡ä»¶ä¿¡æ¯ ==================== */
        .file-info {
            display: none;
            align-items: center;
            gap: var(--space-md);
            padding: var(--space-md) var(--space-lg);
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
            margin-top: var(--space-md);
            border: 1px solid var(--border-color);
            transition: var(--transition);
        }

        .file-info.visible {
            display: flex;
            animation: slideInUp 0.3s ease;
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .file-info-icon {
            font-size: 36px;
        }

        .file-info-details {
            flex: 1;
        }

        .file-info-name {
            font-weight: 600;
            margin-bottom: 2px;
            font-size: 15px;
        }

        .file-info-size {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .file-info-remove {
            width: 34px;
            height: 34px;
            border-radius: var(--radius-full);
            background: rgba(255, 59, 48, 0.1);
            border: none;
            color: #ff3b30;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }

        .file-info-remove:hover {
            background: rgba(255, 59, 48, 0.2);
            transform: scale(1.1) rotate(90deg);
        }

        .file-info-remove:active {
            transform: scale(0.95);
        }

        /* ==================== è¾“å…¥æ¡†æ ·å¼ ==================== */
        .input-group {
            display: flex;
            gap: var(--space-md);
        }

        .input-wrapper {
            flex: 1;
            position: relative;
        }

        .input-label {
            display: block;
            font-size: 13px;
            font-weight: 550;
            color: var(--text-secondary);
            margin-bottom: var(--space-sm);
            letter-spacing: 0.02em;
            text-transform: uppercase;
        }

        .text-input {
            width: 100%;
            padding: 15px 18px;
            font-size: 15px;
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            background: var(--bg-tertiary);
            color: var(--text-primary);
            transition: border-color 0.2s ease, box-shadow 0.2s ease, background 0.2s ease; /* ä¼˜åŒ–ï¼šæŒ‡å®šå…·ä½“å±æ€§ */
            font-family: inherit;
            /* ä¼˜åŒ–ï¼šç§»é™¤will-change */
        }

        .text-input:hover {
            border-color: var(--border-color-strong);
        }

        .text-input:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 4px var(--accent-soft), var(--shadow-sm);
            background: var(--bg-secondary);
        }

        .text-input::placeholder {
            color: var(--text-secondary);
            opacity: 0.8;
        }

        /* ==================== æŒ‰é’®æ ·å¼ ==================== */
        .btn {
            padding: 14px 28px;
            font-size: 15px;
            font-weight: 600;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease; /* ä¼˜åŒ–ï¼šæŒ‡å®šå…·ä½“å±æ€§ */
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-sm);
            border: none;
            font-family: inherit;
            position: relative;
            overflow: hidden;
            /* ä¼˜åŒ–ï¼šç§»é™¤will-changeï¼Œä»…åœ¨hoveræ—¶ä½¿ç”¨ */
        }

        .btn::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(180deg, rgba(255,255,255,0.15) 0%, transparent 50%);
            opacity: 0;
            transition: var(--transition);
        }

        .btn:hover::before {
            opacity: 1;
        }

        .btn-primary {
            background: var(--accent-gradient);
            color: white;
            box-shadow: var(--shadow-sm), 0 4px 14px rgba(99, 102, 241, 0.3);
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            /* ä¼˜åŒ–ï¼šç§»é™¤background-sizeåŠ¨ç”» */
        }

        .btn-primary:hover {
            transform: translateY(-3px) translateZ(0);
            box-shadow: var(--shadow-md), 0 8px 25px rgba(99, 102, 241, 0.4);
            /* ä¼˜åŒ–ï¼šç§»é™¤background-positionå˜åŒ– */
        }

        .btn-primary:active {
            transform: translateY(-1px);
            box-shadow: var(--shadow-sm), 0 4px 14px rgba(99, 102, 241, 0.3);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: var(--shadow-xs);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1.5px solid var(--border-color-strong);
            /* ä¼˜åŒ–ï¼šç§»é™¤backdrop-filterï¼Œä½¿ç”¨çº¯è‰²èƒŒæ™¯ */
        }

        .btn-secondary:hover {
            background: var(--bg-quaternary);
            border-color: var(--accent-color);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .btn-secondary:active {
            transform: translateY(0);
        }

        .btn-group {
            display: flex;
            gap: var(--space-md);
            flex-wrap: wrap;
        }

        /* ==================== ç»Ÿè®¡å¡ç‰‡ ==================== */
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: var(--space-md);
            margin-bottom: var(--space-lg);
        }

        .stat-item {
            background: var(--bg-tertiary);
            padding: var(--space-lg);
            border-radius: var(--radius-lg);
            text-align: center;
            border: 1px solid var(--border-color);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .stat-item::before {
            content: '';
            position: absolute;
            inset: 0;
            background: var(--accent-gradient);
            opacity: 0;
            transition: var(--transition);
        }

        .stat-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .stat-item:hover::before {
            opacity: 0.05;
        }

        .stat-value {
            font-size: 36px;
            font-weight: 800;
            background: var(--accent-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            position: relative;
            z-index: 1;
        }

        .stat-label {
            font-size: 13px;
            color: var(--text-secondary);
            margin-top: var(--space-xs);
            font-weight: 500;
            letter-spacing: 0.02em;
            position: relative;
            z-index: 1;
        }

        /* ==================== é¢„è§ˆåˆ—è¡¨ ==================== */
        .preview-container {
            max-height: 420px;
            overflow-y: auto;
            border-radius: var(--radius-lg);
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
        }

        .preview-list {
            list-style: none;
        }

        .preview-item {
            padding: var(--space-md) var(--space-lg);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: flex-start;
            gap: var(--space-md);
            transition: var(--transition);
        }

        .preview-item:last-child {
            border-bottom: none;
        }

        .preview-item:hover {
            background: var(--accent-soft);
        }

        .preview-item-icon {
            font-size: 22px;
            flex-shrink: 0;
        }

        .preview-item-path {
            flex: 1;
            font-family: 'SF Mono', 'Fira Code', Menlo, Monaco, monospace;
            font-size: 13px;
            color: var(--text-tertiary);
            word-break: break-all;
            line-height: 1.5;
        }

        .preview-item-url {
            font-family: 'SF Mono', 'Fira Code', Menlo, Monaco, monospace;
            font-size: 12px;
            color: var(--accent-color);
            word-break: break-all;
            margin-top: var(--space-xs);
            line-height: 1.5;
        }

        /* ==================== ç›®å½•æ ‘è§†å›¾ ==================== */
        .tree-container {
            max-height: 320px;
            overflow-y: auto;
            border-radius: var(--radius-lg);
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            padding: var(--space-lg);
            font-family: 'SF Mono', 'Fira Code', Menlo, Monaco, monospace;
            font-size: 13px;
            line-height: 1.6;
        }

        .tree-node {
            padding: 3px 0;
            padding-left: 22px;
            position: relative;
        }

        .tree-node::before {
            content: '';
            position: absolute;
            left: 7px;
            top: 0;
            bottom: 0;
            width: 1.5px;
            background: var(--border-color-strong);
        }

        .tree-node:last-child::before {
            bottom: 50%;
        }

        .tree-node::after {
            content: '';
            position: absolute;
            left: 7px;
            top: 13px;
            width: 12px;
            height: 1.5px;
            background: var(--border-color-strong);
        }

        .tree-folder {
            color: var(--accent-color);
            font-weight: 500;
        }

        .tree-file {
            color: var(--text-tertiary);
        }

        .tree-folder::before {
            content: 'ğŸ“ ';
        }

        .tree-file::before {
            content: 'ğŸ¬ ';
        }

        /* ==================== ç©ºçŠ¶æ€ ==================== */
        .empty-state {
            text-align: center;
            padding: var(--space-2xl) var(--space-lg);
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 72px;
            margin-bottom: var(--space-lg);
            opacity: 0.4;
            filter: grayscale(0.3);
        }

        .empty-state-text {
            font-size: 17px;
            font-weight: 450;
        }

        /* ==================== è¿›åº¦æ¡ ==================== */
        .progress-bar {
            width: 100%;
            height: 6px;
            background: var(--bg-tertiary);
            border-radius: var(--radius-full);
            overflow: hidden;
            margin-top: var(--space-md);
            display: none;
        }

        .progress-bar.visible {
            display: block;
        }

        .progress-bar-fill {
            height: 100%;
            background: var(--accent-gradient);
            border-radius: var(--radius-full);
            transition: width 0.3s ease;
            position: relative;
        }

        /* ä¼˜åŒ–ï¼šç§»é™¤è¿›åº¦æ¡æµå…‰åŠ¨ç”»ï¼Œä»…ä½¿ç”¨é™æ€æ¸å˜ */
        .progress-bar-fill::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.3) 50%, transparent 100%);
            /* ç§»é™¤æŒç»­åŠ¨ç”» */
        }

        /* ==================== æ»šåŠ¨æ¡æ ·å¼ ==================== */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-color-strong);
            border-radius: var(--radius-full);
            transition: var(--transition);
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-secondary);
        }

        /* ==================== å“åº”å¼è®¾è®¡ ==================== */
        @media (max-width: 768px) {
            .container {
                padding: var(--space-lg) var(--space-md);
            }

            h1 {
                font-size: 32px;
            }

            .subtitle {
                font-size: 15px;
            }

            .logo {
                font-size: 48px;
            }

            .card {
                padding: var(--space-lg);
                border-radius: var(--radius-lg);
            }

            .card-icon {
                width: 42px;
                height: 42px;
                font-size: 20px;
            }

            .card-title {
                font-size: 18px;
            }

            .input-group {
                flex-direction: column;
            }

            .btn-group {
                flex-direction: column;
            }

            .btn {
                width: 100%;
                padding: 16px 24px;
                min-height: 52px;
            }

            .stats {
                grid-template-columns: repeat(3, 1fr);
                gap: var(--space-sm);
            }

            .stat-item {
                padding: var(--space-md);
            }

            .stat-value {
                font-size: 28px;
            }

            .theme-toggle {
                top: var(--space-md);
                right: var(--space-md);
                width: 46px;
                height: 46px;
                font-size: 20px;
            }

            .drop-zone {
                padding: var(--space-xl) var(--space-md);
            }

            .drop-zone-icon {
                font-size: 44px;
            }

            .drop-zone-text {
                font-size: 15px;
            }
        }

        @media (max-width: 480px) {
            .stats {
                grid-template-columns: repeat(3, 1fr);
            }

            .stat-value {
                font-size: 24px;
            }

            .stat-label {
                font-size: 11px;
            }
        }

        /* ==================== å‡å°‘åŠ¨ç”» - ç”¨æˆ·åå¥½ ==================== */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
                scroll-behavior: auto !important;
            }
            
            .card {
                animation: none !important;
                opacity: 1 !important;
            }
            
            .toast {
                animation: none !important;
            }
            
            .tag-item {
                animation: none !important;
            }
            
            .spinner {
                animation: spin 0.8s linear infinite !important; /* ä¿ç•™å¿…è¦çš„åŠ è½½åŠ¨ç”» */
            }
        }

        /* ==================== ç§»åŠ¨ç«¯åŠ¨ç”»ä¼˜åŒ– ==================== */
        @media (max-width: 768px) {
            /* ç§»åŠ¨ç«¯ç¦ç”¨backdrop-filterä»¥æå‡æ€§èƒ½ */
            .card,
            .toast,
            .theme-toggle,
            .webdav-browser,
            .webdav-modal-overlay {
                backdrop-filter: none !important;
                -webkit-backdrop-filter: none !important;
            }
            
            /* ç§»åŠ¨ç«¯å‡å°‘hoveråŠ¨ç”» */
            .card:hover {
                transform: none;
            }
            
            .card:hover .card-icon {
                transform: none;
            }
            
            /* ç§»åŠ¨ç«¯ç®€åŒ–è¿‡æ¸¡ */
            .btn:hover,
            .tag-item:hover,
            .stat-item:hover {
                transform: none;
            }
        }

        /* ==================== åŠ¨ç”»æ•ˆæœï¼ˆæ€§èƒ½ä¼˜åŒ–ç‰ˆï¼‰ ==================== */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .card {
            animation: fadeInUp 0.4s ease forwards;
            opacity: 0;
        }

        .card:nth-child(1) { animation-delay: 0.02s; }
        .card:nth-child(2) { animation-delay: 0.04s; }
        .card:nth-child(3) { animation-delay: 0.06s; }
        .card:nth-child(4) { animation-delay: 0.08s; }
        .card:nth-child(5) { animation-delay: 0.1s; }
        .card:nth-child(6) { animation-delay: 0.12s; }

        /* ==================== Toast é€šçŸ¥ ==================== */
        .toast-container {
            position: fixed;
            bottom: var(--space-lg);
            left: 50%;
            transform: translateX(-50%);
            z-index: 10001;
        }

        .toast {
            background: var(--bg-secondary);
            backdrop-filter: var(--blur-sm); /* ä¼˜åŒ–ï¼šå‡å°‘blurå€¼ */
            -webkit-backdrop-filter: var(--blur-sm);
            color: var(--text-primary);
            padding: 14px 24px;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-xl);
            border: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            animation: toastSlideUp 0.3s ease-out; /* ä¼˜åŒ–ï¼šç®€åŒ–åŠ¨ç”» */
            font-weight: 500;
        }

        /* ä¼˜åŒ–ï¼šç®€åŒ–toaståŠ¨ç”» */
        @keyframes toastSlideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .toast-success {
            border-left: 4px solid #34c759;
            background: linear-gradient(90deg, rgba(52, 199, 89, 0.1) 0%, var(--bg-secondary) 30%);
        }
        .toast-error {
            border-left: 4px solid #ff3b30;
            background: linear-gradient(90deg, rgba(255, 59, 48, 0.1) 0%, var(--bg-secondary) 30%);
        }
        .toast-info {
            border-left: 4px solid #007aff;
            background: linear-gradient(90deg, rgba(0, 122, 255, 0.1) 0%, var(--bg-secondary) 30%);
        }

        /* ==================== Toggle å¼€å…³ï¼ˆiOSé£æ ¼ï¼‰ ==================== */
        .toggle-group {
            display: flex;
            align-items: center;
            gap: var(--space-md);
            margin-top: var(--space-md);
            padding: var(--space-md) var(--space-lg);
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
            border: 1px solid var(--border-color);
            transition: var(--transition);
        }

        .toggle-group:hover {
            background: var(--bg-quaternary);
            border-color: var(--border-color-strong);
        }

        .toggle-label {
            font-size: 15px;
            font-weight: 550;
            color: var(--text-primary);
            flex: 1;
        }

        .toggle-hint {
            font-size: 13px;
            color: var(--text-secondary);
            margin-top: 3px;
            line-height: 1.4;
        }

        .toggle-switch {
            position: relative;
            width: 52px;
            height: 32px;
            flex-shrink: 0;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(180deg, #d8d8dc 0%, #e8e8ed 100%);
            border-radius: var(--radius-full);
            transition: var(--transition);
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1), inset 0 0 0 1px rgba(0, 0, 0, 0.05);
        }

        [data-theme="dark"] .toggle-slider {
            background: linear-gradient(180deg, #3a3a3e 0%, #48484c 100%);
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.2), inset 0 0 0 1px rgba(255, 255, 255, 0.05);
        }

        .toggle-slider::before {
            position: absolute;
            content: "";
            height: 28px;
            width: 28px;
            left: 2px;
            bottom: 2px;
            background: linear-gradient(180deg, #ffffff 0%, #f8f8f8 100%);
            border-radius: 50%;
            transition: var(--transition);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15), 0 1px 2px rgba(0, 0, 0, 0.1), 0 0 0 0.5px rgba(0, 0, 0, 0.05);
        }

        .toggle-switch input:checked + .toggle-slider {
            background: linear-gradient(180deg, #30d158 0%, #34c759 100%);
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1), 0 0 12px rgba(52, 199, 89, 0.4);
        }

        .toggle-switch input:checked + .toggle-slider::before {
            transform: translateX(20px);
        }

        .toggle-switch input:focus + .toggle-slider {
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1), 0 0 0 4px rgba(52, 199, 89, 0.25);
        }

        .toggle-switch:hover .toggle-slider::before {
            transform: scale(1.02);
        }

        .toggle-switch input:checked:hover + .toggle-slider::before {
            transform: translateX(20px) scale(1.02);
        }

        .toggle-status {
            font-size: 13px;
            color: var(--text-secondary);
            min-width: 40px;
            text-align: right;
            font-weight: 500;
            transition: var(--transition);
        }

        .toggle-status.active {
            color: #34c759;
        }

        /* ==================== æ ‡ç­¾è¾“å…¥ï¼ˆæ–‡ä»¶åç¼€åï¼‰ ==================== */
        .tag-input-container {
            margin-top: var(--space-md);
        }

        .tag-list {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-sm);
            padding: var(--space-md);
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
            min-height: 64px;
            margin-bottom: var(--space-md);
            border: 1px solid var(--border-color);
            align-content: flex-start;
        }

        .tag-item {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 7px 14px;
            background: var(--accent-gradient);
            color: white;
            border-radius: var(--radius-full);
            font-size: 13px;
            font-weight: 600;
            /* ä¼˜åŒ–ï¼šç®€åŒ–å…¥åœºåŠ¨ç”»ï¼Œä»…ä½¿ç”¨opacityå’Œscale */
            animation: tagFadeIn 0.2s ease-out;
            box-shadow: 0 2px 8px rgba(99, 102, 241, 0.3);
            transition: transform 0.15s ease, box-shadow 0.15s ease;
        }

        .tag-item:hover {
            transform: translateY(-1px) translateZ(0);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
        }

        /* ä¼˜åŒ–ï¼šç®€åŒ–æ ‡ç­¾å…¥åœºåŠ¨ç”» */
        @keyframes tagFadeIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .tag-item-remove {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.25);
            border: none;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            transition: var(--transition);
            padding: 0;
            line-height: 1;
        }

        .tag-item-remove:hover {
            background: rgba(255, 255, 255, 0.45);
            transform: rotate(90deg);
        }

        .tag-input-row {
            display: flex;
            gap: var(--space-sm);
        }

        .tag-input {
            flex: 1;
            padding: 12px 16px;
            font-size: 14px;
            border: 2px solid var(--border-color);
            border-radius: var(--radius-sm);
            background: var(--bg-tertiary);
            color: var(--text-primary);
            transition: var(--transition);
            font-family: inherit;
        }

        .tag-input:hover {
            border-color: var(--border-color-strong);
        }

        .tag-input:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 4px var(--accent-soft);
            background: var(--bg-secondary);
        }

        .tag-btn {
            padding: 12px 18px;
            font-size: 14px;
            font-weight: 600;
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: var(--transition);
            border: none;
            font-family: inherit;
            white-space: nowrap;
        }

        .tag-btn-add {
            background: var(--accent-gradient);
            color: white;
            box-shadow: 0 2px 8px rgba(99, 102, 241, 0.3);
        }

        .tag-btn-add:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 14px rgba(99, 102, 241, 0.4);
        }

        .tag-btn-add:active {
            transform: translateY(0);
        }

        .tag-btn-reset {
            background: var(--bg-tertiary);
            color: var(--text-tertiary);
            border: 1.5px solid var(--border-color-strong);
        }

        .tag-btn-reset:hover {
            background: var(--bg-secondary);
            border-color: var(--text-secondary);
            transform: translateY(-1px);
        }

        .tag-hint {
            margin-top: var(--space-sm);
            font-size: 13px;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* ==================== WebDAV æŠ˜å é¢æ¿ ==================== */
        .collapsible-panel {
            margin-top: var(--space-lg);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            overflow: hidden;
            background: var(--bg-tertiary);
            transition: var(--transition);
        }

        .collapsible-panel:hover {
            border-color: var(--border-color-strong);
        }

        .collapsible-header {
            display: flex;
            align-items: center;
            gap: var(--space-md);
            padding: var(--space-md) var(--space-lg);
            background: var(--bg-tertiary);
            cursor: pointer;
            transition: var(--transition);
        }

        .collapsible-header:hover {
            background: var(--bg-quaternary);
        }

        .collapsible-icon {
            font-size: 18px;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            color: var(--text-secondary);
        }

        .collapsible-panel.expanded .collapsible-icon {
            transform: rotate(90deg);
        }

        .collapsible-title {
            flex: 1;
            font-size: 15px;
            font-weight: 550;
            color: var(--text-primary);
        }

        .collapsible-status {
            font-size: 12px;
            padding: 5px 12px;
            border-radius: var(--radius-full);
            background: var(--bg-secondary);
            color: var(--text-secondary);
            font-weight: 500;
            transition: var(--transition);
        }

        .collapsible-status.connected {
            background: rgba(52, 199, 89, 0.15);
            color: #34c759;
        }

        .collapsible-status.error {
            background: rgba(255, 59, 48, 0.15);
            color: #ff3b30;
        }

        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .collapsible-panel.expanded .collapsible-content {
            max-height: 800px;
        }

        .collapsible-body {
            padding: var(--space-lg);
            border-top: 1px solid var(--border-color);
        }

        .webdav-form-group {
            margin-bottom: var(--space-md);
        }

        .webdav-form-group:last-of-type {
            margin-bottom: var(--space-lg);
        }

        .webdav-label {
            display: block;
            font-size: 13px;
            font-weight: 550;
            color: var(--text-secondary);
            margin-bottom: 6px;
            letter-spacing: 0.02em;
            text-transform: uppercase;
        }

        .webdav-input {
            width: 100%;
            padding: 13px 16px;
            font-size: 14px;
            border: 2px solid var(--border-color);
            border-radius: var(--radius-sm);
            background: var(--bg-tertiary);
            color: var(--text-primary);
            transition: var(--transition);
            font-family: inherit;
        }

        .webdav-input:hover {
            border-color: var(--border-color-strong);
        }

        .webdav-input:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 4px var(--accent-soft);
            background: var(--bg-secondary);
        }

        .webdav-input::placeholder {
            color: var(--text-secondary);
            opacity: 0.8;
        }

        .webdav-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-md);
        }

        @media (max-width: 768px) {
            .webdav-row {
                grid-template-columns: 1fr;
            }

            /* WebDAV ç›®å½•æµè§ˆå™¨ç§»åŠ¨ç«¯é€‚é… */
            .webdav-browser-header {
                padding: 14px 16px;
                gap: 10px;
            }

            .webdav-breadcrumb {
                font-size: 14px;
                gap: 4px;
            }

            .webdav-breadcrumb-item {
                padding: 6px 12px;
                font-size: 14px;
            }

            .webdav-browser-content {
                max-height: 400px;
            }

            .webdav-file-item {
                padding: 14px 16px;
                gap: 12px;
            }

            .webdav-file-icon {
                font-size: 28px;
            }

            .webdav-file-name {
                font-size: 15px;
            }

            .webdav-file-meta {
                font-size: 12px;
            }

            .webdav-browser-loading,
            .webdav-browser-empty {
                padding: 50px 20px;
                font-size: 14px;
            }

            .webdav-browser-empty-icon {
                font-size: 48px;
            }
            
            .tag-input-row {
                flex-direction: column;
            }
            
            .tag-btn {
                width: 100%;
            }
        }

        .webdav-btn-group {
            display: flex;
            gap: var(--space-md);
        }

        .webdav-btn {
            flex: 1;
            padding: 13px 22px;
            font-size: 14px;
            font-weight: 600;
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: var(--transition);
            border: none;
            font-family: inherit;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-sm);
        }

        .webdav-btn-connect {
            background: var(--accent-gradient);
            color: white;
            box-shadow: 0 2px 8px rgba(99, 102, 241, 0.3);
        }

        .webdav-btn-connect:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(99, 102, 241, 0.4);
        }

        .webdav-btn-connect:active {
            transform: translateY(0);
        }

        .webdav-btn-connect:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .webdav-btn-save {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1.5px solid var(--border-color-strong);
        }

        .webdav-btn-save:hover {
            background: var(--bg-secondary);
            border-color: var(--accent-color);
            transform: translateY(-1px);
        }

        .webdav-message {
            margin-top: var(--space-md);
            padding: var(--space-md);
            border-radius: var(--radius-md);
            font-size: 13px;
            display: none;
            animation: slideInUp 0.3s ease;
        }

        .webdav-message.visible {
            display: block;
        }

        .webdav-message.success {
            background: linear-gradient(135deg, rgba(52, 199, 89, 0.12) 0%, rgba(52, 199, 89, 0.06) 100%);
            color: #34c759;
            border: 1px solid rgba(52, 199, 89, 0.25);
        }

        .webdav-message.error {
            background: linear-gradient(135deg, rgba(255, 59, 48, 0.12) 0%, rgba(255, 59, 48, 0.06) 100%);
            color: #ff3b30;
            border: 1px solid rgba(255, 59, 48, 0.25);
        }

        .webdav-message.info {
            background: linear-gradient(135deg, rgba(0, 122, 255, 0.12) 0%, rgba(0, 122, 255, 0.06) 100%);
            color: #007aff;
            border: 1px solid rgba(0, 122, 255, 0.25);
        }

        .webdav-cors-hint {
            margin-top: var(--space-md);
            padding: var(--space-md);
            background: linear-gradient(135deg, rgba(255, 204, 0, 0.1) 0%, rgba(255, 204, 0, 0.05) 100%);
            border: 1px solid rgba(255, 204, 0, 0.2);
            border-radius: var(--radius-md);
            font-size: 12px;
            color: var(--text-tertiary);
            line-height: 1.5;
        }

        .webdav-cors-hint strong {
            color: #cc9900;
        }

        [data-theme="dark"] .webdav-cors-hint strong {
            color: #ffcc00;
        }

        /* ==================== è®°ä½å¯†ç å¤é€‰æ¡† ==================== */
        .remember-password-label {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            margin-top: var(--space-sm);
            font-size: 13px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: var(--transition);
        }

        .remember-password-label:hover {
            color: var(--text-primary);
        }

        .remember-password-label input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: var(--accent-color);
            border-radius: var(--radius-xs);
        }

        .remember-password-label span {
            user-select: none;
        }

        /* ==================== åŠ è½½åŠ¨ç”» ==================== */
        .spinner {
            width: 18px;
            height: 18px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ==================== WebDAV ç›®å½•æµè§ˆæ¨¡æ€æ¡† ==================== */
        .webdav-modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5); /* ä¼˜åŒ–ï¼šå¢åŠ ä¸é€æ˜åº¦æ›¿ä»£blur */
            backdrop-filter: var(--blur-sm); /* ä¼˜åŒ–ï¼šå‡å°‘blurå€¼ */
            -webkit-backdrop-filter: var(--blur-sm);
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.25s ease, visibility 0.25s ease; /* ä¼˜åŒ–ï¼šæŒ‡å®šå…·ä½“å±æ€§ */
        }

        .webdav-modal-overlay.visible {
            opacity: 1;
            visibility: visible;
        }

        .webdav-browser {
            position: fixed;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%) scale(0.92);
            width: min(640px, 90vw);
            height: min(520px, 82vh);
            min-width: 400px;
            min-height: 300px;
            max-width: 90vw;
            max-height: 90vh;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-xl);
            background: var(--bg-secondary);
            backdrop-filter: var(--blur-sm); /* ä¼˜åŒ–ï¼šå‡å°‘blurå€¼ */
            -webkit-backdrop-filter: var(--blur-sm);
            display: flex;
            flex-direction: column;
            box-shadow: var(--shadow-xl), 0 0 0 1px rgba(0, 0, 0, 0.05);
            z-index: 10000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease, transform 0.3s ease; /* ä¼˜åŒ–ï¼šæŒ‡å®šå…·ä½“å±æ€§ */
            overflow: hidden;
        }

        .webdav-browser.visible {
            opacity: 1;
            visibility: visible;
            transform: translate(-50%, -50%) scale(1);
        }

        .webdav-browser.dragging {
            transition: none;
            user-select: none;
        }

        .webdav-browser.resizing {
            transition: none;
            user-select: none;
        }

        .webdav-browser-header {
            display: flex;
            align-items: center;
            gap: var(--space-md);
            padding: var(--space-md) var(--space-lg);
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-tertiary);
            border-radius: var(--radius-xl) var(--radius-xl) 0 0;
            cursor: move;
            flex-shrink: 0;
        }

        .webdav-browser-header:active {
            cursor: grabbing;
        }

        .webdav-browser-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin-right: auto;
        }

        .webdav-browser-close {
            width: 30px;
            height: 30px;
            border-radius: var(--radius-full);
            background: rgba(255, 59, 48, 0.1);
            border: none;
            color: #ff3b30;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: var(--transition);
            flex-shrink: 0;
        }

        .webdav-browser-close:hover {
            background: rgba(255, 59, 48, 0.2);
            transform: scale(1.1) rotate(90deg);
        }

        /* ==================== é¢åŒ…å±‘å¯¼èˆª ==================== */
        .webdav-breadcrumb-bar {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            padding: var(--space-sm) var(--space-lg);
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-tertiary);
            flex-shrink: 0;
            overflow-x: auto;
        }

        .webdav-breadcrumb {
            display: flex;
            align-items: center;
            gap: var(--space-xs);
            flex-wrap: nowrap;
            font-size: 14px;
            min-width: 0;
        }

        .webdav-breadcrumb-item {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 6px 12px;
            border-radius: var(--radius-sm);
            transition: var(--transition);
            white-space: nowrap;
            font-size: 14px;
            font-weight: 500;
        }

        .webdav-breadcrumb-item:hover {
            background: var(--accent-soft);
            color: var(--accent-color);
        }

        .webdav-breadcrumb-item.active {
            color: var(--text-primary);
            font-weight: 600;
            cursor: default;
            background: var(--bg-quaternary);
        }

        .webdav-breadcrumb-item.active:hover {
            background: var(--bg-quaternary);
            color: var(--text-primary);
        }

        .webdav-breadcrumb-separator {
            color: var(--text-secondary);
            font-size: 12px;
            opacity: 0.6;
        }

        .webdav-browser-content {
            flex: 1;
            overflow-y: auto;
            scrollbar-width: thin;
            min-height: 0;
            background: var(--bg-secondary);
        }

        /* æ¨¡æ€æ¡†ç¼©æ”¾æ‰‹æŸ„ */
        .webdav-resize-handle {
            position: absolute;
            z-index: 10;
        }

        .webdav-resize-handle-n {
            top: 0;
            left: 10px;
            right: 10px;
            height: 6px;
            cursor: n-resize;
        }

        .webdav-resize-handle-s {
            bottom: 0;
            left: 10px;
            right: 10px;
            height: 6px;
            cursor: s-resize;
        }

        .webdav-resize-handle-e {
            right: 0;
            top: 10px;
            bottom: 10px;
            width: 6px;
            cursor: e-resize;
        }

        .webdav-resize-handle-w {
            left: 0;
            top: 10px;
            bottom: 10px;
            width: 6px;
            cursor: w-resize;
        }

        .webdav-resize-handle-nw {
            top: 0;
            left: 0;
            width: 12px;
            height: 12px;
            cursor: nw-resize;
        }

        .webdav-resize-handle-ne {
            top: 0;
            right: 0;
            width: 12px;
            height: 12px;
            cursor: ne-resize;
        }

        .webdav-resize-handle-sw {
            bottom: 0;
            left: 0;
            width: 12px;
            height: 12px;
            cursor: sw-resize;
        }

        .webdav-resize-handle-se {
            bottom: 0;
            right: 0;
            width: 12px;
            height: 12px;
            cursor: se-resize;
        }

        /* ç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 768px) {
            .webdav-browser {
                width: 95vw;
                height: 85vh;
                min-width: unset;
                min-height: unset;
                border-radius: var(--radius-md);
            }

            .webdav-browser-header {
                padding: 12px 16px;
            }

            .webdav-breadcrumb-bar {
                padding: 10px 16px;
            }

            .webdav-resize-handle {
                display: none;
            }
        }

        /* ==================== åŠ è½½å’Œç©ºçŠ¶æ€ ==================== */
        .webdav-browser-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: var(--space-2xl) var(--space-lg);
            color: var(--text-secondary);
            gap: var(--space-md);
            font-size: 15px;
        }

        .webdav-browser-loading .spinner {
            width: 32px;
            height: 32px;
            border: 3px solid var(--border-color);
            border-top-color: var(--accent-color);
        }

        .webdav-browser-empty {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: var(--space-2xl) var(--space-lg);
            color: var(--text-secondary);
            gap: var(--space-md);
            font-size: 15px;
        }

        .webdav-browser-empty-icon {
            font-size: 56px;
            opacity: 0.4;
        }

        /* ==================== æ–‡ä»¶åˆ—è¡¨ ==================== */
        .webdav-file-list {
            list-style: none;
        }

        .webdav-file-item {
            display: flex;
            align-items: center;
            gap: var(--space-md);
            padding: var(--space-md) var(--space-lg);
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: var(--transition);
            position: relative;
        }

        .webdav-file-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background: var(--accent-gradient);
            opacity: 0;
            transition: var(--transition);
        }

        .webdav-file-item:last-child {
            border-bottom: none;
        }

        .webdav-file-item:hover {
            background: var(--accent-soft);
        }

        .webdav-file-item:hover::before {
            opacity: 1;
        }

        .webdav-file-item.selected {
            background: var(--accent-soft);
        }

        .webdav-file-item.selected::before {
            opacity: 1;
        }

        .webdav-file-icon {
            font-size: 30px;
            flex-shrink: 0;
        }

        .webdav-file-info {
            flex: 1;
            min-width: 0;
        }

        .webdav-file-name {
            font-size: 15px;
            font-weight: 550;
            color: var(--text-primary);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            line-height: 1.4;
        }

        .webdav-file-meta {
            font-size: 13px;
            color: var(--text-secondary);
            margin-top: 3px;
        }

        .webdav-file-arrow {
            color: var(--text-secondary);
            font-size: 20px;
            flex-shrink: 0;
            transition: var(--transition);
        }

        .webdav-file-item:hover .webdav-file-arrow {
            color: var(--accent-color);
            transform: translateX(3px);
        }

        .webdav-btn-browse {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1.5px solid var(--border-color-strong);
            font-weight: 600;
        }

        .webdav-btn-browse:hover {
            background: var(--bg-secondary);
            border-color: var(--accent-color);
            transform: translateY(-1px);
        }

        .webdav-file-path-row {
            display: flex;
            gap: var(--space-sm);
            align-items: flex-end;
        }

        .webdav-file-path-row .webdav-form-group {
            flex: 1;
            margin-bottom: 0;
        }

        .webdav-file-path-row .webdav-btn-browse {
            height: 45px;
            padding: 0 var(--space-md);
            font-size: 14px;
            font-weight: 600;
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 6px;
            white-space: nowrap;
        }

        /* ==================== å¹¿å‘Šå…³é”®è¯è¿‡æ»¤æ ‡ç­¾æ ·å¼ ==================== */
        .ad-keyword-tag-list .tag-item {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a5a 100%);
            box-shadow: 0 2px 8px rgba(255, 107, 107, 0.3);
        }

        .ad-keyword-tag-list .tag-item:hover {
            box-shadow: 0 4px 12px rgba(255, 107, 107, 0.4);
        }

        /* ==================== å¢é‡æ›´æ–°ç»Ÿè®¡æ ·å¼ ==================== */
        .incremental-stats {
            margin-bottom: var(--space-lg);
            padding: var(--space-md);
            background: var(--bg-tertiary);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-color);
        }

        .incremental-stats-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--space-md);
        }

        .incremental-stats-title {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .incremental-stats-clear {
            padding: 6px 12px;
            font-size: 12px;
            background: rgba(255, 59, 48, 0.1);
            color: #ff3b30;
            border: none;
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: var(--transition);
        }

        .incremental-stats-clear:hover {
            background: rgba(255, 59, 48, 0.2);
        }

        .incremental-stats-items {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--space-md);
        }

        .incremental-stat-item {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            padding: var(--space-md);
            border-radius: var(--radius-md);
            background: var(--bg-secondary);
        }

        .incremental-stat-icon {
            font-size: 20px;
        }

        .incremental-stat-value {
            font-size: 24px;
            font-weight: 700;
        }

        .incremental-stat-label {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .incremental-stat-new {
            border-left: 3px solid #34c759;
        }

        .incremental-stat-new .incremental-stat-value {
            color: #34c759;
        }

        .incremental-stat-deleted {
            border-left: 3px solid #ff3b30;
        }

        .incremental-stat-deleted .incremental-stat-value {
            color: #ff3b30;
        }

        .incremental-stat-unchanged {
            border-left: 3px solid #8e8e93;
        }

        .incremental-stat-unchanged .incremental-stat-value {
            color: var(--text-secondary);
        }

        @media (max-width: 768px) {
            .incremental-stats-items {
                grid-template-columns: 1fr;
            }
        }

        /* ==================== ç›®å½•ç»“æ„é¢„è§ˆæ ·å¼ ==================== */
        .directory-preview {
            margin-top: var(--space-lg);
        }

        .directory-preview-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--space-md);
            flex-wrap: wrap;
            gap: var(--space-sm);
        }

        .directory-preview-title {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .directory-preview-actions {
            display: flex;
            gap: var(--space-sm);
            flex-wrap: wrap;
        }

        .directory-preview-btn {
            padding: 6px 12px;
            font-size: 12px;
            background: var(--bg-tertiary);
            color: var(--text-tertiary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .directory-preview-btn:hover {
            background: var(--accent-soft);
            border-color: var(--accent-color);
            color: var(--accent-color);
        }

        .directory-tree-container {
            max-height: 400px;
            overflow-y: auto;
            border-radius: var(--radius-lg);
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            padding: var(--space-md);
        }

        .directory-preview-footer {
            display: flex;
            gap: var(--space-lg);
            margin-top: var(--space-md);
            padding: var(--space-md);
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
            font-size: 13px;
            color: var(--text-secondary);
            flex-wrap: wrap;
        }

        /* ==================== æ ‘å½¢èŠ‚ç‚¹æ ·å¼ ==================== */
        .tree-item {
            user-select: none;
        }

        .tree-item-header {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            padding: 6px 8px;
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: var(--transition);
        }

        .tree-item-header:hover {
            background: var(--accent-soft);
        }

        .tree-item-toggle {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: var(--text-secondary);
            transition: transform 0.2s ease;
            flex-shrink: 0;
        }

        .tree-item-toggle.expanded {
            transform: rotate(90deg);
        }

        .tree-item-toggle.hidden {
            visibility: hidden;
        }

        .tree-item-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: var(--accent-color);
            flex-shrink: 0;
        }

        .tree-item-icon {
            font-size: 18px;
            flex-shrink: 0;
        }

        .tree-item-name {
            flex: 1;
            font-size: 14px;
            color: var(--text-primary);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .tree-item-name.folder {
            font-weight: 550;
            color: var(--accent-color);
        }

        .tree-item-name.excluded {
            color: var(--text-secondary);
            text-decoration: line-through;
        }

        .tree-item-count {
            font-size: 12px;
            color: var(--text-secondary);
            background: var(--bg-quaternary);
            padding: 2px 8px;
            border-radius: var(--radius-full);
            flex-shrink: 0;
        }

        .tree-item-status {
            font-size: 11px;
            padding: 2px 6px;
            border-radius: var(--radius-full);
            font-weight: 500;
            flex-shrink: 0;
        }

        .tree-item-status.new {
            background: rgba(52, 199, 89, 0.15);
            color: #34c759;
        }

        .tree-item-status.deleted {
            background: rgba(255, 59, 48, 0.15);
            color: #ff3b30;
        }

        .tree-item-status.filtered {
            background: rgba(255, 149, 0, 0.15);
            color: #ff9500;
        }

        .tree-item-children {
            margin-left: 24px;
            display: none;
        }

        .tree-item-children.expanded {
            display: block;
        }

        /* ==================== ä¸‹è½½æŒ‰é’®ç»„æ ·å¼ ==================== */
        .download-btn-group {
            flex-wrap: wrap;
        }

        .btn-badge {
            background: rgba(255, 255, 255, 0.25);
            padding: 2px 8px;
            border-radius: var(--radius-full);
            font-size: 12px;
            font-weight: 600;
            margin-left: 4px;
        }

        .btn-new-only {
            background: linear-gradient(135deg, #34c759 0%, #30d158 100%);
            box-shadow: var(--shadow-sm), 0 4px 14px rgba(52, 199, 89, 0.3);
        }

        .btn-new-only:hover {
            box-shadow: var(--shadow-md), 0 8px 25px rgba(52, 199, 89, 0.4);
        }

        @media (max-width: 768px) {
            .directory-preview-actions {
                width: 100%;
                justify-content: flex-start;
            }
            
            .tree-item-children {
                margin-left: 16px;
            }
        }

        /* ==================== Tab ç³»ç»Ÿæ ·å¼ ==================== */
        .tab-container {
            margin-bottom: var(--space-lg);
        }

        .tab-nav {
            display: flex;
            gap: var(--space-sm);
            padding: var(--space-md);
            background: var(--bg-secondary);
            backdrop-filter: var(--blur-md);
            -webkit-backdrop-filter: var(--blur-md);
            border-radius: var(--radius-xl);
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-md);
            margin-bottom: var(--space-lg);
        }

        .tab-btn {
            flex: 1;
            padding: var(--space-md) var(--space-lg);
            font-size: 15px;
            font-weight: 600;
            border: none;
            border-radius: var(--radius-lg);
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-sm);
            position: relative;
            overflow: hidden;
        }

        .tab-btn::before {
            content: '';
            position: absolute;
            inset: 0;
            background: var(--accent-gradient);
            opacity: 0;
            transition: var(--transition);
            border-radius: var(--radius-lg);
        }

        .tab-btn:hover {
            color: var(--text-primary);
            background: var(--bg-tertiary);
        }

        .tab-btn.active {
            color: white;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .tab-btn.active::before {
            opacity: 1;
        }

        .tab-btn-icon {
            font-size: 18px;
            position: relative;
            z-index: 1;
        }

        .tab-btn-text {
            position: relative;
            z-index: 1;
        }

        .tab-content {
            display: none;
            animation: fadeInUp 0.3s ease forwards;
        }

        .tab-content.active {
            display: block;
        }

        @media (max-width: 768px) {
            .tab-nav {
                padding: var(--space-sm);
                gap: var(--space-xs);
            }

            .tab-btn {
                padding: var(--space-sm) var(--space-md);
                font-size: 14px;
                flex-direction: column;
                gap: var(--space-xs);
            }

            .tab-btn-icon {
                font-size: 20px;
            }
        }

        /* ==================== åˆ®å‰Šæ£€æµ‹ç›¸å…³æ ·å¼ ==================== */
        .scrape-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: var(--space-md);
            margin-bottom: var(--space-lg);
        }

        .scrape-stat-item {
            background: var(--bg-tertiary);
            padding: var(--space-lg);
            border-radius: var(--radius-lg);
            text-align: center;
            border: 1px solid var(--border-color);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .scrape-stat-item::before {
            content: '';
            position: absolute;
            inset: 0;
            background: var(--accent-gradient);
            opacity: 0;
            transition: var(--transition);
        }

        .scrape-stat-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .scrape-stat-item:hover::before {
            opacity: 0.05;
        }

        .scrape-stat-item.success {
            border-left: 4px solid #34c759;
        }

        .scrape-stat-item.warning {
            border-left: 4px solid #ff9500;
        }

        .scrape-stat-item.info {
            border-left: 4px solid var(--accent-color);
        }

        .scrape-stat-value {
            font-size: 36px;
            font-weight: 800;
            position: relative;
            z-index: 1;
        }

        .scrape-stat-item.success .scrape-stat-value {
            color: #34c759;
        }

        .scrape-stat-item.warning .scrape-stat-value {
            color: #ff9500;
        }

        .scrape-stat-item.info .scrape-stat-value {
            background: var(--accent-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .scrape-stat-label {
            font-size: 13px;
            color: var(--text-secondary);
            margin-top: var(--space-xs);
            font-weight: 500;
            letter-spacing: 0.02em;
            position: relative;
            z-index: 1;
        }

        .scrape-progress-bar {
            width: 100%;
            height: 8px;
            background: var(--bg-tertiary);
            border-radius: var(--radius-full);
            overflow: hidden;
            margin-top: var(--space-md);
            border: 1px solid var(--border-color);
        }

        .scrape-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #34c759 0%, #30d158 100%);
            border-radius: var(--radius-full);
            transition: width 0.5s ease;
        }

        .scrape-progress-text {
            text-align: center;
            margin-top: var(--space-sm);
            font-size: 14px;
            font-weight: 600;
            color: var(--text-tertiary);
        }

        .unscraped-list-container {
            max-height: 400px;
            overflow-y: auto;
            border-radius: var(--radius-lg);
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
        }

        .unscraped-list {
            list-style: none;
        }

        .unscraped-item {
            padding: var(--space-md) var(--space-lg);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            flex-wrap: wrap;
            align-items: flex-start;
            gap: var(--space-sm);
            transition: var(--transition);
        }

        .unscraped-item:last-child {
            border-bottom: none;
        }

        .unscraped-item:hover {
            background: var(--accent-soft);
        }

        .unscraped-item-icon {
            font-size: 20px;
            flex-shrink: 0;
        }

        .unscraped-item-path {
            flex: 1;
            min-width: 0;
            font-family: 'SF Mono', 'Fira Code', Menlo, Monaco, monospace;
            font-size: 13px;
            color: var(--text-tertiary);
            word-break: break-all;
            white-space: normal;
            line-height: 1.5;
            overflow-wrap: break-word;
        }

        /* ç¼ºå¤±æ ‡ç­¾æ ·å¼ */
        .missing-tags {
            display: flex;
            gap: 6px;
            flex-shrink: 0;
        }

        .missing-tag {
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 4px;
            white-space: nowrap;
            font-weight: 500;
        }

        .missing-nfo {
            background: rgba(239, 68, 68, 0.15);
            color: #ef4444;
        }

        .missing-image {
            background: rgba(245, 158, 11, 0.15);
            color: #f59e0b;
        }

        [data-theme="dark"] .missing-nfo {
            background: rgba(239, 68, 68, 0.25);
            color: #f87171;
        }

        [data-theme="dark"] .missing-image {
            background: rgba(245, 158, 11, 0.25);
            color: #fbbf24;
        }

        .unscraped-search-container {
            display: flex;
            gap: var(--space-md);
            margin-bottom: var(--space-md);
        }

        .unscraped-search-input {
            flex: 1;
            padding: 12px 16px;
            font-size: 14px;
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            background: var(--bg-tertiary);
            color: var(--text-primary);
            transition: var(--transition);
            font-family: inherit;
        }

        .unscraped-search-input:hover {
            border-color: var(--border-color-strong);
        }

        .unscraped-search-input:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 4px var(--accent-soft);
            background: var(--bg-secondary);
        }

        .unscraped-count {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: var(--space-sm);
        }

        .unscraped-actions {
            display: flex;
            gap: var(--space-md);
            margin-top: var(--space-lg);
            flex-wrap: wrap;
        }

        /* åˆ®å‰Šæ ‡è¯†æ ‡ç­¾æ ·å¼ */
        .scrape-indicator-tag-list .tag-item {
            background: linear-gradient(135deg, #34c759 0%, #30d158 100%);
            box-shadow: 0 2px 8px rgba(52, 199, 89, 0.3);
        }

        .scrape-indicator-tag-list .tag-item:hover {
            box-shadow: 0 4px 12px rgba(52, 199, 89, 0.4);
        }

        /* ==================== åˆ®å‰Šæ£€æµ‹å¯¼å…¥æ¨¡å¼æ ·å¼ ==================== */
        .scrape-import-modes {
            display: flex;
            flex-direction: column;
            gap: var(--space-lg);
        }

        .scrape-import-option {
            width: 100%;
        }

        .scrape-import-btn-group {
            text-align: center;
        }

        .scrape-folder-btn {
            width: 100%;
            max-width: 300px;
            padding: 18px 32px;
            font-size: 16px;
        }

        .scrape-folder-btn span:first-child {
            font-size: 20px;
        }

        .scrape-import-hint {
            margin-top: var(--space-md);
            font-size: 13px;
            color: var(--text-secondary);
        }

        .scrape-import-divider {
            display: flex;
            align-items: center;
            gap: var(--space-md);
            color: var(--text-secondary);
            font-size: 13px;
        }

        .scrape-import-divider::before,
        .scrape-import-divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: var(--border-color);
        }

        /* æ‰«æè¿›åº¦æ ·å¼ */
        .scrape-scan-progress {
            padding: var(--space-lg);
            background: var(--bg-tertiary);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-color);
            margin-top: var(--space-md);
        }

        .scrape-scan-status {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-md);
            margin-bottom: var(--space-md);
            font-size: 15px;
            font-weight: 550;
            color: var(--text-primary);
        }

        .scrape-scan-status .spinner {
            width: 24px;
            height: 24px;
            border: 3px solid var(--border-color);
            border-top-color: var(--accent-color);
        }

        .scrape-scan-stats {
            display: flex;
            justify-content: center;
            gap: var(--space-xl);
            font-size: 14px;
            color: var(--text-secondary);
        }

        .scrape-scan-stats strong {
            color: var(--accent-color);
            font-weight: 600;
        }

        /* æµè§ˆå™¨ä¸æ”¯æŒæç¤º */
        .browser-not-supported-hint {
            padding: var(--space-md);
            background: linear-gradient(135deg, rgba(255, 149, 0, 0.1) 0%, rgba(255, 149, 0, 0.05) 100%);
            border: 1px solid rgba(255, 149, 0, 0.2);
            border-radius: var(--radius-md);
            font-size: 13px;
            color: var(--text-tertiary);
            margin-bottom: var(--space-md);
        }

        .browser-not-supported-hint strong {
            color: #ff9500;
        }

        @media (max-width: 768px) {
            .scrape-folder-btn {
                max-width: 100%;
            }

            .scrape-scan-stats {
                flex-direction: column;
                gap: var(--space-sm);
                align-items: center;
            }
        }

        /* ==================== STRM æ–‡ä»¶å¤åˆ¶åŠŸèƒ½æ ·å¼ ==================== */
        .scrape-copy-section {
            margin-top: var(--space-xl);
            padding-top: var(--space-lg);
            border-top: 1px solid var(--border-color);
        }

        .scrape-copy-divider {
            display: flex;
            align-items: center;
            gap: var(--space-md);
            margin-bottom: var(--space-md);
            font-size: 15px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .scrape-copy-divider::before,
        .scrape-copy-divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: var(--border-color);
        }

        .scrape-copy-hint {
            padding: var(--space-md);
            background: linear-gradient(135deg, rgba(0, 122, 255, 0.08) 0%, rgba(0, 122, 255, 0.04) 100%);
            border: 1px solid rgba(0, 122, 255, 0.15);
            border-radius: var(--radius-md);
            margin-bottom: var(--space-md);
        }

        .scrape-copy-hint p {
            font-size: 13px;
            color: var(--text-tertiary);
            line-height: 1.5;
            margin: 0;
        }

        .scrape-copy-actions {
            display: flex;
            gap: var(--space-md);
            flex-wrap: wrap;
        }

        .scrape-copy-progress {
            margin-top: var(--space-md);
            padding: var(--space-lg);
            background: var(--bg-tertiary);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-color);
        }

        .scrape-copy-progress-status {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-md);
            margin-bottom: var(--space-md);
            font-size: 15px;
            font-weight: 550;
            color: var(--text-primary);
        }

        .scrape-copy-progress-status .spinner {
            width: 24px;
            height: 24px;
            border: 3px solid var(--border-color);
            border-top-color: var(--accent-color);
        }

        .scrape-copy-progress-stats {
            text-align: center;
            margin-top: var(--space-md);
            font-size: 14px;
            color: var(--text-secondary);
        }

        .scrape-copy-progress-stats strong {
            color: var(--accent-color);
            font-weight: 600;
        }

        .scrape-copy-result {
            margin-top: var(--space-md);
            padding: var(--space-md);
            border-radius: var(--radius-md);
        }

        .scrape-copy-result-success {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-sm);
            padding: var(--space-md);
            background: linear-gradient(135deg, rgba(52, 199, 89, 0.12) 0%, rgba(52, 199, 89, 0.06) 100%);
            border: 1px solid rgba(52, 199, 89, 0.25);
            border-radius: var(--radius-md);
            color: #34c759;
            font-weight: 600;
        }

        .scrape-copy-result-icon {
            font-size: 20px;
        }

        .browser-not-supported-warning {
            padding: var(--space-md);
            background: linear-gradient(135deg, rgba(255, 149, 0, 0.1) 0%, rgba(255, 149, 0, 0.05) 100%);
            border: 1px solid rgba(255, 149, 0, 0.2);
            border-radius: var(--radius-md);
            font-size: 13px;
            color: var(--text-tertiary);
            margin-top: var(--space-md);
            text-align: center;
        }

        .browser-not-supported-warning strong {
            color: #ff9500;
        }

        /* ==================== æ”¹è¿›çš„å¤åˆ¶ç»“æœæ˜¾ç¤ºæ ·å¼ ==================== */
        .copy-result-summary {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-sm);
            padding: var(--space-md);
            background: linear-gradient(135deg, rgba(52, 199, 89, 0.12) 0%, rgba(52, 199, 89, 0.06) 100%);
            border: 1px solid rgba(52, 199, 89, 0.25);
            border-radius: var(--radius-md);
            color: #34c759;
            font-weight: 600;
            margin-bottom: var(--space-md);
        }

        .copy-result-summary.has-errors {
            background: linear-gradient(135deg, rgba(255, 149, 0, 0.12) 0%, rgba(255, 149, 0, 0.06) 100%);
            border: 1px solid rgba(255, 149, 0, 0.25);
            color: #ff9500;
        }

        .copy-failed-section {
            margin-bottom: var(--space-md);
        }

        .copy-failed-section h4 {
            font-size: 14px;
            font-weight: 600;
            color: #ef4444;
            margin-bottom: var(--space-sm);
        }

        .failed-list {
            list-style: none;
            color: #ef4444;
            background: rgba(239, 68, 68, 0.1);
            padding: var(--space-md);
            border-radius: var(--radius-md);
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        .failed-list li {
            padding: var(--space-xs) 0;
            font-size: 13px;
            font-family: 'SF Mono', 'Fira Code', Menlo, Monaco, monospace;
            border-bottom: 1px solid rgba(239, 68, 68, 0.1);
            word-break: break-all;
        }

        .failed-list li:last-child {
            border-bottom: none;
        }

        .failed-list .error-reason {
            color: #f87171;
            font-style: italic;
            margin-left: var(--space-sm);
        }

        .copy-success-section {
            margin-top: var(--space-md);
        }

        .copy-success-section summary {
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            color: #22c55e;
            padding: var(--space-sm);
            background: rgba(34, 197, 94, 0.1);
            border-radius: var(--radius-sm);
            user-select: none;
        }

        .copy-success-section summary:hover {
            background: rgba(34, 197, 94, 0.15);
        }

        .success-list {
            list-style: none;
            color: #22c55e;
            padding: var(--space-md);
            max-height: 200px;
            overflow-y: auto;
            background: rgba(34, 197, 94, 0.05);
            border-radius: 0 0 var(--radius-md) var(--radius-md);
            margin-top: 0;
        }

        .success-list li {
            padding: var(--space-xs) 0;
            font-size: 13px;
            font-family: 'SF Mono', 'Fira Code', Menlo, Monaco, monospace;
            border-bottom: 1px solid rgba(34, 197, 94, 0.1);
            word-break: break-all;
        }

        .success-list li:last-child {
            border-bottom: none;
        }

        [data-theme="dark"] .copy-result-summary {
            background: linear-gradient(135deg, rgba(52, 199, 89, 0.2) 0%, rgba(52, 199, 89, 0.1) 100%);
        }

        [data-theme="dark"] .copy-result-summary.has-errors {
            background: linear-gradient(135deg, rgba(255, 149, 0, 0.2) 0%, rgba(255, 149, 0, 0.1) 100%);
        }

        [data-theme="dark"] .failed-list {
            background: rgba(239, 68, 68, 0.15);
        }

        [data-theme="dark"] .success-list {
            background: rgba(34, 197, 94, 0.1);
        }

        /* ==================== ç›®å½•é€‰æ‹©å™¨æ ·å¼ ==================== */
        .directory-selector-group {
            display: flex;
            flex-direction: column;
            gap: var(--space-md);
            margin-bottom: var(--space-lg);
        }

        .directory-selector {
            display: flex;
            align-items: center;
            gap: var(--space-md);
            padding: var(--space-md);
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
            border: 1px solid var(--border-color);
        }

        .directory-selector-label {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            min-width: 80px;
        }

        .directory-selector-name {
            flex: 1;
            font-size: 14px;
            color: var(--text-secondary);
            font-family: 'SF Mono', 'Fira Code', Menlo, Monaco, monospace;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .directory-selector-name.selected {
            color: var(--accent-color);
            font-weight: 500;
        }

        .directory-selector-btn {
            padding: 8px 16px;
            font-size: 13px;
            font-weight: 600;
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: var(--transition);
            border: 1.5px solid var(--border-color-strong);
            background: var(--bg-secondary);
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 6px;
            white-space: nowrap;
        }

        .directory-selector-btn:hover {
            background: var(--accent-soft);
            border-color: var(--accent-color);
            color: var(--accent-color);
        }

        .directory-selector-btn.selected {
            background: rgba(52, 199, 89, 0.1);
            border-color: #34c759;
            color: #34c759;
        }

        .start-copy-btn {
            width: 100%;
            padding: 14px 28px;
            font-size: 15px;
        }

        .start-copy-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        @media (max-width: 768px) {
            .directory-selector {
                flex-direction: column;
                align-items: stretch;
                gap: var(--space-sm);
            }

            .directory-selector-label {
                min-width: auto;
            }

            .directory-selector-btn {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <button class="theme-toggle" onclick="toggleTheme()" title="åˆ‡æ¢ä¸»é¢˜">
        <span id="themeIcon">ğŸŒ™</span>
    </button>

    <div class="container">
        <header>
            <div class="logo">ğŸ“º</div>
            <h1>STRM æ–‡ä»¶ç”Ÿæˆå™¨</h1>
            <p class="subtitle">å¯è§†åŒ–URLæ‹¼æ¥ä¸STRMæ–‡ä»¶æ‰¹é‡ç”Ÿæˆå·¥å…·</p>
        </header>

        <!-- Tab å¯¼èˆª -->
        <div class="tab-container">
            <div class="tab-nav">
                <button class="tab-btn active" onclick="switchTab('tab-main')" data-tab="tab-main">
                    <span class="tab-btn-icon">ğŸ“„</span>
                    <span class="tab-btn-text">STRMç”Ÿæˆ</span>
                </button>
                <button class="tab-btn" onclick="switchTab('tab-scrape')" data-tab="tab-scrape">
                    <span class="tab-btn-icon">ğŸ”</span>
                    <span class="tab-btn-text">åˆ®å‰Šæ£€æµ‹</span>
                </button>
            </div>
        </div>

        <!-- ä¸»æ ‡ç­¾é¡µï¼šSTRMç”Ÿæˆ -->
        <div class="tab-content active" id="tab-main">

        <!-- æ–‡ä»¶å¯¼å…¥æ¨¡å— -->
        <div class="card">
            <div class="card-header">
                <div class="card-icon">ğŸ“‚</div>
                <h2 class="card-title">å¯¼å…¥ç›®å½•æ ‘æ–‡ä»¶</h2>
            </div>
            <div class="drop-zone" id="dropZone">
                <div class="drop-zone-icon">ğŸ“„</div>
                <p class="drop-zone-text">æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„ï¼Œæˆ–ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</p>
                <p class="drop-zone-hint">æ”¯æŒ .txt æ ¼å¼ï¼Œè‡ªåŠ¨è¯†åˆ« UTF-16 LE ç¼–ç </p>
            </div>
            <input type="file" class="file-input" id="fileInput" accept=".txt">
            <div class="file-info" id="fileInfo">
                <span class="file-info-icon">ğŸ“„</span>
                <div class="file-info-details">
                    <div class="file-info-name" id="fileName">-</div>
                    <div class="file-info-size" id="fileSize">-</div>
                </div>
                <button class="file-info-remove" onclick="removeFile()" title="ç§»é™¤æ–‡ä»¶">âœ•</button>
            </div>

            <!-- WebDAV è¿æ¥é¢æ¿ -->
            <div class="collapsible-panel" id="webdavPanel">
                <div class="collapsible-header" onclick="toggleWebdavPanel()">
                    <span class="collapsible-icon">â–¶</span>
                    <span class="collapsible-title">é€šè¿‡ WebDAV è·å–æ–‡ä»¶</span>
                    <span class="collapsible-status" id="webdavStatus">æœªè¿æ¥</span>
                </div>
                <div class="collapsible-content">
                    <div class="collapsible-body">
                        <div class="webdav-form-group">
                            <label class="webdav-label">WebDAV æœåŠ¡å™¨ URL</label>
                            <input type="text" class="webdav-input" id="webdavUrl" placeholder="ä¾‹å¦‚ï¼šhttps://example.com/dav/">
                        </div>
                        <div class="webdav-row">
                            <div class="webdav-form-group">
                                <label class="webdav-label">ç”¨æˆ·å</label>
                                <input type="text" class="webdav-input" id="webdavUser" placeholder="è¾“å…¥ç”¨æˆ·å">
                            </div>
                            <div class="webdav-form-group">
                                <label class="webdav-label">å¯†ç </label>
                                <input type="password" class="webdav-input" id="webdavPass" placeholder="è¾“å…¥å¯†ç ">
                                <label class="remember-password-label">
                                    <input type="checkbox" id="rememberPassword">
                                    <span>è®°ä½å¯†ç </span>
                                </label>
                            </div>
                        </div>
                        <div class="webdav-form-group">
                            <label class="webdav-label">txt æ–‡ä»¶è·¯å¾„</label>
                            <div class="webdav-file-path-row">
                                <div class="webdav-form-group">
                                    <input type="text" class="webdav-input" id="webdavFilePath" placeholder="ä¾‹å¦‚ï¼š/media/ç›®å½•æ ‘.txt">
                                </div>
                                <button class="webdav-btn webdav-btn-browse" onclick="openWebdavBrowser()">
                                    ğŸ“‚ æµè§ˆ
                                </button>
                            </div>
                        </div>
                        <div class="webdav-btn-group">
                            <button class="webdav-btn webdav-btn-connect" id="webdavConnectBtn" onclick="fetchFromWebdav()">
                                <span id="webdavBtnText">è¿æ¥å¹¶è·å–</span>
                            </button>
                            <button class="webdav-btn webdav-btn-save" onclick="saveWebdavConfig()">
                                ğŸ’¾ ä¿å­˜é…ç½®
                            </button>
                        </div>
                        <div class="webdav-message" id="webdavMessage"></div>
                        <div class="webdav-cors-hint">
                            <strong>âš ï¸ æç¤ºï¼š</strong> ç”±äºæµè§ˆå™¨å®‰å…¨é™åˆ¶ï¼ˆCORSï¼‰ï¼ŒWebDAV æœåŠ¡å™¨éœ€è¦é…ç½®å…è®¸è·¨åŸŸè®¿é—®ï¼Œæˆ–è€…æ‚¨å¯ä»¥ä½¿ç”¨æµè§ˆå™¨æ‰©å±•ï¼ˆå¦‚ CORS Unblockï¼‰ä¸´æ—¶ç»•è¿‡æ­¤é™åˆ¶ã€‚
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ–‡ä»¶åç¼€åè¿‡æ»¤æ¨¡å— -->
        <div class="card">
            <div class="card-header">
                <div class="card-icon">ğŸ·ï¸</div>
                <h2 class="card-title">æ–‡ä»¶åç¼€åè¿‡æ»¤</h2>
            </div>
            <p style="color: var(--text-secondary); margin-bottom: 16px; font-size: 14px;">
                åªæœ‰åŒ¹é…ä»¥ä¸‹åç¼€åçš„æ–‡ä»¶æ‰ä¼šç”Ÿæˆ STRM æ–‡ä»¶
            </p>
            <div class="tag-input-container">
                <div class="tag-list" id="extensionTagList">
                    <!-- æ ‡ç­¾å°†ç”± JavaScript åŠ¨æ€ç”Ÿæˆ -->
                </div>
                <div class="tag-input-row">
                    <input type="text" class="tag-input" id="extensionInput" placeholder="è¾“å…¥åç¼€åï¼ˆå¦‚ï¼šisoï¼‰" onkeypress="handleExtensionKeypress(event)">
                    <button class="tag-btn tag-btn-add" onclick="addExtension()">æ·»åŠ </button>
                    <button class="tag-btn tag-btn-reset" onclick="resetExtensions()">é‡ç½®ä¸ºé»˜è®¤</button>
                    </div>
                    <p class="tag-hint">ğŸ’¡ è¾“å…¥åç¼€ååæŒ‰ Enter æˆ–ç‚¹å‡»"æ·»åŠ "æŒ‰é’®ã€‚æ— éœ€è¾“å…¥ç‚¹å·ï¼ˆ.ï¼‰</p>
                </div>
            </div>
    
            <!-- å¹¿å‘Šå…³é”®è¯è¿‡æ»¤æ¨¡å— -->
            <div class="card">
                <div class="card-header">
                    <div class="card-icon">ğŸš«</div>
                    <h2 class="card-title">å¹¿å‘Šå…³é”®è¯è¿‡æ»¤</h2>
                </div>
                <p style="color: var(--text-secondary); margin-bottom: 16px; font-size: 14px;">
                    æ–‡ä»¶åæˆ–æ–‡ä»¶å¤¹ååŒ…å«ä»¥ä¸‹å…³é”®è¯æ—¶ï¼Œå°†ä¸ä¼šç”Ÿæˆ STRM æ–‡ä»¶ï¼ˆå¤§å°å†™ä¸æ•æ„Ÿï¼‰
                </p>
                <div class="tag-input-container">
                    <div class="tag-list ad-keyword-tag-list" id="adKeywordTagList">
                        <!-- æ ‡ç­¾å°†ç”± JavaScript åŠ¨æ€ç”Ÿæˆ -->
                    </div>
                    <div class="tag-input-row">
                        <input type="text" class="tag-input" id="adKeywordInput" placeholder="è¾“å…¥å¹¿å‘Šå…³é”®è¯" onkeypress="handleAdKeywordKeypress(event)">
                        <button class="tag-btn tag-btn-add" onclick="addAdKeyword()">æ·»åŠ </button>
                        <button class="tag-btn tag-btn-reset" onclick="resetAdKeywords()">é‡ç½®ä¸ºé»˜è®¤</button>
                    </div>
                    <p class="tag-hint">ğŸ’¡ è¾“å…¥å…³é”®è¯åæŒ‰ Enter æˆ–ç‚¹å‡»"æ·»åŠ "æŒ‰é’®ã€‚åŒ¹é…æ—¶ä¸åŒºåˆ†å¤§å°å†™</p>
                </div>
                <div class="toggle-group" style="margin-top: 16px;">
                    <div>
                        <div class="toggle-label">å¯ç”¨å¹¿å‘Šè¿‡æ»¤</div>
                        <div class="toggle-hint">å…³é—­åå°†ä¸ä¼šè¿‡æ»¤ä»»ä½•æ–‡ä»¶</div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="adFilterToggle" checked>
                        <span class="toggle-slider"></span>
                    </label>
                    <span class="toggle-status active" id="adFilterStatus">å¼€å¯</span>
                </div>
            </div>
    
            <!-- URLå‰ç¼€è¾“å…¥æ¨¡å— -->
        <div class="card">
            <div class="card-header">
                <div class="card-icon">ğŸ”—</div>
                <h2 class="card-title">URL å‰ç¼€è®¾ç½®</h2>
            </div>
            <div class="input-wrapper">
                <label class="input-label">è¾“å…¥åª’ä½“æœåŠ¡å™¨çš„åŸºç¡€ URL</label>
                <input type="text" class="text-input" id="urlPrefix" placeholder="ä¾‹å¦‚ï¼šhttp://example.com/media/">
            </div>
            <div class="toggle-group">
                <div>
                    <div class="toggle-label">URL ç¼–ç </div>
                    <div class="toggle-hint">å¯¹è·¯å¾„ä¸­çš„ç‰¹æ®Šå­—ç¬¦è¿›è¡Œ encodeURIComponent ç¼–ç </div>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="urlEncodeToggle" checked>
                    <span class="toggle-slider"></span>
                </label>
                <span class="toggle-status active" id="toggleStatus">å¼€å¯</span>
            </div>
        </div>

        <!-- è§£æç»“æœæ¨¡å— -->
        <div class="card" id="parseResultCard" style="display: none;">
            <div class="card-header">
                <div class="card-icon">ğŸ“Š</div>
                <h2 class="card-title">è§£æç»“æœ</h2>
            </div>
            <div class="stats">
                <div class="stat-item">
                    <div class="stat-value" id="statFolders">0</div>
                    <div class="stat-label">æ–‡ä»¶å¤¹</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="statFiles">0</div>
                    <div class="stat-label">åª’ä½“æ–‡ä»¶</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="statDepth">0</div>
                    <div class="stat-label">æœ€å¤§å±‚çº§</div>
                </div>
                <div class="stat-item" id="statFilteredContainer" style="display: none;">
                    <div class="stat-value" id="statFiltered">0</div>
                    <div class="stat-label">å·²è¿‡æ»¤</div>
                </div>
            </div>
            <!-- å¢é‡æ›´æ–°ç»Ÿè®¡ -->
            <div class="incremental-stats" id="incrementalStats" style="display: none;">
                <div class="incremental-stats-header">
                    <span class="incremental-stats-title">ğŸ“ˆ å¢é‡å¯¹æ¯”</span>
                    <button class="incremental-stats-clear" onclick="clearPreviousFiles()" title="æ¸…é™¤å†å²è®°å½•">ğŸ—‘ï¸ æ¸…é™¤å†å²</button>
                </div>
                <div class="incremental-stats-items">
                    <div class="incremental-stat-item incremental-stat-new">
                        <span class="incremental-stat-icon">â•</span>
                        <span class="incremental-stat-value" id="statNewFiles">0</span>
                        <span class="incremental-stat-label">æ–°å¢æ–‡ä»¶</span>
                    </div>
                    <div class="incremental-stat-item incremental-stat-deleted">
                        <span class="incremental-stat-icon">â–</span>
                        <span class="incremental-stat-value" id="statDeletedFiles">0</span>
                        <span class="incremental-stat-label">åˆ é™¤æ–‡ä»¶</span>
                    </div>
                    <div class="incremental-stat-item incremental-stat-unchanged">
                        <span class="incremental-stat-icon">â¸ï¸</span>
                        <span class="incremental-stat-value" id="statUnchangedFiles">0</span>
                        <span class="incremental-stat-label">æœªå˜åŒ–</span>
                    </div>
                </div>
            </div>
            <!-- ç›®å½•ç»“æ„é¢„è§ˆ -->
            <div class="directory-preview" id="directoryPreview">
                <div class="directory-preview-header">
                    <span class="directory-preview-title">ğŸ“ ç›®å½•ç»“æ„é¢„è§ˆ</span>
                    <div class="directory-preview-actions">
                        <button class="directory-preview-btn" onclick="expandAllTree()" title="å±•å¼€å…¨éƒ¨">ğŸ“‚ å±•å¼€</button>
                        <button class="directory-preview-btn" onclick="collapseAllTree()" title="æŠ˜å å…¨éƒ¨">ğŸ“ æŠ˜å </button>
                        <button class="directory-preview-btn" onclick="selectAllItems()" title="å…¨é€‰">â˜‘ï¸ å…¨é€‰</button>
                        <button class="directory-preview-btn" onclick="deselectAllItems()" title="å–æ¶ˆå…¨é€‰">â˜ å–æ¶ˆ</button>
                    </div>
                </div>
                <div class="directory-tree-container" id="directoryTreeContainer">
                    <!-- ç›®å½•æ ‘å°†ç”± JavaScript åŠ¨æ€ç”Ÿæˆ -->
                </div>
                <div class="directory-preview-footer" id="directoryPreviewFooter">
                    <span>ğŸ“ <strong id="selectedFolderCount">0</strong> ä¸ªæ–‡ä»¶å¤¹</span>
                    <span>ğŸ¬ <strong id="selectedFileCount">0</strong> ä¸ªæ–‡ä»¶</span>
                    <span>ğŸ“Š å…± <strong id="totalSelectedSize">0</strong> ä¸ª STRM æ–‡ä»¶å°†è¢«ç”Ÿæˆ</span>
                </div>
            </div>
        </div>

        <!-- URLé¢„è§ˆæ¨¡å— -->
        <div class="card" id="previewCard" style="display: none;">
            <div class="card-header">
                <div class="card-icon">ğŸ‘ï¸</div>
                <h2 class="card-title">URL é¢„è§ˆ</h2>
            </div>
            <div class="preview-container" id="previewContainer">
                <ul class="preview-list" id="previewList">
                    <!-- URLåˆ—è¡¨ -->
                </ul>
            </div>
        </div>

        <!-- ç”Ÿæˆä¸ä¸‹è½½æ¨¡å— -->
        <div class="card" id="downloadCard" style="display: none;">
            <div class="card-header">
                <div class="card-icon">ğŸ’¾</div>
                <h2 class="card-title">ç”Ÿæˆä¸ä¸‹è½½</h2>
            </div>
            <div class="btn-group download-btn-group">
                <button class="btn btn-primary" id="generateBtn" onclick="generateAndDownload('all')">
                    <span>ğŸ“¦</span>
                    <span>å…¨éƒ¨ä¸‹è½½</span>
                    <span class="btn-badge" id="btnBadgeAll">0</span>
                </button>
                <button class="btn btn-primary btn-new-only" id="generateNewBtn" onclick="generateAndDownload('new')" style="display: none;">
                    <span>âœ¨</span>
                    <span>ä»…ä¸‹è½½æ–°å¢</span>
                    <span class="btn-badge" id="btnBadgeNew">0</span>
                </button>
                <button class="btn btn-secondary" onclick="copyAllUrls()">
                    <span>ğŸ“‹</span>
                    <span>å¤åˆ¶æ‰€æœ‰ URL</span>
                </button>
            </div>
            <div class="progress-bar" id="progressBar">
                <div class="progress-bar-fill" id="progressFill" style="width: 0%"></div>
            </div>
        </div>

        </div><!-- ç»“æŸä¸»æ ‡ç­¾é¡µ tab-main -->

        <!-- åˆ®å‰Šæ£€æµ‹æ ‡ç­¾é¡µ -->
        <div class="tab-content" id="tab-scrape">

        <!-- æ–‡ä»¶å¯¼å…¥å¡ç‰‡ -->
        <div class="card">
            <div class="card-header">
                <div class="card-icon">ğŸ“‚</div>
                <h2 class="card-title">å¯¼å…¥åª’ä½“ç›®å½•</h2>
            </div>
            
            <!-- åŒæ¨¡å¼å¯¼å…¥é€‰æ‹© -->
            <div class="scrape-import-modes">
                <!-- æ–¹å¼ä¸€ï¼šç›´æ¥é€‰æ‹©æ–‡ä»¶å¤¹ï¼ˆFile System Access APIï¼‰ -->
                <div class="scrape-import-option" id="scrapeImportFolder" style="display: none;">
                    <div class="scrape-import-btn-group">
                        <button class="btn btn-primary scrape-folder-btn" onclick="selectScrapeFolder()">
                            <span>ğŸ“</span>
                            <span>é€‰æ‹©æ–‡ä»¶å¤¹</span>
                        </button>
                        <p class="scrape-import-hint">ç›´æ¥é€‰æ‹©åª’ä½“æ–‡ä»¶å¤¹ï¼Œè‡ªåŠ¨æ‰«ææ‰€æœ‰å­ç›®å½•</p>
                    </div>
                </div>
                
                <!-- åˆ†éš”çº¿ -->
                <div class="scrape-import-divider" id="scrapeImportDivider" style="display: none;">
                    <span>æˆ–è€…</span>
                </div>
                
                <!-- æ–¹å¼äºŒï¼šå¯¼å…¥ç›®å½•æ ‘æ–‡ä»¶ -->
                <div class="scrape-import-option">
                    <div class="drop-zone" id="scrapeDropZone">
                        <div class="drop-zone-icon">ğŸ“„</div>
                        <p class="drop-zone-text">æ‹–æ‹½ tree.txt æ–‡ä»¶åˆ°æ­¤å¤„ï¼Œæˆ–ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</p>
                        <p class="drop-zone-hint">æ”¯æŒ .txt æ ¼å¼ï¼Œè‡ªåŠ¨è¯†åˆ« UTF-16 LE ç¼–ç </p>
                    </div>
                    <input type="file" class="file-input" id="scrapeFileInput" accept=".txt">
                </div>
            </div>
            
            <!-- æ‰«æè¿›åº¦æ˜¾ç¤º -->
            <div class="scrape-scan-progress" id="scrapeScanProgress" style="display: none;">
                <div class="scrape-scan-status">
                    <div class="spinner"></div>
                    <span id="scrapeScanStatusText">æ­£åœ¨æ‰«æ...</span>
                </div>
                <div class="scrape-scan-stats">
                    <span>ğŸ“ <strong id="scrapeScanDirCount">0</strong> ä¸ªæ–‡ä»¶å¤¹</span>
                    <span>ğŸ“„ <strong id="scrapeScanFileCount">0</strong> ä¸ªæ–‡ä»¶</span>
                </div>
            </div>
            
            <!-- æ–‡ä»¶ä¿¡æ¯æ˜¾ç¤º -->
            <div class="file-info" id="scrapeFileInfo">
                <span class="file-info-icon">ğŸ“„</span>
                <div class="file-info-details">
                    <div class="file-info-name" id="scrapeFileName">-</div>
                    <div class="file-info-size" id="scrapeFileSize">-</div>
                </div>
                <button class="file-info-remove" onclick="removeScrapeFile()" title="ç§»é™¤æ–‡ä»¶">âœ•</button>
            </div>
        </div>

        <!-- åˆ®å‰Šæ ‡è¯†é…ç½®å¡ç‰‡ -->
        <div class="card">
            <div class="card-header">
                <div class="card-icon">ğŸ·ï¸</div>
                <h2 class="card-title">åˆ®å‰Šæ ‡è¯†é…ç½®</h2>
            </div>
            <p style="color: var(--text-secondary); margin-bottom: 16px; font-size: 14px;">
                åˆ®å‰Šå®Œæˆæ¡ä»¶ï¼šç›®å½•å¿…é¡»åŒæ—¶åŒ…å« NFO æ–‡ä»¶å’Œå›¾ç‰‡æ–‡ä»¶ï¼ˆposter.jpgã€fanart.jpg ç­‰ï¼‰
            </p>
            <div class="tag-input-container">
                <div class="tag-list scrape-indicator-tag-list" id="scrapeIndicatorTagList">
                    <!-- æ ‡ç­¾å°†ç”± JavaScript åŠ¨æ€ç”Ÿæˆ -->
                </div>
                <div class="tag-input-row">
                    <input type="text" class="tag-input" id="scrapeIndicatorInput" placeholder="è¾“å…¥æ–‡ä»¶åï¼ˆå¦‚ï¼šposter.pngï¼‰" onkeypress="handleScrapeIndicatorKeypress(event)">
                    <button class="tag-btn tag-btn-add" onclick="addScrapeIndicator()">æ·»åŠ </button>
                    <button class="tag-btn tag-btn-reset" onclick="resetScrapeIndicators()">é‡ç½®ä¸ºé»˜è®¤</button>
                </div>
                <p class="tag-hint">ğŸ’¡ è¾“å…¥å®Œæ•´æ–‡ä»¶ååæŒ‰ Enter æˆ–ç‚¹å‡»"æ·»åŠ "æŒ‰é’®ã€‚æ”¯æŒ .nfoã€.jpg ç­‰æ–‡ä»¶</p>
            </div>
        </div>

        <!-- æ£€æµ‹ç»“æœç»Ÿè®¡å¡ç‰‡ -->
        <div class="card" id="scrapeResultCard" style="display: none;">
            <div class="card-header">
                <div class="card-icon">ğŸ“Š</div>
                <h2 class="card-title">æ£€æµ‹ç»“æœ</h2>
            </div>
            <div class="scrape-stats">
                <div class="scrape-stat-item info">
                    <div class="scrape-stat-value" id="scrapeTotalDirs">0</div>
                    <div class="scrape-stat-label">åª’ä½“ç›®å½•</div>
                </div>
                <div class="scrape-stat-item success">
                    <div class="scrape-stat-value" id="scrapeScrapedDirs">0</div>
                    <div class="scrape-stat-label">å·²åˆ®å‰Š</div>
                </div>
                <div class="scrape-stat-item warning">
                    <div class="scrape-stat-value" id="scrapeUnscrapedDirs">0</div>
                    <div class="scrape-stat-label">æœªåˆ®å‰Š</div>
                </div>
            </div>
            <div class="scrape-progress-bar">
                <div class="scrape-progress-fill" id="scrapeProgressFill" style="width: 0%"></div>
            </div>
            <div class="scrape-progress-text" id="scrapeProgressText">åˆ®å‰Šç‡ï¼š0%</div>
        </div>

        <!-- æœªåˆ®å‰Šç›®å½•åˆ—è¡¨å¡ç‰‡ -->
        <div class="card" id="unscrapedListCard" style="display: none;">
            <div class="card-header">
                <div class="card-icon">ğŸ“‹</div>
                <h2 class="card-title">æœªåˆ®å‰Šç›®å½•åˆ—è¡¨</h2>
            </div>
            <div class="unscraped-search-container">
                <input type="text" class="unscraped-search-input" id="unscrapedSearchInput" placeholder="æœç´¢ç›®å½•è·¯å¾„..." oninput="filterUnscrapedList()">
            </div>
            <div class="unscraped-count" id="unscrapedCount">å…± 0 ä¸ªæœªåˆ®å‰Šç›®å½•</div>
            <div class="unscraped-list-container" id="unscrapedListContainer">
                <ul class="unscraped-list" id="unscrapedList">
                    <!-- åˆ—è¡¨å°†ç”± JavaScript åŠ¨æ€ç”Ÿæˆ -->
                </ul>
            </div>
            <div class="unscraped-actions">
                <button class="btn btn-primary" onclick="copyUnscrapedPaths()">
                    <span>ğŸ“‹</span>
                    <span>å¤åˆ¶å…¨éƒ¨è·¯å¾„</span>
                </button>
                <button class="btn btn-secondary" onclick="exportUnscrapedTxt()">
                    <span>ğŸ’¾</span>
                    <span>å¯¼å‡ºä¸º TXT</span>
                </button>
            </div>
            
            <!-- STRM æ–‡ä»¶å¤åˆ¶åŠŸèƒ½ -->
            <div class="scrape-copy-section" id="scrapeCopySection" style="display: none;">
                <div class="scrape-copy-divider">
                    <span>STRM æ–‡ä»¶æ‰¹é‡å¤åˆ¶</span>
                </div>
                <div class="scrape-copy-hint">
                    <p>ğŸ“‹ å°†æœªåˆ®å‰Šç›®å½•ä¸­çš„ STRM æ–‡ä»¶å¤åˆ¶åˆ°ç›®æ ‡æ–‡ä»¶å¤¹ï¼Œä¿æŒåŸç›®å½•ç»“æ„ï¼Œæ–¹ä¾¿æ‰¹é‡åˆ®å‰Šåå†å¤åˆ¶å›æ¥ã€‚</p>
                </div>
                
                <!-- ç›®å½•é€‰æ‹©å™¨ -->
                <div class="directory-selector-group">
                    <div class="directory-selector">
                        <span class="directory-selector-label">æºç›®å½•ï¼š</span>
                        <span class="directory-selector-name" id="srcDirName">æœªé€‰æ‹©</span>
                        <button class="directory-selector-btn" id="selectSrcDirBtn" onclick="selectSrcDirectory()">
                            <span>ğŸ“</span>
                            <span>é€‰æ‹©ç›®å½•</span>
                        </button>
                    </div>
                    <div class="directory-selector">
                        <span class="directory-selector-label">ç›®æ ‡ç›®å½•ï¼š</span>
                        <span class="directory-selector-name" id="destDirName">æœªé€‰æ‹©</span>
                        <button class="directory-selector-btn" id="selectDestDirBtn" onclick="selectDestDirectory()">
                            <span>ğŸ“</span>
                            <span>é€‰æ‹©ç›®å½•</span>
                        </button>
                    </div>
                </div>
                
                <div class="scrape-copy-actions">
                    <button class="btn btn-primary start-copy-btn" onclick="startStrmCopy()" id="startCopyBtn" disabled>
                        <span>ğŸ“‚</span>
                        <span>å¼€å§‹å¤åˆ¶</span>
                    </button>
                </div>
                <div class="scrape-copy-progress" id="scrapeCopyProgress" style="display: none;">
                    <div class="scrape-copy-progress-status">
                        <div class="spinner"></div>
                        <span id="scrapeCopyStatusText">æ­£åœ¨å¤åˆ¶...</span>
                    </div>
                    <div class="progress-bar visible">
                        <div class="progress-bar-fill" id="scrapeCopyProgressFill" style="width: 0%"></div>
                    </div>
                    <div class="scrape-copy-progress-stats">
                        <span>å·²å¤åˆ¶: <strong id="scrapeCopyCount">0</strong> / <strong id="scrapeCopyTotal">0</strong> ä¸ªæ–‡ä»¶</span>
                    </div>
                </div>
                <div class="scrape-copy-result" id="scrapeCopyResult" style="display: none;">
                    <!-- ç»“æœå°†ç”± JavaScript åŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
        </div>

        </div><!-- ç»“æŸåˆ®å‰Šæ£€æµ‹æ ‡ç­¾é¡µ tab-scrape -->

    </div>

    <div class="toast-container" id="toastContainer"></div>

    <!-- WebDAV ç›®å½•æµè§ˆå™¨æ¨¡æ€æ¡† -->
    <div class="webdav-modal-overlay" id="webdavModalOverlay" onclick="handleOverlayClick(event)"></div>
    <div class="webdav-browser" id="webdavBrowser">
        <!-- ç¼©æ”¾æ‰‹æŸ„ -->
        <div class="webdav-resize-handle webdav-resize-handle-n" data-direction="n"></div>
        <div class="webdav-resize-handle webdav-resize-handle-s" data-direction="s"></div>
        <div class="webdav-resize-handle webdav-resize-handle-e" data-direction="e"></div>
        <div class="webdav-resize-handle webdav-resize-handle-w" data-direction="w"></div>
        <div class="webdav-resize-handle webdav-resize-handle-nw" data-direction="nw"></div>
        <div class="webdav-resize-handle webdav-resize-handle-ne" data-direction="ne"></div>
        <div class="webdav-resize-handle webdav-resize-handle-sw" data-direction="sw"></div>
        <div class="webdav-resize-handle webdav-resize-handle-se" data-direction="se"></div>
        
        <!-- æ ‡é¢˜æ ï¼ˆå¯æ‹–åŠ¨ï¼‰ -->
        <div class="webdav-browser-header" id="webdavBrowserHeader">
            <span class="webdav-browser-title">ğŸ“ WebDAV ç›®å½•æµè§ˆ</span>
            <button class="webdav-browser-close" onclick="closeWebdavBrowser()" title="å…³é—­">âœ•</button>
        </div>
        
        <!-- é¢åŒ…å±‘å¯¼èˆª -->
        <div class="webdav-breadcrumb-bar">
            <div class="webdav-breadcrumb" id="webdavBreadcrumb">
                <span class="webdav-breadcrumb-item active" data-path="/">ğŸ“ æ ¹ç›®å½•</span>
            </div>
        </div>
        
        <!-- å†…å®¹åŒºåŸŸ -->
        <div class="webdav-browser-content" id="webdavBrowserContent">
            <div class="webdav-browser-loading" id="webdavBrowserLoading">
                <div class="spinner"></div>
                <span>æ­£åœ¨åŠ è½½ç›®å½•...</span>
            </div>
            <div class="webdav-browser-empty" id="webdavBrowserEmpty" style="display: none;">
                <div class="webdav-browser-empty-icon">ğŸ“­</div>
                <span>æ­¤ç›®å½•ä¸‹æ²¡æœ‰ txt æ–‡ä»¶æˆ–æ–‡ä»¶å¤¹</span>
            </div>
            <ul class="webdav-file-list" id="webdavFileList" style="display: none;"></ul>
        </div>
    </div>

    <script>
        // å…¨å±€çŠ¶æ€
        let parsedData = null;
        let mediaFiles = [];
        let filteredFiles = []; // è¢«å¹¿å‘Šè¿‡æ»¤æ‰çš„æ–‡ä»¶
        let previousFileSet = new Set(); // ä¸Šæ¬¡ç”Ÿæˆçš„æ–‡ä»¶åˆ—è¡¨
        let newFiles = []; // æ–°å¢æ–‡ä»¶
        let deletedFiles = []; // åˆ é™¤æ–‡ä»¶
        let unchangedFiles = []; // æœªå˜åŒ–æ–‡ä»¶
        let excludedPaths = new Set(); // ç”¨æˆ·æ‰‹åŠ¨æ’é™¤çš„è·¯å¾„
        let treeData = null; // æ ‘å½¢ç»“æ„æ•°æ®

        // é»˜è®¤åª’ä½“æ–‡ä»¶æ‰©å±•å
        const DEFAULT_EXTENSIONS = [
            'mp4', 'mkv', 'avi', 'ts', 'm2ts', 'rmvb', 'rm', 'wmv',
            'flv', 'mov', 'webm', 'm4v', 'mpeg', 'mpg', '3gp', '3g2'
        ];

        // å½“å‰ä½¿ç”¨çš„æ‰©å±•ååˆ—è¡¨
        let currentExtensions = [...DEFAULT_EXTENSIONS];

        // é»˜è®¤å¹¿å‘Šå…³é”®è¯
        const DEFAULT_AD_KEYWORDS = [
            '@', 'å¹¿å‘Š', 'æ‹›ç§Ÿ', 'å…¬ä¼—å·', 'å¾®ä¿¡', 'åŠ ç¾¤', 'ç¦åˆ©',
            'telegram', 't.me', 'æ°¸ä¹…', 'æ›´æ–°', 'æœ€æ–°åœ°å€',
            'é˜²å¤±è”', 'èµ„æºç¾¤', 'ç¾¤å·', 'è®¢é˜…', 'åˆé›†', 'é¢‘é“',
            'ä»£ç†', 'VPN', 'æ¢¯å­', 'ç¿»å¢™', 'åŠ é€Ÿå™¨', 'ç½‘ç›˜',
            'æ¨å¹¿', 'ä¼˜æƒ ', 'æŠ˜æ‰£', 'å…è´¹é¢†', 'é™æ—¶', 'ä¸“å±'
        ];

        // å½“å‰ä½¿ç”¨çš„å¹¿å‘Šå…³é”®è¯åˆ—è¡¨
        let currentAdKeywords = [...DEFAULT_AD_KEYWORDS];

        // å¹¿å‘Šè¿‡æ»¤å¼€å…³çŠ¶æ€
        let adFilterEnabled = true;

        // ä¸»é¢˜åˆ‡æ¢
        function toggleTheme() {
            const body = document.body;
            const icon = document.getElementById('themeIcon');
            if (body.getAttribute('data-theme') === 'dark') {
                body.removeAttribute('data-theme');
                icon.textContent = 'ğŸŒ™';
                localStorage.setItem('theme', 'light');
            } else {
                body.setAttribute('data-theme', 'dark');
                icon.textContent = 'â˜€ï¸';
                localStorage.setItem('theme', 'dark');
            }
        }

        // åˆå§‹åŒ–ä¸»é¢˜
        function initTheme() {
            const savedTheme = localStorage.getItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
                document.body.setAttribute('data-theme', 'dark');
                document.getElementById('themeIcon').textContent = 'â˜€ï¸';
            }
        }

        // Toast é€šçŸ¥
        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            const icons = { success: 'âœ…', error: 'âŒ', info: 'â„¹ï¸' };
            toast.innerHTML = `<span>${icons[type]}</span><span>${message}</span>`;
            container.appendChild(toast);
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateY(20px)';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // æ–‡ä»¶å¤§å°æ ¼å¼åŒ–
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // åˆå§‹åŒ–æ‹–æ‹½åŒºåŸŸ
        function initDropZone() {
            const dropZone = document.getElementById('dropZone');
            const fileInput = document.getElementById('fileInput');

            dropZone.addEventListener('click', () => fileInput.click());

            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('dragover');
            });

            dropZone.addEventListener('dragleave', () => {
                dropZone.classList.remove('dragover');
            });

            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFile(files[0]);
                }
            });

            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleFile(e.target.files[0]);
                }
            });
        }

        // å¤„ç†æ–‡ä»¶
        async function handleFile(file) {
            if (!file.name.endsWith('.txt')) {
                showToast('è¯·é€‰æ‹© .txt æ ¼å¼çš„æ–‡ä»¶', 'error');
                return;
            }

            // æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
            document.getElementById('fileName').textContent = file.name;
            document.getElementById('fileSize').textContent = formatFileSize(file.size);
            document.getElementById('fileInfo').classList.add('visible');

            try {
                const content = await readFileContent(file);
                parseDirectoryTree(content);
                showToast('æ–‡ä»¶è§£ææˆåŠŸ', 'success');
            } catch (error) {
                console.error('è§£æé”™è¯¯:', error);
                showToast('æ–‡ä»¶è§£æå¤±è´¥: ' + error.message, 'error');
            }
        }

        // è¯»å–æ–‡ä»¶å†…å®¹ï¼ˆæ”¯æŒUTF-16 LEï¼‰
        function readFileContent(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const arrayBuffer = e.target.result;
                    const uint8Array = new Uint8Array(arrayBuffer);
                    
                    // æ£€æµ‹ UTF-16 LE BOM (FF FE)
                    if (uint8Array.length >= 2 && uint8Array[0] === 0xFF && uint8Array[1] === 0xFE) {
                        // UTF-16 LE ç¼–ç 
                        const decoder = new TextDecoder('utf-16le');
                        resolve(decoder.decode(arrayBuffer));
                    } else if (uint8Array.length >= 2 && uint8Array[0] === 0xFE && uint8Array[1] === 0xFF) {
                        // UTF-16 BE ç¼–ç 
                        const decoder = new TextDecoder('utf-16be');
                        resolve(decoder.decode(arrayBuffer));
                    } else if (uint8Array.length >= 3 && uint8Array[0] === 0xEF && uint8Array[1] === 0xBB && uint8Array[2] === 0xBF) {
                        // UTF-8 with BOM
                        const decoder = new TextDecoder('utf-8');
                        resolve(decoder.decode(arrayBuffer));
                    } else {
                        // é»˜è®¤ UTF-8
                        const decoder = new TextDecoder('utf-8');
                        resolve(decoder.decode(arrayBuffer));
                    }
                };
                reader.onerror = () => reject(new Error('æ–‡ä»¶è¯»å–å¤±è´¥'));
                reader.readAsArrayBuffer(file);
            });
        }

        // è§£æç›®å½•æ ‘
        function parseDirectoryTree(content) {
            const lines = content.split(/\r?\n/).filter(line => line.trim());
            const root = { name: 'root', type: 'folder', children: [] };
            const stack = [{ node: root, level: -1 }];
            
            let folderCount = 0;
            let fileCount = 0;
            let maxDepth = 0;
            mediaFiles = [];

            for (const line of lines) {
                // è®¡ç®—å±‚çº§ï¼ˆç«–çº¿æ•°é‡ï¼‰
                const pipeCount = (line.match(/\|/g) || []).length;
                const level = pipeCount;
                
                // æå–åç§° - æ”¯æŒå¤šç§æ ¼å¼
                let name = '';
                
                // æ ¼å¼1: "| |-åç§°" æˆ– "|-åç§°"
                const match1 = line.match(/\|-\s*(.+)$/);
                if (match1) {
                    name = match1[1].trim();
                }
                
                if (!name) continue;

                // åˆ¤æ–­æ˜¯æ–‡ä»¶è¿˜æ˜¯æ–‡ä»¶å¤¹
                const isFile = /\.[a-zA-Z0-9]+$/.test(name);
                const isMediaFile = isFile && isMediaExtension(name);

                const node = {
                    name: name,
                    type: isFile ? 'file' : 'folder',
                    isMedia: isMediaFile,
                    children: isFile ? undefined : [],
                    path: []
                };

                // æ‰¾åˆ°çˆ¶èŠ‚ç‚¹
                while (stack.length > 1 && stack[stack.length - 1].level >= level) {
                    stack.pop();
                }

                const parent = stack[stack.length - 1].node;
                
                // æ„å»ºè·¯å¾„
                node.path = [...(parent.path || []), name];
                
                if (parent.children) {
                    parent.children.push(node);
                }

                if (!isFile) {
                    stack.push({ node, level });
                    folderCount++;
                } else if (isMediaFile) {
                    fileCount++;
                    mediaFiles.push(node);
                }

                maxDepth = Math.max(maxDepth, level);
            }

            parsedData = root;

            // åº”ç”¨å¹¿å‘Šè¿‡æ»¤
            filteredFiles = [];
            let filteredCount = 0;
            const originalMediaFiles = [...mediaFiles];
            mediaFiles = [];
            
            for (const file of originalMediaFiles) {
                const pathStr = file.path.join('/');
                if (containsAdKeyword(pathStr)) {
                    filteredFiles.push(file);
                    filteredCount++;
                    fileCount--;
                } else {
                    mediaFiles.push(file);
                }
            }

            // æ›´æ–°ç»Ÿè®¡
            document.getElementById('statFolders').textContent = folderCount;
            document.getElementById('statFiles').textContent = fileCount;
            document.getElementById('statDepth').textContent = maxDepth;
            
            // æ˜¾ç¤ºè¿‡æ»¤ç»Ÿè®¡
            const filteredContainer = document.getElementById('statFilteredContainer');
            if (filteredCount > 0) {
                filteredContainer.style.display = 'block';
                document.getElementById('statFiltered').textContent = filteredCount;
            } else {
                filteredContainer.style.display = 'none';
            }

            // æ˜¾ç¤ºç»“æœå¡ç‰‡
            document.getElementById('parseResultCard').style.display = 'block';
            
            // è®¡ç®—å¢é‡å˜åŒ–
            calculateIncrementalChanges();
            
            // æ¸²æŸ“ç›®å½•æ ‘ï¼ˆæ–°ç‰ˆæœ¬ï¼‰
            renderDirectoryTree();

            // æ›´æ–°é¢„è§ˆ
            updatePreview();
        }

        // æ¸²æŸ“ç›®å½•æ ‘è§†å›¾
        function renderTreeView(node, container = null) {
            if (!container) {
                container = document.getElementById('treeView');
                container.innerHTML = '';
            }

            if (node.children) {
                for (const child of node.children) {
                    const div = document.createElement('div');
                    div.className = 'tree-node';
                    
                    const span = document.createElement('span');
                    span.className = child.type === 'folder' ? 'tree-folder' : 'tree-file';
                    span.textContent = child.name;
                    div.appendChild(span);

                    if (child.children && child.children.length > 0) {
                        const childContainer = document.createElement('div');
                        renderTreeView(child, childContainer);
                        div.appendChild(childContainer);
                    }

                    container.appendChild(div);
                }
            }
        }

        // æ›´æ–°URLé¢„è§ˆ
        function updatePreview() {
            const urlPrefix = document.getElementById('urlPrefix').value.trim();
            const previewList = document.getElementById('previewList');
            previewList.innerHTML = '';

            if (mediaFiles.length === 0) {
                document.getElementById('previewCard').style.display = 'none';
                document.getElementById('downloadCard').style.display = 'none';
                return;
            }

            document.getElementById('previewCard').style.display = 'block';
            document.getElementById('downloadCard').style.display = 'block';

            for (const file of mediaFiles) {
                const li = document.createElement('li');
                li.className = 'preview-item';
                
                const pathStr = file.path.join('/');
                const fullUrl = buildUrl(urlPrefix, pathStr);

                li.innerHTML = `
                    <span class="preview-item-icon">ğŸ¬</span>
                    <div>
                        <div class="preview-item-path">${escapeHtml(pathStr)}</div>
                        <div class="preview-item-url">${escapeHtml(fullUrl)}</div>
                    </div>
                `;
                previewList.appendChild(li);
            }
        }

        // æ„å»ºURL
        function buildUrl(prefix, path) {
            // å¤„ç†å‰ç¼€æœ«å°¾æ–œæ 
            let base = prefix.replace(/\/+$/, '');
            
            // è·å–URLç¼–ç å¼€å…³çŠ¶æ€
            const encodeEnabled = document.getElementById('urlEncodeToggle').checked;
            
            // æ ¹æ®å¼€å…³çŠ¶æ€å†³å®šæ˜¯å¦ç¼–ç è·¯å¾„
            let processedPath;
            if (encodeEnabled) {
                // å¯¹è·¯å¾„è¿›è¡Œç¼–ç ï¼Œä½†ä¿ç•™æ–œæ 
                processedPath = path.split('/').map(segment => encodeURIComponent(segment)).join('/');
            } else {
                // ä¸ç¼–ç ï¼Œç›´æ¥ä½¿ç”¨åŸå§‹è·¯å¾„
                processedPath = path;
            }
            
            if (!base) {
                return processedPath;
            }
            
            return `${base}/${processedPath}`;
        }

        // HTMLè½¬ä¹‰
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ç§»é™¤æ–‡ä»¶
        function removeFile() {
            document.getElementById('fileInfo').classList.remove('visible');
            document.getElementById('fileInput').value = '';
            document.getElementById('parseResultCard').style.display = 'none';
            document.getElementById('previewCard').style.display = 'none';
            document.getElementById('downloadCard').style.display = 'none';
            parsedData = null;
            mediaFiles = [];
        }

        // ç”Ÿæˆå¹¶ä¸‹è½½
        async function generateAndDownload(mode = 'all') {
            const urlPrefix = document.getElementById('urlPrefix').value.trim();
            
            // æ ¹æ®æ¨¡å¼é€‰æ‹©è¦ç”Ÿæˆçš„æ–‡ä»¶åˆ—è¡¨
            let filesToGenerate;
            if (mode === 'new') {
                filesToGenerate = newFiles.filter(f => !excludedPaths.has(f.path.join('/')));
            } else {
                filesToGenerate = mediaFiles.filter(f => !excludedPaths.has(f.path.join('/')));
            }
            
            if (filesToGenerate.length === 0) {
                showToast('æ²¡æœ‰å¯ç”Ÿæˆçš„åª’ä½“æ–‡ä»¶', 'error');
                return;
            }

            const btn = mode === 'new' ? document.getElementById('generateNewBtn') : document.getElementById('generateBtn');
            const progressBar = document.getElementById('progressBar');
            const progressFill = document.getElementById('progressFill');

            btn.disabled = true;
            progressBar.classList.add('visible');
            progressFill.style.width = '0%';

            try {
                const zip = new JSZip();
                const total = filesToGenerate.length;

                for (let i = 0; i < total; i++) {
                    const file = filesToGenerate[i];
                    const pathStr = file.path.join('/');
                    const fullUrl = buildUrl(urlPrefix, pathStr);
                    
                    // ç”Ÿæˆ .strm æ–‡ä»¶è·¯å¾„
                    const strmPath = pathStr.replace(/\.[^.]+$/, '.strm');
                    
                    // æ·»åŠ åˆ° ZIP
                    zip.file(strmPath, fullUrl);
                    
                    // æ›´æ–°è¿›åº¦
                    const progress = ((i + 1) / total) * 100;
                    progressFill.style.width = `${progress}%`;
                }

                // ç”Ÿæˆ ZIP æ–‡ä»¶
                const content = await zip.generateAsync({
                    type: 'blob',
                    compression: 'DEFLATE',
                    compressionOptions: { level: 6 }
                });

                // ä¸‹è½½
                const timestamp = new Date().toISOString().slice(0, 10).replace(/-/g, '');
                const suffix = mode === 'new' ? '_new' : '';
                saveAs(content, `strm_files_${timestamp}${suffix}.zip`);

                // ä¿å­˜å½“å‰æ–‡ä»¶åˆ—è¡¨ä½œä¸ºä¸‹æ¬¡å¯¹æ¯”çš„åŸºå‡†
                savePreviousFileList();

                const modeText = mode === 'new' ? 'æ–°å¢' : '';
                showToast(`æˆåŠŸç”Ÿæˆ ${total} ä¸ª${modeText} STRM æ–‡ä»¶`, 'success');
            } catch (error) {
                console.error('ç”Ÿæˆé”™è¯¯:', error);
                showToast('ç”Ÿæˆå¤±è´¥: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                setTimeout(() => {
                    progressBar.classList.remove('visible');
                    progressFill.style.width = '0%';
                }, 1000);
            }
        }

        // å¤åˆ¶æ‰€æœ‰URL
        function copyAllUrls() {
            const urlPrefix = document.getElementById('urlPrefix').value.trim();
            
            if (mediaFiles.length === 0) {
                showToast('æ²¡æœ‰å¯å¤åˆ¶çš„URL', 'error');
                return;
            }

            const urls = mediaFiles.map(file => {
                const pathStr = file.path.join('/');
                return buildUrl(urlPrefix, pathStr);
            }).join('\n');

            navigator.clipboard.writeText(urls).then(() => {
                showToast('å·²å¤åˆ¶æ‰€æœ‰URLåˆ°å‰ªè´´æ¿', 'success');
            }).catch(() => {
                showToast('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶', 'error');
            });
        }

        // URLå‰ç¼€è¾“å…¥äº‹ä»¶ - è‡ªåŠ¨ä¿å­˜åˆ°localStorage
        document.getElementById('urlPrefix').addEventListener('input', (e) => {
            // ä¿å­˜åˆ°localStorage
            localStorage.setItem('strm_urlPrefix', e.target.value);
            if (parsedData) {
                updatePreview();
            }
        });

        // URLç¼–ç å¼€å…³äº‹ä»¶ - è‡ªåŠ¨ä¿å­˜åˆ°localStorage
        document.getElementById('urlEncodeToggle').addEventListener('change', (e) => {
            const toggleStatus = document.getElementById('toggleStatus');
            if (e.target.checked) {
                toggleStatus.textContent = 'å¼€å¯';
                toggleStatus.classList.add('active');
            } else {
                toggleStatus.textContent = 'å…³é—­';
                toggleStatus.classList.remove('active');
            }
            // ä¿å­˜åˆ°localStorage
            localStorage.setItem('strm_urlEncode', e.target.checked);
            // æ›´æ–°é¢„è§ˆ
            if (parsedData) {
                updatePreview();
            }
        });

        // ==================== åç¼€åç®¡ç†åŠŸèƒ½ ====================

        // æ£€æŸ¥æ–‡ä»¶æ˜¯å¦æ˜¯åª’ä½“æ–‡ä»¶
        function isMediaExtension(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            return currentExtensions.includes(ext);
        }

        // æ¸²æŸ“åç¼€åæ ‡ç­¾åˆ—è¡¨
        function renderExtensionTags() {
            const container = document.getElementById('extensionTagList');
            container.innerHTML = '';
            
            for (const ext of currentExtensions) {
                const tag = document.createElement('span');
                tag.className = 'tag-item';
                tag.innerHTML = `
                    .${ext}
                    <button class="tag-item-remove" onclick="removeExtension('${ext}')" title="åˆ é™¤">Ã—</button>
                `;
                container.appendChild(tag);
            }
        }

        // æ·»åŠ åç¼€å
        function addExtension() {
            const input = document.getElementById('extensionInput');
            let ext = input.value.trim().toLowerCase();
            
            // ç§»é™¤å¼€å¤´çš„ç‚¹å·
            ext = ext.replace(/^\.+/, '');
            
            if (!ext) {
                showToast('è¯·è¾“å…¥åç¼€å', 'error');
                return;
            }
            
            // éªŒè¯æ ¼å¼
            if (!/^[a-zA-Z0-9]+$/.test(ext)) {
                showToast('åç¼€ååªèƒ½åŒ…å«å­—æ¯å’Œæ•°å­—', 'error');
                return;
            }
            
            if (currentExtensions.includes(ext)) {
                showToast('è¯¥åç¼€åå·²å­˜åœ¨', 'error');
                return;
            }
            
            currentExtensions.push(ext);
            saveExtensionsToStorage();
            renderExtensionTags();
            input.value = '';
            showToast(`å·²æ·»åŠ åç¼€å: .${ext}`, 'success');
            
            // å¦‚æœæœ‰å·²è§£æçš„æ•°æ®ï¼Œé‡æ–°è§£æ
            if (parsedData) {
                reprocessMediaFiles();
            }
        }

        // åˆ é™¤åç¼€å
        function removeExtension(ext) {
            const index = currentExtensions.indexOf(ext);
            if (index > -1) {
                currentExtensions.splice(index, 1);
                saveExtensionsToStorage();
                renderExtensionTags();
                showToast(`å·²åˆ é™¤åç¼€å: .${ext}`, 'info');
                
                // å¦‚æœæœ‰å·²è§£æçš„æ•°æ®ï¼Œé‡æ–°è§£æ
                if (parsedData) {
                    reprocessMediaFiles();
                }
            }
        }

        // é‡ç½®ä¸ºé»˜è®¤åç¼€å
        function resetExtensions() {
            currentExtensions = [...DEFAULT_EXTENSIONS];
            saveExtensionsToStorage();
            renderExtensionTags();
            showToast('å·²é‡ç½®ä¸ºé»˜è®¤åç¼€ååˆ—è¡¨', 'success');
            
            // å¦‚æœæœ‰å·²è§£æçš„æ•°æ®ï¼Œé‡æ–°è§£æ
            if (parsedData) {
                reprocessMediaFiles();
            }
        }

        // å¤„ç†å›è½¦é”®æ·»åŠ åç¼€å
        function handleExtensionKeypress(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                addExtension();
            }
        }

        // ä¿å­˜åç¼€ååˆ° localStorage
        function saveExtensionsToStorage() {
            localStorage.setItem('strmExtensions', JSON.stringify(currentExtensions));
        }

        // ä» localStorage åŠ è½½åç¼€å
        function loadExtensionsFromStorage() {
            const saved = localStorage.getItem('strmExtensions');
            if (saved) {
                try {
                    currentExtensions = JSON.parse(saved);
                } catch (e) {
                    currentExtensions = [...DEFAULT_EXTENSIONS];
                }
            }
        }

        // é‡æ–°å¤„ç†åª’ä½“æ–‡ä»¶ï¼ˆå½“åç¼€ååˆ—è¡¨æˆ–å¹¿å‘Šå…³é”®è¯å˜åŒ–æ—¶ï¼‰
        function reprocessMediaFiles() {
            if (!parsedData) return;
            
            mediaFiles = [];
            filteredFiles = [];
            let fileCount = 0;
            let filteredCount = 0;
            
            function traverse(node) {
                if (node.type === 'file') {
                    const isMedia = isMediaExtension(node.name);
                    node.isMedia = isMedia;
                    
                    if (isMedia) {
                        const pathStr = node.path.join('/');
                        const isFiltered = containsAdKeyword(pathStr);
                        
                        if (isFiltered) {
                            filteredFiles.push(node);
                            filteredCount++;
                        } else {
                            mediaFiles.push(node);
                            fileCount++;
                        }
                    }
                }
                if (node.children) {
                    for (const child of node.children) {
                        traverse(child);
                    }
                }
            }
            
            traverse(parsedData);
            
            // æ›´æ–°ç»Ÿè®¡
            document.getElementById('statFiles').textContent = fileCount;
            
            // æ˜¾ç¤ºè¿‡æ»¤ç»Ÿè®¡
            const filteredContainer = document.getElementById('statFilteredContainer');
            if (filteredCount > 0) {
                filteredContainer.style.display = 'block';
                document.getElementById('statFiltered').textContent = filteredCount;
            } else {
                filteredContainer.style.display = 'none';
            }
            
            // è®¡ç®—å¢é‡å˜åŒ–
            calculateIncrementalChanges();
            
            // æ¸²æŸ“ç›®å½•æ ‘
            renderDirectoryTree();
            
            // æ›´æ–°é¢„è§ˆ
            updatePreview();
        }

        // ==================== å¹¿å‘Šå…³é”®è¯è¿‡æ»¤åŠŸèƒ½ ====================

        // æ£€æŸ¥è·¯å¾„æ˜¯å¦åŒ…å«å¹¿å‘Šå…³é”®è¯
        function containsAdKeyword(path) {
            if (!adFilterEnabled || currentAdKeywords.length === 0) {
                return false;
            }
            const lowerPath = path.toLowerCase();
            return currentAdKeywords.some(keyword => lowerPath.includes(keyword.toLowerCase()));
        }

        // æ¸²æŸ“å¹¿å‘Šå…³é”®è¯æ ‡ç­¾åˆ—è¡¨
        function renderAdKeywordTags() {
            const container = document.getElementById('adKeywordTagList');
            container.innerHTML = '';
            
            for (const keyword of currentAdKeywords) {
                const tag = document.createElement('span');
                tag.className = 'tag-item';
                tag.innerHTML = `
                    ${escapeHtml(keyword)}
                    <button class="tag-item-remove" onclick="removeAdKeyword('${escapeHtml(keyword).replace(/'/g, "\\'")}')">Ã—</button>
                `;
                container.appendChild(tag);
            }
        }

        // æ·»åŠ å¹¿å‘Šå…³é”®è¯
        function addAdKeyword() {
            const input = document.getElementById('adKeywordInput');
            const keyword = input.value.trim();
            
            if (!keyword) {
                showToast('è¯·è¾“å…¥å…³é”®è¯', 'error');
                return;
            }
            
            if (currentAdKeywords.some(k => k.toLowerCase() === keyword.toLowerCase())) {
                showToast('è¯¥å…³é”®è¯å·²å­˜åœ¨', 'error');
                return;
            }
            
            currentAdKeywords.push(keyword);
            saveAdKeywordsToStorage();
            renderAdKeywordTags();
            input.value = '';
            showToast(`å·²æ·»åŠ å…³é”®è¯: ${keyword}`, 'success');
            
            // å¦‚æœæœ‰å·²è§£æçš„æ•°æ®ï¼Œé‡æ–°è§£æ
            if (parsedData) {
                reprocessMediaFiles();
            }
        }

        // åˆ é™¤å¹¿å‘Šå…³é”®è¯
        function removeAdKeyword(keyword) {
            const index = currentAdKeywords.findIndex(k => k === keyword);
            if (index > -1) {
                currentAdKeywords.splice(index, 1);
                saveAdKeywordsToStorage();
                renderAdKeywordTags();
                showToast(`å·²åˆ é™¤å…³é”®è¯: ${keyword}`, 'info');
                
                // å¦‚æœæœ‰å·²è§£æçš„æ•°æ®ï¼Œé‡æ–°è§£æ
                if (parsedData) {
                    reprocessMediaFiles();
                }
            }
        }

        // é‡ç½®ä¸ºé»˜è®¤å¹¿å‘Šå…³é”®è¯
        function resetAdKeywords() {
            currentAdKeywords = [...DEFAULT_AD_KEYWORDS];
            saveAdKeywordsToStorage();
            renderAdKeywordTags();
            showToast('å·²é‡ç½®ä¸ºé»˜è®¤å…³é”®è¯åˆ—è¡¨', 'success');
            
            // å¦‚æœæœ‰å·²è§£æçš„æ•°æ®ï¼Œé‡æ–°è§£æ
            if (parsedData) {
                reprocessMediaFiles();
            }
        }

        // å¤„ç†å›è½¦é”®æ·»åŠ å¹¿å‘Šå…³é”®è¯
        function handleAdKeywordKeypress(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                addAdKeyword();
            }
        }

        // ä¿å­˜å¹¿å‘Šå…³é”®è¯åˆ° localStorage
        function saveAdKeywordsToStorage() {
            localStorage.setItem('strmAdKeywords', JSON.stringify(currentAdKeywords));
        }

        // ä» localStorage åŠ è½½å¹¿å‘Šå…³é”®è¯
        function loadAdKeywordsFromStorage() {
            const saved = localStorage.getItem('strmAdKeywords');
            if (saved) {
                try {
                    currentAdKeywords = JSON.parse(saved);
                } catch (e) {
                    currentAdKeywords = [...DEFAULT_AD_KEYWORDS];
                }
            }
            
            // åŠ è½½å¹¿å‘Šè¿‡æ»¤å¼€å…³çŠ¶æ€
            const savedToggle = localStorage.getItem('strmAdFilterEnabled');
            if (savedToggle !== null) {
                adFilterEnabled = savedToggle === 'true';
            }
        }

        // åˆå§‹åŒ–å¹¿å‘Šè¿‡æ»¤å¼€å…³ç›‘å¬å™¨
        function initAdFilterToggle() {
            const toggle = document.getElementById('adFilterToggle');
            const status = document.getElementById('adFilterStatus');
            
            // è®¾ç½®åˆå§‹çŠ¶æ€
            toggle.checked = adFilterEnabled;
            status.textContent = adFilterEnabled ? 'å¼€å¯' : 'å…³é—­';
            status.className = adFilterEnabled ? 'toggle-status active' : 'toggle-status';
            
            toggle.addEventListener('change', (e) => {
                adFilterEnabled = e.target.checked;
                status.textContent = adFilterEnabled ? 'å¼€å¯' : 'å…³é—­';
                status.className = adFilterEnabled ? 'toggle-status active' : 'toggle-status';
                localStorage.setItem('strmAdFilterEnabled', adFilterEnabled);
                
                // å¦‚æœæœ‰å·²è§£æçš„æ•°æ®ï¼Œé‡æ–°è§£æ
                if (parsedData) {
                    reprocessMediaFiles();
                }
            });
        }

        // ==================== å¢é‡æ›´æ–°åŠŸèƒ½ ====================

        // ä» localStorage åŠ è½½ä¸Šæ¬¡çš„æ–‡ä»¶åˆ—è¡¨
        function loadPreviousFileList() {
            const saved = localStorage.getItem('strmPreviousFiles');
            if (saved) {
                try {
                    previousFileSet = new Set(JSON.parse(saved));
                } catch (e) {
                    previousFileSet = new Set();
                }
            }
        }

        // ä¿å­˜å½“å‰æ–‡ä»¶åˆ—è¡¨åˆ° localStorage
        function savePreviousFileList() {
            const fileList = mediaFiles
                .filter(f => !excludedPaths.has(f.path.join('/')))
                .map(f => f.path.join('/'));
            localStorage.setItem('strmPreviousFiles', JSON.stringify(fileList));
        }

        // è®¡ç®—å¢é‡å˜åŒ–
        function calculateIncrementalChanges() {
            const currentFileSet = new Set(
                mediaFiles
                    .filter(f => !excludedPaths.has(f.path.join('/')))
                    .map(f => f.path.join('/'))
            );
            
            newFiles = [];
            deletedFiles = [];
            unchangedFiles = [];
            
            // æ‰¾å‡ºæ–°å¢æ–‡ä»¶
            for (const path of currentFileSet) {
                if (!previousFileSet.has(path)) {
                    const file = mediaFiles.find(f => f.path.join('/') === path);
                    if (file) {
                        newFiles.push(file);
                    }
                } else {
                    const file = mediaFiles.find(f => f.path.join('/') === path);
                    if (file) {
                        unchangedFiles.push(file);
                    }
                }
            }
            
            // æ‰¾å‡ºåˆ é™¤çš„æ–‡ä»¶
            for (const path of previousFileSet) {
                if (!currentFileSet.has(path)) {
                    deletedFiles.push(path);
                }
            }
            
            // æ›´æ–°UI
            updateIncrementalStatsUI();
        }

        // æ›´æ–°å¢é‡ç»Ÿè®¡UI
        function updateIncrementalStatsUI() {
            const statsContainer = document.getElementById('incrementalStats');
            const hasHistory = previousFileSet.size > 0;
            
            if (hasHistory) {
                statsContainer.style.display = 'block';
                document.getElementById('statNewFiles').textContent = newFiles.length;
                document.getElementById('statDeletedFiles').textContent = deletedFiles.length;
                document.getElementById('statUnchangedFiles').textContent = unchangedFiles.length;
                
                // æ˜¾ç¤º/éšè—"ä»…ä¸‹è½½æ–°å¢"æŒ‰é’®
                const newBtn = document.getElementById('generateNewBtn');
                if (newFiles.length > 0) {
                    newBtn.style.display = 'inline-flex';
                    document.getElementById('btnBadgeNew').textContent = newFiles.length;
                } else {
                    newBtn.style.display = 'none';
                }
            } else {
                statsContainer.style.display = 'none';
                document.getElementById('generateNewBtn').style.display = 'none';
            }
            
            // æ›´æ–°å…¨éƒ¨ä¸‹è½½æŒ‰é’®çš„æ•°é‡
            const activeFiles = mediaFiles.filter(f => !excludedPaths.has(f.path.join('/')));
            document.getElementById('btnBadgeAll').textContent = activeFiles.length;
        }

        // æ¸…é™¤å†å²æ–‡ä»¶è®°å½•
        function clearPreviousFiles() {
            previousFileSet = new Set();
            localStorage.removeItem('strmPreviousFiles');
            newFiles = [];
            deletedFiles = [];
            unchangedFiles = [];
            document.getElementById('incrementalStats').style.display = 'none';
            document.getElementById('generateNewBtn').style.display = 'none';
            showToast('å†å²è®°å½•å·²æ¸…é™¤', 'success');
            
            // é‡æ–°æ¸²æŸ“ç›®å½•æ ‘
            if (parsedData) {
                renderDirectoryTree();
            }
        }

        // ==================== ç›®å½•ç»“æ„é¢„è§ˆåŠŸèƒ½ ====================

        // æ¸²æŸ“ç›®å½•æ ‘ï¼ˆæ–°ç‰ˆæœ¬å¸¦å¤é€‰æ¡†ï¼‰
        function renderDirectoryTree() {
            const container = document.getElementById('directoryTreeContainer');
            container.innerHTML = '';
            
            if (!parsedData || !parsedData.children || parsedData.children.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 20px;">æš‚æ— æ•°æ®</div>';
                return;
            }
            
            // æ„å»ºæ ‘å½¢æ•°æ®
            treeData = buildTreeData(parsedData);
            
            // æ¸²æŸ“æ ‘
            for (const child of treeData.children) {
                const element = createTreeElement(child, 0);
                container.appendChild(element);
            }
            
            // æ›´æ–°ç»Ÿè®¡
            updateSelectionStats();
        }

        // æ„å»ºæ ‘å½¢æ•°æ®
        function buildTreeData(node, parentPath = '') {
            const result = {
                name: node.name,
                type: node.type,
                path: node.path ? node.path.join('/') : '',
                isExpanded: true,
                isExcluded: node.path ? excludedPaths.has(node.path.join('/')) : false,
                isFiltered: false,
                isNew: false,
                children: []
            };
            
            // æ£€æŸ¥æ˜¯å¦è¢«å¹¿å‘Šè¿‡æ»¤
            if (node.path) {
                const pathStr = node.path.join('/');
                result.isFiltered = containsAdKeyword(pathStr);
                result.isNew = newFiles.some(f => f.path.join('/') === pathStr);
            }
            
            if (node.children) {
                let mediaCount = 0;
                for (const child of node.children) {
                    const childData = buildTreeData(child, result.path);
                    result.children.push(childData);
                    if (childData.type === 'file' && child.isMedia && !childData.isFiltered) {
                        mediaCount++;
                    }
                    if (childData.type === 'folder') {
                        mediaCount += childData.mediaCount || 0;
                    }
                }
                result.mediaCount = mediaCount;
            }
            
            return result;
        }

        // åˆ›å»ºæ ‘å…ƒç´ 
        function createTreeElement(node, depth) {
            const div = document.createElement('div');
            div.className = 'tree-item';
            div.dataset.path = node.path;
            
            const header = document.createElement('div');
            header.className = 'tree-item-header';
            
            // å±•å¼€/æŠ˜å æŒ‰é’®
            const toggle = document.createElement('span');
            toggle.className = 'tree-item-toggle' + (node.children && node.children.length > 0 ? (node.isExpanded ? ' expanded' : '') : ' hidden');
            toggle.textContent = 'â–¶';
            toggle.onclick = (e) => {
                e.stopPropagation();
                toggleTreeItem(node, div);
            };
            header.appendChild(toggle);
            
            // å¤é€‰æ¡†
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.className = 'tree-item-checkbox';
            checkbox.checked = !node.isExcluded && !node.isFiltered;
            checkbox.disabled = node.isFiltered;
            checkbox.onchange = (e) => {
                e.stopPropagation();
                toggleExclusion(node, !e.target.checked, div);
            };
            header.appendChild(checkbox);
            
            // å›¾æ ‡
            const icon = document.createElement('span');
            icon.className = 'tree-item-icon';
            icon.textContent = node.type === 'folder' ? 'ğŸ“' : 'ğŸ¬';
            header.appendChild(icon);
            
            // åç§°
            const name = document.createElement('span');
            name.className = 'tree-item-name' + (node.type === 'folder' ? ' folder' : '') + (node.isExcluded || node.isFiltered ? ' excluded' : '');
            name.textContent = node.name;
            header.appendChild(name);
            
            // æ–‡ä»¶æ•°é‡ï¼ˆä»…æ–‡ä»¶å¤¹ï¼‰
            if (node.type === 'folder' && node.mediaCount !== undefined) {
                const count = document.createElement('span');
                count.className = 'tree-item-count';
                count.textContent = `${node.mediaCount} æ–‡ä»¶`;
                header.appendChild(count);
            }
            
            // çŠ¶æ€æ ‡ç­¾
            if (node.isNew) {
                const status = document.createElement('span');
                status.className = 'tree-item-status new';
                status.textContent = 'æ–°å¢';
                header.appendChild(status);
            }
            if (node.isFiltered) {
                const status = document.createElement('span');
                status.className = 'tree-item-status filtered';
                status.textContent = 'å·²è¿‡æ»¤';
                header.appendChild(status);
            }
            
            div.appendChild(header);
            
            // å­èŠ‚ç‚¹å®¹å™¨
            if (node.children && node.children.length > 0) {
                const childrenContainer = document.createElement('div');
                childrenContainer.className = 'tree-item-children' + (node.isExpanded ? ' expanded' : '');
                
                for (const child of node.children) {
                    const childElement = createTreeElement(child, depth + 1);
                    childrenContainer.appendChild(childElement);
                }
                
                div.appendChild(childrenContainer);
            }
            
            return div;
        }

        // åˆ‡æ¢æ ‘èŠ‚ç‚¹å±•å¼€/æŠ˜å 
        function toggleTreeItem(node, element) {
            node.isExpanded = !node.isExpanded;
            const toggle = element.querySelector('.tree-item-toggle');
            const children = element.querySelector('.tree-item-children');
            
            if (toggle) {
                toggle.classList.toggle('expanded', node.isExpanded);
            }
            if (children) {
                children.classList.toggle('expanded', node.isExpanded);
            }
        }

        // åˆ‡æ¢æ’é™¤çŠ¶æ€
        function toggleExclusion(node, excluded, element) {
            const pathStr = node.path;
            
            if (excluded) {
                excludedPaths.add(pathStr);
            } else {
                excludedPaths.delete(pathStr);
            }
            
            node.isExcluded = excluded;
            
            // æ›´æ–°å­èŠ‚ç‚¹
            if (node.children) {
                updateChildrenExclusion(node, excluded, element);
            }
            
            // æ›´æ–°UI
            const name = element.querySelector('.tree-item-name');
            if (name) {
                name.classList.toggle('excluded', excluded || node.isFiltered);
            }
            
            // ä¿å­˜æ’é™¤åˆ—è¡¨
            saveExcludedPaths();
            
            // æ›´æ–°ç»Ÿè®¡
            updateSelectionStats();
            calculateIncrementalChanges();
        }

        // æ›´æ–°å­èŠ‚ç‚¹æ’é™¤çŠ¶æ€
        function updateChildrenExclusion(node, excluded, element) {
            const childrenContainer = element.querySelector('.tree-item-children');
            if (!childrenContainer) return;
            
            const childElements = childrenContainer.querySelectorAll(':scope > .tree-item');
            node.children.forEach((child, index) => {
                if (childElements[index]) {
                    const checkbox = childElements[index].querySelector('.tree-item-checkbox');
                    const name = childElements[index].querySelector('.tree-item-name');
                    
                    if (!child.isFiltered) {
                        if (excluded) {
                            excludedPaths.add(child.path);
                        } else {
                            excludedPaths.delete(child.path);
                        }
                        child.isExcluded = excluded;
                        
                        if (checkbox) {
                            checkbox.checked = !excluded;
                        }
                        if (name) {
                            name.classList.toggle('excluded', excluded);
                        }
                    }
                    
                    if (child.children) {
                        updateChildrenExclusion(child, excluded, childElements[index]);
                    }
                }
            });
        }

        // ä¿å­˜æ’é™¤è·¯å¾„åˆ° localStorage
        function saveExcludedPaths() {
            localStorage.setItem('strmExcludedPaths', JSON.stringify([...excludedPaths]));
        }

        // ä» localStorage åŠ è½½æ’é™¤è·¯å¾„
        function loadExcludedPaths() {
            const saved = localStorage.getItem('strmExcludedPaths');
            if (saved) {
                try {
                    excludedPaths = new Set(JSON.parse(saved));
                } catch (e) {
                    excludedPaths = new Set();
                }
            }
        }

        // æ›´æ–°é€‰æ‹©ç»Ÿè®¡
        function updateSelectionStats() {
            let folderCount = 0;
            let fileCount = 0;
            let selectedCount = 0;
            
            function countNodes(node) {
                if (node.type === 'folder') {
                    folderCount++;
                    if (node.children) {
                        node.children.forEach(countNodes);
                    }
                } else if (node.type === 'file') {
                    fileCount++;
                    if (!node.isExcluded && !node.isFiltered) {
                        selectedCount++;
                    }
                }
            }
            
            if (treeData && treeData.children) {
                treeData.children.forEach(countNodes);
            }
            
            document.getElementById('selectedFolderCount').textContent = folderCount;
            document.getElementById('selectedFileCount').textContent = fileCount;
            document.getElementById('totalSelectedSize').textContent = selectedCount;
        }

        // å±•å¼€æ‰€æœ‰èŠ‚ç‚¹
        function expandAllTree() {
            const container = document.getElementById('directoryTreeContainer');
            container.querySelectorAll('.tree-item-toggle:not(.hidden)').forEach(toggle => {
                toggle.classList.add('expanded');
            });
            container.querySelectorAll('.tree-item-children').forEach(children => {
                children.classList.add('expanded');
            });
            
            // æ›´æ–°æ•°æ®
            function expandAll(node) {
                node.isExpanded = true;
                if (node.children) {
                    node.children.forEach(expandAll);
                }
            }
            if (treeData) {
                expandAll(treeData);
            }
        }

        // æŠ˜å æ‰€æœ‰èŠ‚ç‚¹
        function collapseAllTree() {
            const container = document.getElementById('directoryTreeContainer');
            container.querySelectorAll('.tree-item-toggle:not(.hidden)').forEach(toggle => {
                toggle.classList.remove('expanded');
            });
            container.querySelectorAll('.tree-item-children').forEach(children => {
                children.classList.remove('expanded');
            });
            
            // æ›´æ–°æ•°æ®
            function collapseAll(node) {
                node.isExpanded = false;
                if (node.children) {
                    node.children.forEach(collapseAll);
                }
            }
            if (treeData) {
                collapseAll(treeData);
            }
        }

        // å…¨é€‰æ‰€æœ‰é¡¹ç›®
        function selectAllItems() {
            excludedPaths.clear();
            saveExcludedPaths();
            renderDirectoryTree();
            calculateIncrementalChanges();
            showToast('å·²å…¨é€‰æ‰€æœ‰æ–‡ä»¶', 'success');
        }

        // å–æ¶ˆå…¨é€‰
        function deselectAllItems() {
            // æ·»åŠ æ‰€æœ‰åª’ä½“æ–‡ä»¶è·¯å¾„åˆ°æ’é™¤åˆ—è¡¨
            mediaFiles.forEach(file => {
                excludedPaths.add(file.path.join('/'));
            });
            saveExcludedPaths();
            renderDirectoryTree();
            calculateIncrementalChanges();
            showToast('å·²å–æ¶ˆé€‰æ‹©æ‰€æœ‰æ–‡ä»¶', 'info');
        }

        // ==================== WebDAV åŠŸèƒ½ ====================

        // åˆ‡æ¢ WebDAV é¢æ¿å±•å¼€/æ”¶èµ·
        function toggleWebdavPanel() {
            const panel = document.getElementById('webdavPanel');
            panel.classList.toggle('expanded');
            // ä¿å­˜å±•å¼€çŠ¶æ€åˆ°localStorage
            localStorage.setItem('strm_webdav_panelExpanded', panel.classList.contains('expanded'));
        }

        // æ˜¾ç¤º WebDAV æ¶ˆæ¯
        function showWebdavMessage(message, type) {
            const msgEl = document.getElementById('webdavMessage');
            msgEl.textContent = message;
            msgEl.className = `webdav-message visible ${type}`;
        }

        // éšè— WebDAV æ¶ˆæ¯
        function hideWebdavMessage() {
            const msgEl = document.getElementById('webdavMessage');
            msgEl.className = 'webdav-message';
        }

        // æ›´æ–° WebDAV çŠ¶æ€
        function updateWebdavStatus(status, type) {
            const statusEl = document.getElementById('webdavStatus');
            statusEl.textContent = status;
            statusEl.className = `collapsible-status ${type || ''}`;
        }

        // ä» WebDAV è·å–æ–‡ä»¶
        async function fetchFromWebdav() {
            const url = document.getElementById('webdavUrl').value.trim();
            const user = document.getElementById('webdavUser').value.trim();
            const pass = document.getElementById('webdavPass').value;
            const filePath = document.getElementById('webdavFilePath').value.trim();
            
            // éªŒè¯è¾“å…¥
            if (!url) {
                showWebdavMessage('è¯·è¾“å…¥ WebDAV æœåŠ¡å™¨ URL', 'error');
                return;
            }
            if (!filePath) {
                showWebdavMessage('è¯·è¾“å…¥ txt æ–‡ä»¶è·¯å¾„', 'error');
                return;
            }
            
            // æ„å»ºå®Œæ•´ URL
            let fullUrl = url.replace(/\/+$/, '');
            if (!filePath.startsWith('/')) {
                fullUrl += '/';
            }
            fullUrl += filePath;
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const btn = document.getElementById('webdavConnectBtn');
            const btnText = document.getElementById('webdavBtnText');
            btn.disabled = true;
            btnText.innerHTML = '<span class="spinner"></span> è¿æ¥ä¸­...';
            hideWebdavMessage();
            updateWebdavStatus('è¿æ¥ä¸­...', '');
            
            try {
                // æ„å»ºè¯·æ±‚å¤´
                const headers = {};
                if (user) {
                    const credentials = btoa(`${user}:${pass}`);
                    headers['Authorization'] = `Basic ${credentials}`;
                }
                
                // å‘é€ GET è¯·æ±‚è·å–æ–‡ä»¶å†…å®¹
                const response = await fetch(fullUrl, {
                    method: 'GET',
                    headers: headers,
                    mode: 'cors'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                // è·å–æ–‡ä»¶å†…å®¹
                const arrayBuffer = await response.arrayBuffer();
                const uint8Array = new Uint8Array(arrayBuffer);
                
                // æ£€æµ‹ç¼–ç 
                let content;
                if (uint8Array.length >= 2 && uint8Array[0] === 0xFF && uint8Array[1] === 0xFE) {
                    const decoder = new TextDecoder('utf-16le');
                    content = decoder.decode(arrayBuffer);
                } else if (uint8Array.length >= 2 && uint8Array[0] === 0xFE && uint8Array[1] === 0xFF) {
                    const decoder = new TextDecoder('utf-16be');
                    content = decoder.decode(arrayBuffer);
                } else if (uint8Array.length >= 3 && uint8Array[0] === 0xEF && uint8Array[1] === 0xBB && uint8Array[2] === 0xBF) {
                    const decoder = new TextDecoder('utf-8');
                    content = decoder.decode(arrayBuffer);
                } else {
                    const decoder = new TextDecoder('utf-8');
                    content = decoder.decode(arrayBuffer);
                }
                
                // æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
                const fileName = filePath.split('/').pop() || 'webdav_file.txt';
                document.getElementById('fileName').textContent = fileName;
                document.getElementById('fileSize').textContent = formatFileSize(arrayBuffer.byteLength);
                document.getElementById('fileInfo').classList.add('visible');
                
                // è§£æç›®å½•æ ‘
                parseDirectoryTree(content);
                
                showWebdavMessage('æ–‡ä»¶è·å–æˆåŠŸï¼', 'success');
                updateWebdavStatus('å·²è¿æ¥', 'connected');
                showToast('WebDAV æ–‡ä»¶è·å–æˆåŠŸ', 'success');
                
            } catch (error) {
                console.error('WebDAV é”™è¯¯:', error);
                let errorMsg = error.message;
                
                // å¤„ç†å¸¸è§é”™è¯¯
                if (error.name === 'TypeError' && error.message.includes('Failed to fetch')) {
                    errorMsg = 'CORS é”™è¯¯ï¼šæ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ã€‚è¯·æ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦å…è®¸è·¨åŸŸè®¿é—®ï¼Œæˆ–ä½¿ç”¨ CORS ä»£ç†/æµè§ˆå™¨æ‰©å±•ã€‚';
                }
                
                showWebdavMessage(errorMsg, 'error');
                updateWebdavStatus('è¿æ¥å¤±è´¥', 'error');
            } finally {
                btn.disabled = false;
                btnText.textContent = 'è¿æ¥å¹¶è·å–';
            }
        }

        // ä¿å­˜ WebDAV é…ç½®åˆ° localStorageï¼ˆè‡ªåŠ¨è§¦å‘ï¼‰
        function autoSaveWebdavConfig() {
            localStorage.setItem('strm_webdav_url', document.getElementById('webdavUrl').value.trim());
            localStorage.setItem('strm_webdav_user', document.getElementById('webdavUser').value.trim());
            localStorage.setItem('strm_webdav_filePath', document.getElementById('webdavFilePath').value.trim());
            
            // åªæœ‰åœ¨å‹¾é€‰äº†"è®°ä½å¯†ç "æ—¶æ‰ä¿å­˜å¯†ç 
            const rememberPassword = document.getElementById('rememberPassword').checked;
            localStorage.setItem('strm_webdav_rememberPass', rememberPassword);
            if (rememberPassword) {
                localStorage.setItem('strm_webdav_pass', document.getElementById('webdavPass').value);
            } else {
                localStorage.removeItem('strm_webdav_pass');
            }
        }

        // æ‰‹åŠ¨ä¿å­˜ WebDAV é…ç½®æŒ‰é’®
        function saveWebdavConfig() {
            autoSaveWebdavConfig();
            const rememberPassword = document.getElementById('rememberPassword').checked;
            if (rememberPassword) {
                showToast('WebDAV é…ç½®å·²ä¿å­˜ï¼ˆåŒ…å«å¯†ç ï¼‰', 'success');
            } else {
                showToast('WebDAV é…ç½®å·²ä¿å­˜ï¼ˆå¯†ç æœªä¿å­˜ï¼‰', 'success');
            }
        }

        // ä» localStorage åŠ è½½ WebDAV é…ç½®
        function loadWebdavConfig() {
            // åŠ è½½URL
            const url = localStorage.getItem('strm_webdav_url');
            if (url) document.getElementById('webdavUrl').value = url;
            
            // åŠ è½½ç”¨æˆ·å
            const user = localStorage.getItem('strm_webdav_user');
            if (user) document.getElementById('webdavUser').value = user;
            
            // åŠ è½½æ–‡ä»¶è·¯å¾„
            const filePath = localStorage.getItem('strm_webdav_filePath');
            if (filePath) document.getElementById('webdavFilePath').value = filePath;
            
            // åŠ è½½è®°ä½å¯†ç é€‰é¡¹
            const rememberPass = localStorage.getItem('strm_webdav_rememberPass') === 'true';
            document.getElementById('rememberPassword').checked = rememberPass;
            
            // å¦‚æœå‹¾é€‰äº†è®°ä½å¯†ç ï¼ŒåŠ è½½å¯†ç 
            if (rememberPass) {
                const pass = localStorage.getItem('strm_webdav_pass');
                if (pass) document.getElementById('webdavPass').value = pass;
            }
            
            // åŠ è½½é¢æ¿å±•å¼€çŠ¶æ€
            const panelExpanded = localStorage.getItem('strm_webdav_panelExpanded') === 'true';
            if (panelExpanded) {
                document.getElementById('webdavPanel').classList.add('expanded');
            }
            
            // å…¼å®¹æ—§ç‰ˆé…ç½®ï¼ˆstrmWebdavConfigï¼‰
            const oldConfig = localStorage.getItem('strmWebdavConfig');
            if (oldConfig && !url) {
                try {
                    const config = JSON.parse(oldConfig);
                    if (config.url) document.getElementById('webdavUrl').value = config.url;
                    if (config.user) document.getElementById('webdavUser').value = config.user;
                    if (config.filePath) document.getElementById('webdavFilePath').value = config.filePath;
                    // è¿ç§»åˆ°æ–°æ ¼å¼
                    autoSaveWebdavConfig();
                    // åˆ é™¤æ—§é…ç½®
                    localStorage.removeItem('strmWebdavConfig');
                } catch (e) {
                    console.error('åŠ è½½æ—§ç‰ˆ WebDAV é…ç½®å¤±è´¥:', e);
                }
            }
        }

        // ä¸ºWebDAVè¾“å…¥æ¡†æ·»åŠ è‡ªåŠ¨ä¿å­˜ç›‘å¬å™¨
        function initWebdavAutoSave() {
            document.getElementById('webdavUrl').addEventListener('input', autoSaveWebdavConfig);
            document.getElementById('webdavUser').addEventListener('input', autoSaveWebdavConfig);
            document.getElementById('webdavPass').addEventListener('input', autoSaveWebdavConfig);
            document.getElementById('webdavFilePath').addEventListener('input', autoSaveWebdavConfig);
            document.getElementById('rememberPassword').addEventListener('change', autoSaveWebdavConfig);
        }

        // ==================== WebDAV ç›®å½•æµè§ˆåŠŸèƒ½ ====================

        // å½“å‰æµè§ˆè·¯å¾„
        let currentBrowsePath = '/';

        // æ¨¡æ€æ¡†æ‹–åŠ¨å’Œç¼©æ”¾çŠ¶æ€
        let modalDragState = {
            isDragging: false,
            isResizing: false,
            resizeDirection: null,
            startX: 0,
            startY: 0,
            startLeft: 0,
            startTop: 0,
            startWidth: 0,
            startHeight: 0
        };

        // æ¨¡æ€æ¡†æœ€å°/æœ€å¤§å°ºå¯¸
        const MODAL_MIN_WIDTH = 400;
        const MODAL_MIN_HEIGHT = 300;
        const MODAL_MAX_WIDTH_PERCENT = 0.9;
        const MODAL_MAX_HEIGHT_PERCENT = 0.9;

        // é»˜è®¤æ¨¡æ€æ¡†å°ºå¯¸
        const DEFAULT_MODAL_WIDTH = 600;
        const DEFAULT_MODAL_HEIGHT = 500;

        // æ‰“å¼€ç›®å½•æµè§ˆå™¨
        async function openWebdavBrowser() {
            const url = document.getElementById('webdavUrl').value.trim();
            
            if (!url) {
                showWebdavMessage('è¯·å…ˆè¾“å…¥ WebDAV æœåŠ¡å™¨ URL', 'error');
                return;
            }
            
            const browser = document.getElementById('webdavBrowser');
            const overlay = document.getElementById('webdavModalOverlay');
            
            // æ¢å¤ä¿å­˜çš„å°ºå¯¸å’Œä½ç½®
            restoreModalState(browser);
            
            // æ˜¾ç¤ºé®ç½©å±‚å’Œæ¨¡æ€æ¡†
            overlay.classList.add('visible');
            browser.classList.add('visible');
            
            // ä»æ ¹ç›®å½•å¼€å§‹æµè§ˆ
            currentBrowsePath = '/';
            await loadWebdavDirectory('/');
        }

        // å…³é—­ç›®å½•æµè§ˆå™¨
        function closeWebdavBrowser() {
            const browser = document.getElementById('webdavBrowser');
            const overlay = document.getElementById('webdavModalOverlay');
            
            // ä¿å­˜å½“å‰å°ºå¯¸å’Œä½ç½®
            saveModalState(browser);
            
            // éšè—æ¨¡æ€æ¡†å’Œé®ç½©å±‚
            browser.classList.remove('visible');
            overlay.classList.remove('visible');
        }

        // ç‚¹å‡»é®ç½©å±‚å…³é—­æ¨¡æ€æ¡†
        function handleOverlayClick(event) {
            if (event.target === event.currentTarget) {
                closeWebdavBrowser();
            }
        }

        // ä¿å­˜æ¨¡æ€æ¡†çŠ¶æ€åˆ°localStorage
        function saveModalState(modal) {
            const rect = modal.getBoundingClientRect();
            const state = {
                width: modal.offsetWidth,
                height: modal.offsetHeight,
                // ä¿å­˜ç›¸å¯¹äºè§†å£ä¸­å¿ƒçš„åç§»
                offsetX: rect.left + rect.width / 2 - window.innerWidth / 2,
                offsetY: rect.top + rect.height / 2 - window.innerHeight / 2
            };
            localStorage.setItem('strm_webdav_modal_state', JSON.stringify(state));
        }

        // ä»localStorageæ¢å¤æ¨¡æ€æ¡†çŠ¶æ€
        function restoreModalState(modal) {
            const savedState = localStorage.getItem('strm_webdav_modal_state');
            
            if (savedState) {
                try {
                    const state = JSON.parse(savedState);
                    
                    // é™åˆ¶å°ºå¯¸åœ¨å…è®¸èŒƒå›´å†…
                    const maxWidth = window.innerWidth * MODAL_MAX_WIDTH_PERCENT;
                    const maxHeight = window.innerHeight * MODAL_MAX_HEIGHT_PERCENT;
                    const width = Math.min(Math.max(state.width, MODAL_MIN_WIDTH), maxWidth);
                    const height = Math.min(Math.max(state.height, MODAL_MIN_HEIGHT), maxHeight);
                    
                    modal.style.width = width + 'px';
                    modal.style.height = height + 'px';
                    
                    // æ¢å¤ä½ç½®ï¼ˆå¦‚æœæœ‰ä¿å­˜çš„åç§»ï¼‰
                    if (state.offsetX !== undefined && state.offsetY !== undefined) {
                        // ç¡®ä¿æ¨¡æ€æ¡†åœ¨è§†å£å†…
                        const halfWidth = width / 2;
                        const halfHeight = height / 2;
                        const maxOffsetX = window.innerWidth / 2 - halfWidth;
                        const maxOffsetY = window.innerHeight / 2 - halfHeight;
                        
                        const offsetX = Math.min(Math.max(state.offsetX, -maxOffsetX), maxOffsetX);
                        const offsetY = Math.min(Math.max(state.offsetY, -maxOffsetY), maxOffsetY);
                        
                        modal.style.left = `calc(50% + ${offsetX}px)`;
                        modal.style.top = `calc(50% + ${offsetY}px)`;
                    }
                } catch (e) {
                    console.error('æ¢å¤æ¨¡æ€æ¡†çŠ¶æ€å¤±è´¥:', e);
                    resetModalState(modal);
                }
            } else {
                resetModalState(modal);
            }
        }

        // é‡ç½®æ¨¡æ€æ¡†åˆ°é»˜è®¤çŠ¶æ€
        function resetModalState(modal) {
            modal.style.width = Math.min(DEFAULT_MODAL_WIDTH, window.innerWidth * 0.9) + 'px';
            modal.style.height = Math.min(DEFAULT_MODAL_HEIGHT, window.innerHeight * 0.8) + 'px';
            modal.style.left = '50%';
            modal.style.top = '50%';
        }

        // åˆå§‹åŒ–æ¨¡æ€æ¡†æ‹–åŠ¨åŠŸèƒ½
        function initModalDrag() {
            const header = document.getElementById('webdavBrowserHeader');
            const modal = document.getElementById('webdavBrowser');
            
            header.addEventListener('mousedown', startDrag);
            header.addEventListener('touchstart', startDrag, { passive: false });
            
            function startDrag(e) {
                // å¦‚æœç‚¹å‡»çš„æ˜¯å…³é—­æŒ‰é’®ï¼Œä¸å¤„ç†æ‹–åŠ¨
                if (e.target.closest('.webdav-browser-close')) {
                    return;
                }
                
                e.preventDefault();
                
                const clientX = e.type === 'touchstart' ? e.touches[0].clientX : e.clientX;
                const clientY = e.type === 'touchstart' ? e.touches[0].clientY : e.clientY;
                
                const rect = modal.getBoundingClientRect();
                
                modalDragState.isDragging = true;
                modalDragState.startX = clientX;
                modalDragState.startY = clientY;
                modalDragState.startLeft = rect.left + rect.width / 2;
                modalDragState.startTop = rect.top + rect.height / 2;
                
                modal.classList.add('dragging');
                
                document.addEventListener('mousemove', onDrag);
                document.addEventListener('mouseup', stopDrag);
                document.addEventListener('touchmove', onDrag, { passive: false });
                document.addEventListener('touchend', stopDrag);
            }
            
            function onDrag(e) {
                if (!modalDragState.isDragging) return;
                
                e.preventDefault();
                
                const clientX = e.type === 'touchmove' ? e.touches[0].clientX : e.clientX;
                const clientY = e.type === 'touchmove' ? e.touches[0].clientY : e.clientY;
                
                const deltaX = clientX - modalDragState.startX;
                const deltaY = clientY - modalDragState.startY;
                
                let newCenterX = modalDragState.startLeft + deltaX;
                let newCenterY = modalDragState.startTop + deltaY;
                
                // é™åˆ¶åœ¨è§†å£å†…
                const halfWidth = modal.offsetWidth / 2;
                const halfHeight = modal.offsetHeight / 2;
                
                newCenterX = Math.max(halfWidth, Math.min(window.innerWidth - halfWidth, newCenterX));
                newCenterY = Math.max(halfHeight, Math.min(window.innerHeight - halfHeight, newCenterY));
                
                modal.style.left = newCenterX + 'px';
                modal.style.top = newCenterY + 'px';
                modal.style.transform = 'translate(-50%, -50%)';
            }
            
            function stopDrag() {
                if (!modalDragState.isDragging) return;
                
                modalDragState.isDragging = false;
                modal.classList.remove('dragging');
                
                document.removeEventListener('mousemove', onDrag);
                document.removeEventListener('mouseup', stopDrag);
                document.removeEventListener('touchmove', onDrag);
                document.removeEventListener('touchend', stopDrag);
            }
        }

        // åˆå§‹åŒ–æ¨¡æ€æ¡†ç¼©æ”¾åŠŸèƒ½
        function initModalResize() {
            const modal = document.getElementById('webdavBrowser');
            const handles = modal.querySelectorAll('.webdav-resize-handle');
            
            handles.forEach(handle => {
                handle.addEventListener('mousedown', startResize);
                handle.addEventListener('touchstart', startResize, { passive: false });
            });
            
            function startResize(e) {
                e.preventDefault();
                e.stopPropagation();
                
                const clientX = e.type === 'touchstart' ? e.touches[0].clientX : e.clientX;
                const clientY = e.type === 'touchstart' ? e.touches[0].clientY : e.clientY;
                
                const rect = modal.getBoundingClientRect();
                
                modalDragState.isResizing = true;
                modalDragState.resizeDirection = e.target.dataset.direction;
                modalDragState.startX = clientX;
                modalDragState.startY = clientY;
                modalDragState.startWidth = rect.width;
                modalDragState.startHeight = rect.height;
                modalDragState.startLeft = rect.left + rect.width / 2;
                modalDragState.startTop = rect.top + rect.height / 2;
                
                modal.classList.add('resizing');
                
                document.addEventListener('mousemove', onResize);
                document.addEventListener('mouseup', stopResize);
                document.addEventListener('touchmove', onResize, { passive: false });
                document.addEventListener('touchend', stopResize);
            }
            
            function onResize(e) {
                if (!modalDragState.isResizing) return;
                
                e.preventDefault();
                
                const clientX = e.type === 'touchmove' ? e.touches[0].clientX : e.clientX;
                const clientY = e.type === 'touchmove' ? e.touches[0].clientY : e.clientY;
                
                const deltaX = clientX - modalDragState.startX;
                const deltaY = clientY - modalDragState.startY;
                
                const dir = modalDragState.resizeDirection;
                const maxWidth = window.innerWidth * MODAL_MAX_WIDTH_PERCENT;
                const maxHeight = window.innerHeight * MODAL_MAX_HEIGHT_PERCENT;
                
                let newWidth = modalDragState.startWidth;
                let newHeight = modalDragState.startHeight;
                let newCenterX = modalDragState.startLeft;
                let newCenterY = modalDragState.startTop;
                
                // å¤„ç†ä¸œè¥¿æ–¹å‘ç¼©æ”¾
                if (dir.includes('e')) {
                    newWidth = Math.min(Math.max(modalDragState.startWidth + deltaX, MODAL_MIN_WIDTH), maxWidth);
                    newCenterX = modalDragState.startLeft + (newWidth - modalDragState.startWidth) / 2;
                }
                if (dir.includes('w')) {
                    newWidth = Math.min(Math.max(modalDragState.startWidth - deltaX, MODAL_MIN_WIDTH), maxWidth);
                    newCenterX = modalDragState.startLeft - (newWidth - modalDragState.startWidth) / 2;
                }
                
                // å¤„ç†å—åŒ—æ–¹å‘ç¼©æ”¾
                if (dir.includes('s')) {
                    newHeight = Math.min(Math.max(modalDragState.startHeight + deltaY, MODAL_MIN_HEIGHT), maxHeight);
                    newCenterY = modalDragState.startTop + (newHeight - modalDragState.startHeight) / 2;
                }
                if (dir.includes('n')) {
                    newHeight = Math.min(Math.max(modalDragState.startHeight - deltaY, MODAL_MIN_HEIGHT), maxHeight);
                    newCenterY = modalDragState.startTop - (newHeight - modalDragState.startHeight) / 2;
                }
                
                // ç¡®ä¿æ¨¡æ€æ¡†åœ¨è§†å£å†…
                const halfWidth = newWidth / 2;
                const halfHeight = newHeight / 2;
                
                newCenterX = Math.max(halfWidth, Math.min(window.innerWidth - halfWidth, newCenterX));
                newCenterY = Math.max(halfHeight, Math.min(window.innerHeight - halfHeight, newCenterY));
                
                modal.style.width = newWidth + 'px';
                modal.style.height = newHeight + 'px';
                modal.style.left = newCenterX + 'px';
                modal.style.top = newCenterY + 'px';
                modal.style.transform = 'translate(-50%, -50%)';
            }
            
            function stopResize() {
                if (!modalDragState.isResizing) return;
                
                modalDragState.isResizing = false;
                modalDragState.resizeDirection = null;
                modal.classList.remove('resizing');
                
                document.removeEventListener('mousemove', onResize);
                document.removeEventListener('mouseup', stopResize);
                document.removeEventListener('touchmove', onResize);
                document.removeEventListener('touchend', stopResize);
            }
        }

        // ESCé”®å…³é—­æ¨¡æ€æ¡†
        function handleKeyDown(e) {
            if (e.key === 'Escape') {
                const browser = document.getElementById('webdavBrowser');
                if (browser.classList.contains('visible')) {
                    closeWebdavBrowser();
                }
            }
        }

        // åŠ è½½WebDAVç›®å½•å†…å®¹
        async function loadWebdavDirectory(path) {
            const url = document.getElementById('webdavUrl').value.trim();
            const user = document.getElementById('webdavUser').value.trim();
            const pass = document.getElementById('webdavPass').value;
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const loadingEl = document.getElementById('webdavBrowserLoading');
            const emptyEl = document.getElementById('webdavBrowserEmpty');
            const listEl = document.getElementById('webdavFileList');
            
            loadingEl.style.display = 'flex';
            emptyEl.style.display = 'none';
            listEl.style.display = 'none';
            
            // æ›´æ–°å½“å‰è·¯å¾„
            currentBrowsePath = path;
            
            // æ›´æ–°é¢åŒ…å±‘å¯¼èˆª
            updateBreadcrumb(path);
            
            try {
                // æ„å»ºå®Œæ•´ URL
                let fullUrl = url.replace(/\/+$/, '');
                if (path !== '/') {
                    fullUrl += path;
                }
                
                // ç¡®ä¿URLä»¥æ–œæ ç»“å°¾ï¼ˆç›®å½•ï¼‰
                if (!fullUrl.endsWith('/')) {
                    fullUrl += '/';
                }
                
                // æ„å»ºè¯·æ±‚å¤´
                const headers = {
                    'Depth': '1',
                    'Content-Type': 'application/xml'
                };
                
                if (user) {
                    const credentials = btoa(`${user}:${pass}`);
                    headers['Authorization'] = `Basic ${credentials}`;
                }
                
                // å‘é€ PROPFIND è¯·æ±‚
                const response = await fetch(fullUrl, {
                    method: 'PROPFIND',
                    headers: headers,
                    mode: 'cors',
                    body: '<?xml version="1.0" encoding="utf-8"?><propfind xmlns="DAV:"><prop><displayname/><resourcetype/><getcontentlength/><getlastmodified/></prop></propfind>'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                // è§£æå“åº”
                const xmlText = await response.text();
                const items = parseWebdavResponse(xmlText, fullUrl, path);
                
                // è¿‡æ»¤å’Œæ’åº
                const filteredItems = filterAndSortItems(items);
                
                // æ˜¾ç¤ºç»“æœ
                loadingEl.style.display = 'none';
                
                if (filteredItems.length === 0) {
                    emptyEl.style.display = 'flex';
                    listEl.style.display = 'none';
                } else {
                    emptyEl.style.display = 'none';
                    listEl.style.display = 'block';
                    renderFileList(filteredItems);
                }
                
            } catch (error) {
                console.error('WebDAV ç›®å½•æµè§ˆé”™è¯¯:', error);
                loadingEl.style.display = 'none';
                emptyEl.style.display = 'flex';
                emptyEl.innerHTML = `
                    <div class="webdav-browser-empty-icon">âŒ</div>
                    <span>åŠ è½½å¤±è´¥: ${error.message}</span>
                `;
            }
        }

        // è§£æWebDAV XMLå“åº”
        function parseWebdavResponse(xmlText, baseUrl, currentPath) {
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(xmlText, 'text/xml');
            
            const items = [];
            const responses = xmlDoc.getElementsByTagNameNS('DAV:', 'response');
            
            // è·å–åŸºç¡€URLçš„è·¯å¾„éƒ¨åˆ†ï¼Œç”¨äºè¿‡æ»¤å½“å‰ç›®å½•æœ¬èº«
            const baseUrlObj = new URL(baseUrl);
            const basePath = baseUrlObj.pathname;
            
            for (const response of responses) {
                const hrefEl = response.getElementsByTagNameNS('DAV:', 'href')[0];
                if (!hrefEl) continue;
                
                let href = hrefEl.textContent;
                
                // è§£ç URLç¼–ç çš„è·¯å¾„
                try {
                    href = decodeURIComponent(href);
                } catch (e) {
                    // å¦‚æœè§£ç å¤±è´¥ï¼Œä½¿ç”¨åŸå§‹å€¼
                }
                
                // è·³è¿‡å½“å‰ç›®å½•æœ¬èº«
                const normalizedHref = href.replace(/\/+$/, '');
                const normalizedBase = basePath.replace(/\/+$/, '');
                if (normalizedHref === normalizedBase || normalizedHref === '') {
                    continue;
                }
                
                // è·å–èµ„æºç±»å‹
                const resourceType = response.getElementsByTagNameNS('DAV:', 'resourcetype')[0];
                const isCollection = resourceType && resourceType.getElementsByTagNameNS('DAV:', 'collection').length > 0;
                
                // è·å–æ˜¾ç¤ºåç§°
                let displayName = '';
                const displayNameEl = response.getElementsByTagNameNS('DAV:', 'displayname')[0];
                if (displayNameEl && displayNameEl.textContent) {
                    displayName = displayNameEl.textContent;
                } else {
                    // ä»è·¯å¾„ä¸­æå–åç§°
                    const pathParts = href.replace(/\/+$/, '').split('/');
                    displayName = pathParts[pathParts.length - 1] || '';
                }
                
                if (!displayName) continue;
                
                // è·å–æ–‡ä»¶å¤§å°
                let size = 0;
                const sizeEl = response.getElementsByTagNameNS('DAV:', 'getcontentlength')[0];
                if (sizeEl && sizeEl.textContent) {
                    size = parseInt(sizeEl.textContent, 10) || 0;
                }
                
                // è·å–æœ€åä¿®æ”¹æ—¶ï¿½ï¿½ï¿½
                let lastModified = '';
                const modifiedEl = response.getElementsByTagNameNS('DAV:', 'getlastmodified')[0];
                if (modifiedEl && modifiedEl.textContent) {
                    try {
                        const date = new Date(modifiedEl.textContent);
                        lastModified = date.toLocaleDateString('zh-CN');
                    } catch (e) {
                        lastModified = modifiedEl.textContent;
                    }
                }
                
                // æ„å»ºå®Œæ•´è·¯å¾„
                let itemPath = currentPath;
                if (!itemPath.endsWith('/')) {
                    itemPath += '/';
                }
                itemPath += displayName;
                
                items.push({
                    name: displayName,
                    path: itemPath,
                    isDirectory: isCollection,
                    size: size,
                    lastModified: lastModified
                });
            }
            
            return items;
        }

        // è¿‡æ»¤å’Œæ’åºé¡¹ç›®ï¼ˆåªæ˜¾ç¤ºæ–‡ä»¶å¤¹å’Œtxtæ–‡ä»¶ï¼‰
        function filterAndSortItems(items) {
            // è¿‡æ»¤ï¼šåªä¿ç•™æ–‡ä»¶å¤¹å’Œtxtæ–‡ä»¶
            const filtered = items.filter(item => {
                if (item.isDirectory) {
                    return true;
                }
                // åªæ˜¾ç¤º.txtæ–‡ä»¶
                return item.name.toLowerCase().endsWith('.txt');
            });
            
            // æ’åºï¼šæ–‡ä»¶å¤¹åœ¨å‰ï¼Œç„¶åæŒ‰åç§°æ’åº
            filtered.sort((a, b) => {
                // æ–‡ä»¶å¤¹ä¼˜å…ˆ
                if (a.isDirectory && !b.isDirectory) return -1;
                if (!a.isDirectory && b.isDirectory) return 1;
                // æŒ‰åç§°æ’åº
                return a.name.localeCompare(b.name, 'zh-CN');
            });
            
            return filtered;
        }

        // æ¸²æŸ“æ–‡ä»¶åˆ—è¡¨
        function renderFileList(items) {
            const listEl = document.getElementById('webdavFileList');
            listEl.innerHTML = '';
            
            for (const item of items) {
                const li = document.createElement('li');
                li.className = 'webdav-file-item';
                li.dataset.path = item.path;
                li.dataset.isDirectory = item.isDirectory;
                
                const icon = item.isDirectory ? 'ğŸ“' : 'ğŸ“„';
                const meta = item.isDirectory 
                    ? 'æ–‡ä»¶å¤¹' 
                    : `${formatFileSize(item.size)} â€¢ ${item.lastModified || ''}`;
                const arrow = item.isDirectory ? '<span class="webdav-file-arrow">â€º</span>' : '';
                
                li.innerHTML = `
                    <span class="webdav-file-icon">${icon}</span>
                    <div class="webdav-file-info">
                        <div class="webdav-file-name">${escapeHtml(item.name)}</div>
                        <div class="webdav-file-meta">${meta}</div>
                    </div>
                    ${arrow}
                `;
                
                li.addEventListener('click', () => handleFileItemClick(item));
                listEl.appendChild(li);
            }
        }

        // æ›´æ–°é¢åŒ…å±‘å¯¼èˆª
        function updateBreadcrumb(path) {
            const breadcrumb = document.getElementById('webdavBreadcrumb');
            breadcrumb.innerHTML = '';
            
            // æ·»åŠ æ ¹ç›®å½•
            const rootItem = document.createElement('span');
            rootItem.className = 'webdav-breadcrumb-item' + (path === '/' ? ' active' : '');
            rootItem.innerHTML = 'ğŸ“ æ ¹ç›®å½•';
            rootItem.dataset.path = '/';
            if (path !== '/') {
                rootItem.addEventListener('click', () => loadWebdavDirectory('/'));
            }
            breadcrumb.appendChild(rootItem);
            
            // è§£æè·¯å¾„å¹¶æ·»åŠ å„çº§ç›®å½•
            if (path !== '/') {
                const parts = path.split('/').filter(p => p);
                let currentPath = '';
                
                for (let i = 0; i < parts.length; i++) {
                    const part = parts[i];
                    currentPath += '/' + part;
                    
                    // æ·»åŠ åˆ†éš”ç¬¦
                    const separator = document.createElement('span');
                    separator.className = 'webdav-breadcrumb-separator';
                    separator.textContent = 'â€º';
                    breadcrumb.appendChild(separator);
                    
                    // æ·»åŠ ç›®å½•é¡¹
                    const item = document.createElement('span');
                    const isLast = i === parts.length - 1;
                    item.className = 'webdav-breadcrumb-item' + (isLast ? ' active' : '');
                    item.textContent = part;
                    item.dataset.path = currentPath;
                    
                    if (!isLast) {
                        const pathToLoad = currentPath;
                        item.addEventListener('click', () => loadWebdavDirectory(pathToLoad));
                    }
                    
                    breadcrumb.appendChild(item);
                }
            }
        }

        // å¤„ç†æ–‡ä»¶/æ–‡ä»¶å¤¹ç‚¹å‡»
        async function handleFileItemClick(item) {
            if (item.isDirectory) {
                // è¿›å…¥æ–‡ä»¶å¤¹
                await loadWebdavDirectory(item.path);
            } else {
                // é€‰æ‹©txtæ–‡ä»¶
                selectTxtFile(item.path);
            }
        }

        // é€‰æ‹©txtæ–‡ä»¶
        async function selectTxtFile(filePath) {
            // å¡«å……æ–‡ä»¶è·¯å¾„
            document.getElementById('webdavFilePath').value = filePath;
            
            // å…³é—­æµè§ˆå™¨
            closeWebdavBrowser();
            
            // æ˜¾ç¤ºé€‰ä¸­æç¤º
            showToast(`å·²é€‰æ‹©æ–‡ä»¶: ${filePath.split('/').pop()}`, 'success');
            
            // è‡ªåŠ¨è·å–æ–‡ä»¶å†…å®¹
            await fetchFromWebdav();
        }

        // ==================== localStorage é…ç½®åŠ è½½ ====================

        // åŠ è½½URLå‰ç¼€é…ç½®
        function loadUrlPrefixConfig() {
            const savedPrefix = localStorage.getItem('strm_urlPrefix');
            if (savedPrefix !== null) {
                document.getElementById('urlPrefix').value = savedPrefix;
            }
        }

        // åŠ è½½URLç¼–ç å¼€å…³çŠ¶æ€
        function loadUrlEncodeConfig() {
            const savedEncode = localStorage.getItem('strm_urlEncode');
            const toggle = document.getElementById('urlEncodeToggle');
            const toggleStatus = document.getElementById('toggleStatus');
            
            if (savedEncode !== null) {
                const isChecked = savedEncode === 'true';
                toggle.checked = isChecked;
                if (isChecked) {
                    toggleStatus.textContent = 'å¼€å¯';
                    toggleStatus.classList.add('active');
                } else {
                    toggleStatus.textContent = 'å…³é—­';
                    toggleStatus.classList.remove('active');
                }
            }
        }

        // ==================== åˆå§‹åŒ– ====================

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            initTheme();
            initDropZone();
            
            // åŠ è½½ä¿å­˜çš„åç¼€åé…ç½®
            loadExtensionsFromStorage();
            renderExtensionTags();
            
            // åŠ è½½ä¿å­˜çš„å¹¿å‘Šå…³é”®è¯é…ç½®
            loadAdKeywordsFromStorage();
            renderAdKeywordTags();
            initAdFilterToggle();
            
            // åŠ è½½æ’é™¤è·¯å¾„é…ç½®
            loadExcludedPaths();
            
            // åŠ è½½å†å²æ–‡ä»¶åˆ—è¡¨ï¼ˆç”¨äºå¢é‡å¯¹æ¯”ï¼‰
            loadPreviousFileList();
            
            // åŠ è½½ä¿å­˜çš„ URL å‰ç¼€é…ç½®
            loadUrlPrefixConfig();
            
            // åŠ è½½ä¿å­˜çš„ URL ç¼–ç å¼€å…³çŠ¶æ€
            loadUrlEncodeConfig();
            
            // åŠ è½½ä¿å­˜çš„ WebDAV é…ç½®
            loadWebdavConfig();
            
            // åˆå§‹åŒ– WebDAV è‡ªåŠ¨ä¿å­˜
            initWebdavAutoSave();
            
            // åˆå§‹åŒ–æ¨¡æ€æ¡†æ‹–åŠ¨å’Œç¼©æ”¾åŠŸèƒ½
            initModalDrag();
            initModalResize();
            
            // ç›‘å¬ESCé”®å…³é—­æ¨¡æ€æ¡†
            document.addEventListener('keydown', handleKeyDown);

            // åˆå§‹åŒ–åˆ®å‰Šæ£€æµ‹åŠŸèƒ½
            initScrapeDetection();
            
            // åˆå§‹åŒ– Tab ç³»ç»Ÿ
            initTabs();
        });

        // ==================== Tab ç³»ç»ŸåŠŸèƒ½ ====================

        // åˆ‡æ¢ Tab
        function switchTab(tabId) {
            // éšè—æ‰€æœ‰æ ‡ç­¾é¡µå†…å®¹
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // ç§»é™¤æ‰€æœ‰ Tab æŒ‰é’®çš„æ¿€æ´»çŠ¶æ€
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // æ˜¾ç¤ºç›®æ ‡æ ‡ç­¾é¡µ
            const targetContent = document.getElementById(tabId);
            if (targetContent) {
                targetContent.classList.add('active');
            }
            
            // æ¿€æ´»å¯¹åº”çš„ Tab æŒ‰é’®
            const targetBtn = document.querySelector(`.tab-btn[data-tab="${tabId}"]`);
            if (targetBtn) {
                targetBtn.classList.add('active');
            }
            
            // ä¿å­˜å½“å‰ Tab çŠ¶æ€åˆ° localStorage
            localStorage.setItem('strm_activeTab', tabId);
        }

        // åˆå§‹åŒ– Tab ç³»ç»Ÿ
        function initTabs() {
            // ä» localStorage æ¢å¤æ ‡ç­¾çŠ¶æ€
            const savedTab = localStorage.getItem('strm_activeTab');
            if (savedTab) {
                switchTab(savedTab);
            }
        }

        // ==================== åˆ®å‰Šæ£€æµ‹åŠŸèƒ½ ====================

        // åˆ®å‰Šæ£€æµ‹å…¨å±€çŠ¶æ€
        let scrapeParsedData = null;
        let scrapeMediaDirs = [];
        let scrapeUnscrapedDirs = [];
        let scrapeScrapedDirs = [];
        let allUnscrapedDirs = []; // ç”¨äºæœç´¢è¿‡æ»¤
        let scrapeStrmFilePaths = []; // å­˜å‚¨ strm æ–‡ä»¶è·¯å¾„ä¿¡æ¯ï¼Œæ ¼å¼: [{filePath: 'av/movie1/xxx.strm', dirPath: 'av/movie1'}]

        // é»˜è®¤åˆ®å‰Šæ ‡è¯†åˆ—è¡¨
        const DEFAULT_SCRAPE_INDICATORS = [
            '.nfo',
            'poster.jpg',
            'fanart.jpg',
            'folder.jpg',
            'thumb.jpg',
            'banner.jpg'
        ];

        // å½“å‰ä½¿ç”¨çš„åˆ®å‰Šæ ‡è¯†åˆ—è¡¨
        let currentScrapeIndicators = [...DEFAULT_SCRAPE_INDICATORS];

        // è§†é¢‘æ–‡ä»¶æ‰©å±•åï¼ˆç”¨äºåˆ¤æ–­åª’ä½“ç›®å½•ï¼‰
        const VIDEO_EXTENSIONS = [
            'mp4', 'mkv', 'avi', 'ts', 'm2ts', 'rmvb', 'rm', 'wmv',
            'flv', 'mov', 'webm', 'm4v', 'mpeg', 'mpg', '3gp', '3g2',
            'iso', 'bdmv'
        ];

        // åˆå§‹åŒ–åˆ®å‰Šæ£€æµ‹åŠŸèƒ½
        function initScrapeDetection() {
            // åˆå§‹åŒ–æ‹–æ‹½åŒºåŸŸ
            initScrapeDropZone();
            
            // åŠ è½½ä¿å­˜çš„åˆ®å‰Šæ ‡è¯†é…ç½®
            loadScrapeIndicatorsFromStorage();
            renderScrapeIndicatorTags();
            
            // åˆå§‹åŒ– File System Access API æ”¯æŒ
            initFileSystemAccessUI();
        }

        // ==================== File System Access API æ”¯æŒ ====================

        // æ£€æŸ¥æµè§ˆå™¨æ˜¯å¦æ”¯æŒ File System Access API
        function isFileSystemAccessSupported() {
            return 'showDirectoryPicker' in window;
        }

        // åˆå§‹åŒ– File System Access UI
        function initFileSystemAccessUI() {
            const folderOption = document.getElementById('scrapeImportFolder');
            const divider = document.getElementById('scrapeImportDivider');
            
            if (!folderOption || !divider) return;
            
            if (isFileSystemAccessSupported()) {
                // æµè§ˆå™¨æ”¯æŒï¼Œæ˜¾ç¤ºæ–‡ä»¶å¤¹é€‰æ‹©æŒ‰é’®
                folderOption.style.display = 'block';
                divider.style.display = 'flex';
            } else {
                // æµè§ˆå™¨ä¸æ”¯æŒï¼Œä¿æŒéšè—å¹¶å¯é€‰æ˜¾ç¤ºæç¤º
                folderOption.style.display = 'none';
                divider.style.display = 'none';
            }
        }

        // é€‰æ‹©æ–‡ä»¶å¤¹è¿›è¡Œåˆ®å‰Šæ£€æµ‹
        async function selectScrapeFolder() {
            if (!isFileSystemAccessSupported()) {
                showToast('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒæ–‡ä»¶å¤¹é€‰æ‹©åŠŸèƒ½ï¼Œè¯·ä½¿ç”¨ Chrome æˆ– Edge æµè§ˆå™¨', 'error');
                return;
            }
            
            try {
                // è°ƒç”¨ File System Access API é€‰æ‹©æ–‡ä»¶å¤¹
                const dirHandle = await window.showDirectoryPicker({
                    mode: 'read',
                    id: 'strm-scrape-folder'  // å”¯ä¸€IDï¼Œæµè§ˆå™¨ä¼šè®°ä½è¿™ä¸ªé€‰æ‹©å™¨ä¸Šæ¬¡æ‰“å¼€çš„ä½ç½®
                });
                
                // æ˜¾ç¤ºæ‰«æè¿›åº¦
                showScrapeScanProgress();
                
                // éå†ç›®å½•
                const files = [];
                let dirCount = 0;
                let fileCount = 0;
                
                await traverseScrapeDirectory(dirHandle, '', files, (dirs, filesScanned) => {
                    dirCount = dirs;
                    fileCount = filesScanned;
                    updateScrapeScanStats(dirs, filesScanned);
                });
                
                // éšè—æ‰«æè¿›åº¦
                hideScrapeScanProgress();
                
                // æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
                const folderName = dirHandle.name;
                document.getElementById('scrapeFileName').textContent = `ğŸ“ ${folderName}`;
                document.getElementById('scrapeFileSize').textContent = `${dirCount} ä¸ªæ–‡ä»¶å¤¹, ${fileCount} ä¸ªæ–‡ä»¶`;
                document.getElementById('scrapeFileInfo').classList.add('visible');
                document.getElementById('scrapeFileInfo').querySelector('.file-info-icon').textContent = 'ğŸ“';
                
                // å¤„ç†æ‰«æç»“æœ
                processScrapeFromFileSystem(files, folderName);
                
                showToast(`æ‰«æå®Œæˆï¼š${dirCount} ä¸ªæ–‡ä»¶å¤¹, ${fileCount} ä¸ªæ–‡ä»¶`, 'success');
                
            } catch (err) {
                hideScrapeScanProgress();
                
                if (err.name === 'AbortError') {
                    // ç”¨æˆ·å–æ¶ˆé€‰æ‹©ï¼Œé™é»˜å¤„ç†
                    return;
                } else if (err.name === 'SecurityError' || err.name === 'NotAllowedError') {
                    showToast('æ— æ³•è®¿é—®æ–‡ä»¶å¤¹ï¼šæƒé™è¢«æ‹’ç»', 'error');
                } else {
                    console.error('é€‰æ‹©æ–‡ä»¶å¤¹é”™è¯¯:', err);
                    showToast('æ— æ³•è®¿é—®æ–‡ä»¶å¤¹: ' + err.message, 'error');
                }
            }
        }

        // é€’å½’éå†ç›®å½•
        async function traverseScrapeDirectory(dirHandle, currentPath, files, onProgress) {
            let dirCount = 0;
            let fileCount = 0;
            
            async function traverse(handle, path) {
                try {
                    for await (const entry of handle.values()) {
                        const entryPath = path ? `${path}/${entry.name}` : entry.name;
                        
                        if (entry.kind === 'file') {
                            files.push({
                                type: 'file',
                                name: entry.name,
                                path: entryPath
                            });
                            fileCount++;
                        } else if (entry.kind === 'directory') {
                            files.push({
                                type: 'directory',
                                name: entry.name,
                                path: entryPath
                            });
                            dirCount++;
                            
                            // æ›´æ–°è¿›åº¦
                            if (onProgress) {
                                onProgress(dirCount, fileCount);
                            }
                            
                            // é€’å½’éå†å­ç›®å½•
                            await traverse(entry, entryPath);
                        }
                    }
                } catch (err) {
                    // æŸäº›ç›®å½•å¯èƒ½æ— æ³•è®¿é—®ï¼Œè·³è¿‡å¹¶ç»§ç»­
                    console.warn(`æ— æ³•è®¿é—®ç›®å½• ${path}:`, err);
                }
            }
            
            await traverse(dirHandle, currentPath);
            
            // æœ€ç»ˆæ›´æ–°è¿›åº¦
            if (onProgress) {
                onProgress(dirCount, fileCount);
            }
            
            return { dirCount, fileCount };
        }

        // æ˜¾ç¤ºæ‰«æè¿›åº¦
        function showScrapeScanProgress() {
            const progressEl = document.getElementById('scrapeScanProgress');
            if (progressEl) {
                progressEl.style.display = 'block';
                document.getElementById('scrapeScanStatusText').textContent = 'æ­£åœ¨æ‰«æ...';
                document.getElementById('scrapeScanDirCount').textContent = '0';
                document.getElementById('scrapeScanFileCount').textContent = '0';
            }
        }

        // éšè—æ‰«æè¿›åº¦
        function hideScrapeScanProgress() {
            const progressEl = document.getElementById('scrapeScanProgress');
            if (progressEl) {
                progressEl.style.display = 'none';
            }
        }

        // æ›´æ–°æ‰«æç»Ÿè®¡
        function updateScrapeScanStats(dirCount, fileCount) {
            document.getElementById('scrapeScanDirCount').textContent = dirCount;
            document.getElementById('scrapeScanFileCount').textContent = fileCount;
        }

        // ä» File System Access API ç»“æœå¤„ç†åˆ®å‰Šæ£€æµ‹
        function processScrapeFromFileSystem(files, rootFolderName) {
            // æ„å»ºä¸ parseScrapeDirectoryTree ç›¸åŒæ ¼å¼çš„æ•°æ®ç»“æ„
            const root = { name: rootFolderName, type: 'folder', children: [], path: [rootFolderName] };
            
            // åˆ›å»ºè·¯å¾„åˆ°èŠ‚ç‚¹çš„æ˜ å°„
            const pathToNode = new Map();
            pathToNode.set('', root);
            
            // æŒ‰è·¯å¾„æ·±åº¦æ’åºï¼Œç¡®ä¿çˆ¶ç›®å½•å…ˆè¢«å¤„ç†
            files.sort((a, b) => {
                const depthA = a.path.split('/').length;
                const depthB = b.path.split('/').length;
                return depthA - depthB;
            });
            
            // æ„å»ºæ ‘å½¢ç»“æ„
            for (const file of files) {
                const pathParts = file.path.split('/');
                const name = pathParts[pathParts.length - 1];
                const parentPath = pathParts.slice(0, -1).join('/');
                
                // æ‰¾åˆ°çˆ¶èŠ‚ç‚¹
                let parentNode = pathToNode.get(parentPath);
                if (!parentNode) {
                    // å¦‚æœçˆ¶èŠ‚ç‚¹ä¸å­˜åœ¨ï¼Œä»æ ¹èŠ‚ç‚¹å¼€å§‹åˆ›å»º
                    parentNode = root;
                }
                
                // åˆ›å»ºèŠ‚ç‚¹
                const node = {
                    name: name,
                    type: file.type === 'directory' ? 'folder' : 'file',
                    path: [rootFolderName, ...pathParts]
                };
                
                if (file.type === 'directory') {
                    node.children = [];
                    pathToNode.set(file.path, node);
                }
                
                // æ·»åŠ åˆ°çˆ¶èŠ‚ç‚¹
                if (parentNode.children) {
                    parentNode.children.push(node);
                }
            }
            
            // ä¿å­˜è§£æç»“æœ
            scrapeParsedData = root;
            
            // æ£€æµ‹åˆ®å‰ŠçŠ¶æ€
            detectScrapeStatus();
        }

        // åˆå§‹åŒ–åˆ®å‰Šæ£€æµ‹æ‹–æ‹½åŒºåŸŸ
        function initScrapeDropZone() {
            const dropZone = document.getElementById('scrapeDropZone');
            const fileInput = document.getElementById('scrapeFileInput');

            if (!dropZone || !fileInput) return;

            dropZone.addEventListener('click', () => fileInput.click());

            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('dragover');
            });

            dropZone.addEventListener('dragleave', () => {
                dropZone.classList.remove('dragover');
            });

            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleScrapeFile(files[0]);
                }
            });

            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleScrapeFile(e.target.files[0]);
                }
            });
        }

        // è¯»å–åˆ®å‰Šæ£€æµ‹æ–‡ä»¶å†…å®¹ï¼ˆæ”¯æŒ GBK/GB2312 ç¼–ç ï¼‰
        async function readScrapeFileContent(file) {
            const buffer = await file.arrayBuffer();
            const bytes = new Uint8Array(buffer);
            
            // UTF-8 BOM
            if (bytes.length >= 3 && bytes[0] === 0xEF && bytes[1] === 0xBB && bytes[2] === 0xBF) {
                console.log('æ£€æµ‹åˆ° UTF-8 BOM ç¼–ç ');
                return new TextDecoder('utf-8').decode(buffer);
            }
            // UTF-16 LE BOM
            if (bytes.length >= 2 && bytes[0] === 0xFF && bytes[1] === 0xFE) {
                console.log('æ£€æµ‹åˆ° UTF-16 LE ç¼–ç ');
                return new TextDecoder('utf-16le').decode(buffer);
            }
            // UTF-16 BE BOM
            if (bytes.length >= 2 && bytes[0] === 0xFE && bytes[1] === 0xFF) {
                console.log('æ£€æµ‹åˆ° UTF-16 BE ç¼–ç ');
                return new TextDecoder('utf-16be').decode(buffer);
            }
            
            // æ—  BOMï¼Œå°è¯• UTF-8ï¼Œå¦‚æœæœ‰ä¹±ç åˆ™å°è¯• GBK
            let text = new TextDecoder('utf-8').decode(buffer);
            
            // æ£€æŸ¥æ˜¯å¦æœ‰æ›¿æ¢å­—ç¬¦ï¼ˆä¹±ç æ ‡å¿—ï¼‰æˆ–è€…é¦–å­—ç¬¦æ˜¯é«˜ä½å­—èŠ‚
            if (text.includes('\uFFFD') || /[\x80-\xFF]/.test(text.charAt(0))) {
                console.log('æ£€æµ‹åˆ°å¯èƒ½æ˜¯ GBK/GB2312 ç¼–ç ï¼Œå°è¯• GBK è§£ç ');
                // å°è¯• GBK ç¼–ç 
                try {
                    text = new TextDecoder('gbk').decode(buffer);
                    console.log('ä½¿ç”¨ GBK è§£ç æˆåŠŸ');
                } catch (e) {
                    console.warn('GBK è§£ç å¤±è´¥ï¼Œå°è¯• gb18030');
                    // å¦‚æœ GBK è§£ç å™¨ä¸å¯ç”¨ï¼Œå°è¯•ä½¿ç”¨ gb18030
                    try {
                        text = new TextDecoder('gb18030').decode(buffer);
                        console.log('ä½¿ç”¨ GB18030 è§£ç æˆåŠŸ');
                    } catch (e2) {
                        console.warn('GB18030 è§£ç å¤±è´¥ï¼Œä½¿ç”¨ UTF-8');
                    }
                }
            } else {
                console.log('ä½¿ç”¨ UTF-8 ç¼–ç ');
            }
            
            return text;
        }

        // å¤„ç†åˆ®å‰Šæ£€æµ‹æ–‡ä»¶
        async function handleScrapeFile(file) {
            console.log('handleScrapeFile() è¢«è°ƒç”¨ï¼Œæ–‡ä»¶:', file.name);
            
            if (!file.name.endsWith('.txt')) {
                showToast('è¯·é€‰æ‹© .txt æ ¼å¼çš„æ–‡ä»¶', 'error');
                return;
            }

            // æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
            document.getElementById('scrapeFileName').textContent = file.name;
            document.getElementById('scrapeFileSize').textContent = formatFileSize(file.size);
            document.getElementById('scrapeFileInfo').classList.add('visible');

            try {
                // ä½¿ç”¨æ”¯æŒ GBK çš„æ–‡ä»¶è¯»å–å‡½æ•°
                const content = await readScrapeFileContent(file);
                console.log('æ–‡ä»¶å†…å®¹é•¿åº¦:', content.length, 'å­—ç¬¦');
                console.log('æ–‡ä»¶å†…å®¹å‰500å­—ç¬¦:', content.substring(0, 500));
                parseScrapeDirectoryTree(content);
                showToast('æ–‡ä»¶è§£ææˆåŠŸï¼Œå¼€å§‹æ£€æµ‹åˆ®å‰ŠçŠ¶æ€', 'success');
            } catch (error) {
                console.error('è§£æé”™è¯¯:', error);
                showToast('æ–‡ä»¶è§£æå¤±è´¥: ' + error.message, 'error');
            }
        }

        // ç§»é™¤åˆ®å‰Šæ£€æµ‹æ–‡ä»¶
        function removeScrapeFile() {
            document.getElementById('scrapeFileInfo').classList.remove('visible');
            document.getElementById('scrapeFileInput').value = '';
            document.getElementById('scrapeResultCard').style.display = 'none';
            document.getElementById('unscrapedListCard').style.display = 'none';
            scrapeParsedData = null;
            scrapeMediaDirs = [];
            scrapeUnscrapedDirs = [];
            scrapeScrapedDirs = [];
            allUnscrapedDirs = [];
        }

        // è§£æç›®å½•æ ‘å¹¶æ£€æµ‹åˆ®å‰ŠçŠ¶æ€ï¼ˆæ”¯æŒ tree /a å’Œ tree /f æ ¼å¼ï¼‰
        function parseScrapeDirectoryTree(content) {
            console.log('parseScrapeDirectoryTree() è¢«è°ƒç”¨');
            
            const lines = content.split(/\r?\n/);
            console.log('åŸå§‹è¡Œæ•°:', lines.length);
            
            const root = { name: 'root', type: 'folder', children: [], path: [] };
            const stack = [{ node: root, level: -1 }];
            
            let folderCount = 0;
            let fileCount = 0;
            let debugFileCount = 0; // ç”¨äºè°ƒè¯•è¾“å‡º
            
            for (const line of lines) {
                // è·³è¿‡ç©ºè¡Œ
                if (!line.trim()) continue;
                
                // è·³è¿‡ Windows tree å‘½ä»¤çš„æ ‡é¢˜è¡Œ
                // ä¾‹å¦‚ï¼šå· xxx çš„æ–‡ä»¶å¤¹ PATH åˆ—è¡¨ã€å·çš„åºåˆ—å·æ˜¯ xxx
                if (line.includes('å·çš„åºåˆ—å·') || line.includes('çš„æ–‡ä»¶å¤¹ PATH åˆ—è¡¨')) {
                    console.log('è·³è¿‡æ ‡é¢˜è¡Œ:', line);
                    continue;
                }
                
                // è·³è¿‡æ ¹ç›®å½•è¡Œï¼Œå¦‚ "F:." æˆ– "C:\." æˆ– "F:" ç­‰
                if (/^[A-Z]:\\?\.?$/i.test(line.trim())) {
                    console.log('è·³è¿‡æ ¹ç›®å½•è¡Œ:', line);
                    continue;
                }
                
                let level = 0;
                let name = '';
                let isFile = false;
                
                // æ£€æµ‹è¡Œç±»å‹ï¼š
                // 1. æ–‡ä»¶å¤¹è¡Œï¼šåŒ…å« +--- æˆ– \---
                // 2. æ–‡ä»¶è¡Œï¼šåªæœ‰ | å’Œç©ºæ ¼ï¼Œç„¶åæ˜¯æ–‡ä»¶åï¼ˆç”¨æˆ·çš„ tree æ ¼å¼ï¼‰
                // 3. Unicode æ ¼å¼ï¼šâ”œâ”€â”€ æˆ– â””â”€â”€
                
                // æ ¼å¼1: tree /a æ–‡ä»¶å¤¹è¡Œ - åŒ…å« +--- æˆ– \---
                const folderMatch = line.match(/^([\s|]*)[+\\]---\s*(.+)$/);
                if (folderMatch) {
                    const prefix = folderMatch[1];
                    name = folderMatch[2].trim();
                    // è®¡ç®—å±‚çº§ï¼šæ¯ä¸ª | åé¢è·Ÿç€ç©ºæ ¼ä»£è¡¨ä¸€å±‚
                    // ä¾‹å¦‚: "|   |   +---" ä¸­æœ‰2ä¸ª |ï¼Œæ‰€ä»¥æ˜¯ç¬¬2å±‚
                    level = (prefix.match(/\|/g) || []).length;
                    isFile = false;
                    
                    // ä½†ä¹Ÿè¦æ£€æŸ¥åç§°æ˜¯å¦æœ‰æ‰©å±•åï¼ˆæœ‰äº›æƒ…å†µä¸‹æ–‡ä»¶ä¹Ÿä¼šç”¨ +--- æ ¼å¼ï¼‰
                    if (/\.[a-zA-Z0-9]+$/.test(name)) {
                        isFile = true;
                    }
                } else {
                    // æ ¼å¼2: Unicode æ ¼å¼ - â”œâ”€â”€ æˆ– â””â”€â”€
                    const unicodeMatch = line.match(/^([\sâ”‚]*)[â”œâ””]â”€â”€\s*(.+)$/);
                    if (unicodeMatch) {
                        const prefix = unicodeMatch[1];
                        name = unicodeMatch[2].trim();
                        // è®¡ç®—å±‚çº§
                        level = (prefix.match(/â”‚/g) || []).length;
                        isFile = /\.[a-zA-Z0-9]+$/.test(name);
                    } else {
                        // æ ¼å¼3: æ–‡ä»¶è¡Œ - åªæœ‰ | å’Œç©ºæ ¼çš„ç»„åˆï¼Œç„¶åæ˜¯æ–‡ä»¶å
                        // ä¾‹å¦‚: "|   |       filename.ext"
                        // åŒ¹é…æ¨¡å¼ï¼šä»¥ | å’Œç©ºæ ¼å¼€å¤´ï¼Œç„¶åæ˜¯è¿ç»­ç©ºæ ¼ï¼Œæœ€åæ˜¯æ–‡ä»¶å
                        const fileMatch = line.match(/^([\s|]+)\s{2,}([^\s|][^\r\n]*)$/);
                        if (fileMatch) {
                            const prefix = fileMatch[1];
                            const potentialName = fileMatch[2].trim();
                            
                            // æ£€æŸ¥æ˜¯å¦æœ‰æ‰©å±•åï¼ˆç¡®è®¤æ˜¯æ–‡ä»¶ï¼‰
                            if (/\.[a-zA-Z0-9]+$/.test(potentialName)) {
                                name = potentialName;
                                // è®¡ç®—å±‚çº§ï¼šç»Ÿè®¡ | çš„æ•°é‡
                                level = (prefix.match(/\|/g) || []).length;
                                isFile = true;
                                
                                // è°ƒè¯•ï¼šè¾“å‡ºå‰10ä¸ªè§£æåˆ°çš„æ–‡ä»¶
                                if (debugFileCount < 10) {
                                    console.log(`è§£æåˆ°æ–‡ä»¶: "${name}", å±‚çº§: ${level}, è¡Œå†…å®¹: "${line.substring(0, 80)}"`);
                                    debugFileCount++;
                                }
                            }
                        } else {
                            // æ ¼å¼4: æ—§æ ¼å¼ - ä½¿ç”¨ |-
                            const oldMatch = line.match(/\|-\s*(.+)$/);
                            if (oldMatch) {
                                name = oldMatch[1].trim();
                                level = (line.match(/\|/g) || []).length;
                                isFile = /\.[a-zA-Z0-9]+$/.test(name);
                            }
                        }
                    }
                }
                
                if (!name) continue;
                
                const node = {
                    name: name,
                    type: isFile ? 'file' : 'folder',
                    children: isFile ? undefined : [],
                    path: []
                };

                // æ‰¾åˆ°æ­£ç¡®çš„çˆ¶èŠ‚ç‚¹
                while (stack.length > 1 && stack[stack.length - 1].level >= level) {
                    stack.pop();
                }

                const parent = stack[stack.length - 1].node;
                node.path = [...(parent.path || []), name];
                
                if (parent.children) {
                    parent.children.push(node);
                }

                if (!isFile) {
                    stack.push({ node, level });
                    folderCount++;
                } else {
                    fileCount++;
                }
            }

            scrapeParsedData = root;
            
            console.log('è§£æå®Œæˆ: æ–‡ä»¶å¤¹æ•°é‡:', folderCount, ', æ–‡ä»¶æ•°é‡:', fileCount);
            console.log('æ ¹èŠ‚ç‚¹å­èŠ‚ç‚¹æ•°é‡:', root.children.length);
            if (root.children.length > 0) {
                console.log('ç¬¬ä¸€ä¸ªå­èŠ‚ç‚¹:', root.children[0]);
            }

            // æ£€æµ‹åˆ®å‰ŠçŠ¶æ€
            detectScrapeStatus();
        }

        // æ£€æµ‹åˆ®å‰ŠçŠ¶æ€
        function detectScrapeStatus() {
            console.log('detectScrapeStatus() è¢«è°ƒç”¨');
            console.log('scrapeParsedData:', scrapeParsedData);
            
            scrapeMediaDirs = [];
            scrapeUnscrapedDirs = [];
            scrapeScrapedDirs = [];
            scrapeStrmFilePaths = []; // æ¸…ç©ºå¹¶é‡æ–°æ”¶é›† strm æ–‡ä»¶è·¯å¾„

            let traverseCount = 0;

            // éå†ç›®å½•æ ‘ï¼Œæ‰¾å‡ºåª’ä½“ç›®å½•å¹¶æ£€æµ‹åˆ®å‰ŠçŠ¶æ€
            function traverseAndDetect(node) {
                traverseCount++;
                
                if (node.type === 'folder' && node.children) {
                    // æ”¶é›†å½“å‰ç›®å½•ä¸­çš„ strm æ–‡ä»¶
                    const strmFiles = [];
                    for (const child of node.children) {
                        if (child.type === 'file' && child.name.toLowerCase().endsWith('.strm')) {
                            console.log('å‘ç° STRM æ–‡ä»¶:', child.name);
                            strmFiles.push(child);
                        }
                    }
                    
                    const hasStrmFile = strmFiles.length > 0;

                    if (hasStrmFile) {
                        // è¿™æ˜¯ä¸€ä¸ªåª’ä½“ç›®å½•ï¼ˆåŒ…å« .strm æ–‡ä»¶ï¼‰
                        const dirPath = node.path.join('/');
                        console.log('å‘ç°åª’ä½“ç›®å½•ï¼ˆå« .strmï¼‰:', dirPath);
                        scrapeMediaDirs.push(dirPath);

                        // æ£€æŸ¥æ˜¯å¦å·²åˆ®å‰Šï¼ˆæ–°è§„åˆ™ï¼šå¿…é¡»åŒæ—¶æœ‰ NFO å’Œå›¾ç‰‡ï¼‰
                        const scrapeResult = checkIfScraped(node);
                        console.log(`ç›®å½•: ${dirPath}, æœ‰strm: true, æœ‰nfo: ${scrapeResult.hasNfo}, æœ‰å›¾ç‰‡: ${scrapeResult.hasImage}, å·²åˆ®å‰Š: ${scrapeResult.isScraped}`);
                        if (scrapeResult.isScraped) {
                            scrapeScrapedDirs.push(dirPath);
                        } else {
                            // å­˜å‚¨å¯¹è±¡åŒ…å«è·¯å¾„å’Œç¼ºå¤±çŠ¶æ€
                            scrapeUnscrapedDirs.push({
                                path: dirPath,
                                hasNfo: scrapeResult.hasNfo,
                                hasImage: scrapeResult.hasImage
                            });
                            
                            // æ”¶é›†æœªåˆ®å‰Šç›®å½•ä¸­çš„ strm æ–‡ä»¶è·¯å¾„
                            for (const strmFile of strmFiles) {
                                scrapeStrmFilePaths.push({
                                    filePath: strmFile.path.join('/'),  // å¦‚ 'av/movie1/xxx.strm'
                                    dirPath: dirPath                     // æ‰€å±ç›®å½•è·¯å¾„
                                });
                            }
                        }
                    }

                    // é€’å½’å¤„ç†å­ç›®å½•
                    for (const child of node.children) {
                        if (child.type === 'folder') {
                            traverseAndDetect(child);
                        }
                    }
                }
            }

            traverseAndDetect(scrapeParsedData);
            
            console.log('æ”¶é›†åˆ°çš„ STRM æ–‡ä»¶è·¯å¾„æ•°é‡:', scrapeStrmFilePaths.length);
            
            console.log('éå†å®Œæˆï¼Œå…±éå†èŠ‚ç‚¹æ•°:', traverseCount);
            console.log('åª’ä½“ç›®å½•æ€»æ•°:', scrapeMediaDirs.length);
            console.log('å·²åˆ®å‰Šç›®å½•æ•°:', scrapeScrapedDirs.length);
            console.log('æœªåˆ®å‰Šç›®å½•æ•°:', scrapeUnscrapedDirs.length);

            // ä¿å­˜å®Œæ•´åˆ—è¡¨ç”¨äºæœç´¢è¿‡æ»¤
            allUnscrapedDirs = [...scrapeUnscrapedDirs];

            // æ›´æ–°UI
            updateScrapeResultsUI();
        }

        // æ£€æŸ¥ç›®å½•æ˜¯å¦å·²åˆ®å‰Šï¼ˆæ–°è§„åˆ™ï¼šå¿…é¡»åŒæ—¶æœ‰ NFO å’Œå›¾ç‰‡ï¼‰
        function checkIfScraped(dirNode) {
            if (!dirNode.children) return { isScraped: false, hasNfo: false, hasImage: false };

            let hasNfo = false;
            let hasImage = false;
            
            // å›¾ç‰‡æ ‡è¯†åˆ—è¡¨
            const IMAGE_INDICATORS = [
                'poster.jpg', 'poster.png',
                'fanart.jpg', 'fanart.png',
                'folder.jpg', 'folder.png',
                'thumb.jpg', 'thumb.png',
                'banner.jpg', 'banner.png'
            ];

            for (const child of dirNode.children) {
                if (child.type !== 'file') continue;
                
                const fileName = child.name.toLowerCase();
                
                // æ£€æŸ¥ NFO æ–‡ä»¶
                if (fileName.endsWith('.nfo')) {
                    hasNfo = true;
                }
                
                // æ£€æŸ¥å›¾ç‰‡æ–‡ä»¶
                for (const indicator of IMAGE_INDICATORS) {
                    if (fileName.includes(indicator) || fileName.endsWith(indicator)) {
                        hasImage = true;
                        break;
                    }
                }
                
                // ä¸¤è€…éƒ½æœ‰ï¼Œå·²åˆ®å‰Šï¼Œå¯ä»¥æå‰è¿”å›
                if (hasNfo && hasImage) {
                    return { isScraped: true, hasNfo: true, hasImage: true };
                }
            }
            
            // å¿…é¡»åŒæ—¶æœ‰ NFO å’Œå›¾ç‰‡æ‰ç®—å·²åˆ®å‰Š
            return { isScraped: hasNfo && hasImage, hasNfo, hasImage };
        }

        // æ›´æ–°åˆ®å‰Šæ£€æµ‹ç»“æœUI
        function updateScrapeResultsUI() {
            console.log('updateScrapeResultsUI() è¢«è°ƒç”¨');
            
            const totalDirs = scrapeMediaDirs.length;
            const scrapedCount = scrapeScrapedDirs.length;
            const unscrapedCount = scrapeUnscrapedDirs.length;
            const scrapeRate = totalDirs > 0 ? Math.round((scrapedCount / totalDirs) * 100) : 0;

            console.log('ç»Ÿè®¡æ•°æ®: æ€»åª’ä½“ç›®å½•:', totalDirs, 'å·²åˆ®å‰Š:', scrapedCount, 'æœªåˆ®å‰Š:', unscrapedCount, 'åˆ®å‰Šç‡:', scrapeRate + '%');

            // æ˜¾ç¤ºç»“æœå¡ç‰‡
            const resultCard = document.getElementById('scrapeResultCard');
            console.log('scrapeResultCard å…ƒç´ :', resultCard);
            resultCard.style.display = 'block';

            // æ›´æ–°ç»Ÿè®¡æ•°å­—
            const totalEl = document.getElementById('scrapeTotalDirs');
            const scrapedEl = document.getElementById('scrapeScrapedDirs');
            const unscrapedEl = document.getElementById('scrapeUnscrapedDirs');
            console.log('ç»Ÿè®¡å…ƒç´ : totalEl=', totalEl, 'scrapedEl=', scrapedEl, 'unscrapedEl=', unscrapedEl);
            
            totalEl.textContent = totalDirs;
            scrapedEl.textContent = scrapedCount;
            unscrapedEl.textContent = unscrapedCount;

            // æ›´æ–°è¿›åº¦æ¡
            document.getElementById('scrapeProgressFill').style.width = `${scrapeRate}%`;
            document.getElementById('scrapeProgressText').textContent = `åˆ®å‰Šç‡ï¼š${scrapeRate}%`;

            // æ˜¾ç¤ºæœªåˆ®å‰Šåˆ—è¡¨å¡ç‰‡
            console.log('æœªåˆ®å‰Šç›®å½•æ•°é‡:', unscrapedCount);
            if (unscrapedCount > 0) {
                document.getElementById('unscrapedListCard').style.display = 'block';
                console.log('è°ƒç”¨ renderUnscrapedList(), ä¼ å…¥ç›®å½•æ•°:', scrapeUnscrapedDirs.length);
                renderUnscrapedList(scrapeUnscrapedDirs);
            } else {
                document.getElementById('unscrapedListCard').style.display = 'none';
                console.log('æ²¡æœ‰æœªåˆ®å‰Šç›®å½•ï¼Œéšè—åˆ—è¡¨å¡ç‰‡');
            }
            
            // æ˜¾ç¤º/éšè— STRM æ–‡ä»¶å¤åˆ¶åŒºåŸŸ
            const copySectionEl = document.getElementById('scrapeCopySection');
            if (copySectionEl) {
                if (isFileSystemAccessSupported() && unscrapedCount > 0) {
                    copySectionEl.style.display = 'block';
                } else {
                    copySectionEl.style.display = 'none';
                }
            }
        }

        // æ¸²æŸ“æœªåˆ®å‰Šç›®å½•åˆ—è¡¨
        function renderUnscrapedList(dirs) {
            console.log('renderUnscrapedList() è¢«è°ƒç”¨ï¼Œä¼ å…¥ç›®å½•æ•°:', dirs.length);
            
            const listEl = document.getElementById('unscrapedList');
            console.log('unscrapedList å…ƒç´ :', listEl);
            listEl.innerHTML = '';

            for (const item of dirs) {
                // å…¼å®¹æ—§æ ¼å¼ï¼ˆå­—ç¬¦ä¸²ï¼‰å’Œæ–°æ ¼å¼ï¼ˆå¯¹è±¡ï¼‰
                const dirPath = typeof item === 'string' ? item : item.path;
                const hasNfo = typeof item === 'object' ? item.hasNfo : true;
                const hasImage = typeof item === 'object' ? item.hasImage : true;
                
                // ç”Ÿæˆç¼ºå¤±æ ‡ç­¾
                let missingTags = [];
                if (!hasNfo) {
                    missingTags.push('<span class="missing-tag missing-nfo">ç¼ºå°‘ NFO</span>');
                }
                if (!hasImage) {
                    missingTags.push('<span class="missing-tag missing-image">ç¼ºå°‘å›¾ç‰‡</span>');
                }
                
                const li = document.createElement('li');
                li.className = 'unscraped-item';
                li.innerHTML = `
                    <span class="unscraped-item-icon">ğŸ“</span>
                    <span class="unscraped-item-path">${escapeHtml(dirPath)}</span>
                    <div class="missing-tags">${missingTags.join('')}</div>
                `;
                listEl.appendChild(li);
            }

            document.getElementById('unscrapedCount').textContent = `å…± ${dirs.length} ä¸ªæœªåˆ®å‰Šç›®å½•`;
            console.log('æœªåˆ®å‰Šç›®å½•åˆ—è¡¨æ¸²æŸ“å®Œæˆ');
        }

        // æœç´¢è¿‡æ»¤æœªåˆ®å‰Šåˆ—è¡¨
        function filterUnscrapedList() {
            const searchTerm = document.getElementById('unscrapedSearchInput').value.toLowerCase().trim();
            
            if (!searchTerm) {
                renderUnscrapedList(allUnscrapedDirs);
                return;
            }

            const filteredDirs = allUnscrapedDirs.filter(item => {
                // å…¼å®¹æ–°æ ¼å¼ï¼ˆå¯¹è±¡ï¼‰å’Œæ—§æ ¼å¼ï¼ˆå­—ç¬¦ä¸²ï¼‰
                const dirPath = typeof item === 'string' ? item : item.path;
                return dirPath.toLowerCase().includes(searchTerm);
            });
            
            renderUnscrapedList(filteredDirs);
        }

        // å¤åˆ¶æœªåˆ®å‰Šè·¯å¾„åˆ°å‰ªè´´æ¿
        function copyUnscrapedPaths() {
            if (allUnscrapedDirs.length === 0) {
                showToast('æ²¡æœ‰å¯å¤åˆ¶çš„è·¯å¾„', 'error');
                return;
            }

            // å…¼å®¹æ–°æ ¼å¼ï¼ˆå¯¹è±¡ï¼‰å’Œæ—§æ ¼å¼ï¼ˆå­—ç¬¦ä¸²ï¼‰
            const text = allUnscrapedDirs.map(item => {
                const dirPath = typeof item === 'string' ? item : item.path;
                return dirPath;
            }).join('\n');
            
            navigator.clipboard.writeText(text).then(() => {
                showToast(`å·²å¤åˆ¶ ${allUnscrapedDirs.length} ä¸ªè·¯å¾„åˆ°å‰ªè´´æ¿`, 'success');
            }).catch(() => {
                showToast('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶', 'error');
            });
        }

        // å¯¼å‡ºæœªåˆ®å‰Šè·¯å¾„ä¸º TXT æ–‡ä»¶
        function exportUnscrapedTxt() {
            if (allUnscrapedDirs.length === 0) {
                showToast('æ²¡æœ‰å¯å¯¼å‡ºçš„è·¯å¾„', 'error');
                return;
            }

            // å¯¼å‡ºæ—¶åŒ…å«ç¼ºå¤±ä¿¡æ¯
            const text = allUnscrapedDirs.map(item => {
                // å…¼å®¹æ–°æ ¼å¼ï¼ˆå¯¹è±¡ï¼‰å’Œæ—§æ ¼å¼ï¼ˆå­—ç¬¦ä¸²ï¼‰
                if (typeof item === 'string') {
                    return item;
                }
                
                let missing = [];
                if (!item.hasNfo) missing.push('ç¼ºå°‘NFO');
                if (!item.hasImage) missing.push('ç¼ºå°‘å›¾ç‰‡');
                return `${item.path}\t[${missing.join(', ')}]`;
            }).join('\n');
            
            const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
            const timestamp = new Date().toISOString().slice(0, 10).replace(/-/g, '');
            saveAs(blob, `unscraped_dirs_${timestamp}.txt`);
            showToast(`å·²å¯¼å‡º ${allUnscrapedDirs.length} ä¸ªè·¯å¾„`, 'success');
        }

        // ==================== åˆ®å‰Šæ ‡è¯†ç®¡ç†åŠŸèƒ½ ====================

        // æ¸²æŸ“åˆ®å‰Šæ ‡è¯†æ ‡ç­¾åˆ—è¡¨
        function renderScrapeIndicatorTags() {
            const container = document.getElementById('scrapeIndicatorTagList');
            if (!container) return;
            
            container.innerHTML = '';
            
            for (const indicator of currentScrapeIndicators) {
                const tag = document.createElement('span');
                tag.className = 'tag-item';
                tag.innerHTML = `
                    ${escapeHtml(indicator)}
                    <button class="tag-item-remove" onclick="removeScrapeIndicator('${escapeHtml(indicator).replace(/'/g, "\\'")}')">Ã—</button>
                `;
                container.appendChild(tag);
            }
        }

        // æ·»åŠ åˆ®å‰Šæ ‡è¯†
        function addScrapeIndicator() {
            const input = document.getElementById('scrapeIndicatorInput');
            const indicator = input.value.trim();
            
            if (!indicator) {
                showToast('è¯·è¾“å…¥æ–‡ä»¶å', 'error');
                return;
            }
            
            if (currentScrapeIndicators.some(i => i.toLowerCase() === indicator.toLowerCase())) {
                showToast('è¯¥æ ‡è¯†å·²å­˜åœ¨', 'error');
                return;
            }
            
            currentScrapeIndicators.push(indicator);
            saveScrapeIndicatorsToStorage();
            renderScrapeIndicatorTags();
            input.value = '';
            showToast(`å·²æ·»åŠ åˆ®å‰Šæ ‡è¯†: ${indicator}`, 'success');
            
            // å¦‚æœæœ‰å·²è§£æçš„æ•°æ®ï¼Œé‡æ–°æ£€æµ‹
            if (scrapeParsedData) {
                detectScrapeStatus();
            }
        }

        // åˆ é™¤åˆ®å‰Šæ ‡è¯†
        function removeScrapeIndicator(indicator) {
            const index = currentScrapeIndicators.findIndex(i => i === indicator);
            if (index > -1) {
                currentScrapeIndicators.splice(index, 1);
                saveScrapeIndicatorsToStorage();
                renderScrapeIndicatorTags();
                showToast(`å·²åˆ é™¤åˆ®å‰Šæ ‡è¯†: ${indicator}`, 'info');
                
                // å¦‚æœæœ‰å·²è§£æçš„æ•°æ®ï¼Œé‡æ–°æ£€æµ‹
                if (scrapeParsedData) {
                    detectScrapeStatus();
                }
            }
        }

        // é‡ç½®ä¸ºé»˜è®¤åˆ®å‰Šæ ‡è¯†
        function resetScrapeIndicators() {
            currentScrapeIndicators = [...DEFAULT_SCRAPE_INDICATORS];
            saveScrapeIndicatorsToStorage();
            renderScrapeIndicatorTags();
            showToast('å·²é‡ç½®ä¸ºé»˜è®¤åˆ®å‰Šæ ‡è¯†åˆ—è¡¨', 'success');
            
            // å¦‚æœæœ‰å·²è§£æçš„æ•°æ®ï¼Œé‡æ–°æ£€æµ‹
            if (scrapeParsedData) {
                detectScrapeStatus();
            }
        }

        // å¤„ç†å›è½¦é”®æ·»åŠ åˆ®å‰Šæ ‡è¯†
        function handleScrapeIndicatorKeypress(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                addScrapeIndicator();
            }
        }

        // ä¿å­˜åˆ®å‰Šæ ‡è¯†åˆ° localStorage
        function saveScrapeIndicatorsToStorage() {
            localStorage.setItem('strmScrapeIndicators', JSON.stringify(currentScrapeIndicators));
        }

        // ä» localStorage åŠ è½½åˆ®å‰Šæ ‡è¯†
        function loadScrapeIndicatorsFromStorage() {
            const saved = localStorage.getItem('strmScrapeIndicators');
            if (saved) {
                try {
                    currentScrapeIndicators = JSON.parse(saved);
                } catch (e) {
                    currentScrapeIndicators = [...DEFAULT_SCRAPE_INDICATORS];
                }
            }
        }

        // ==================== STRM æ–‡ä»¶å¤åˆ¶åŠŸèƒ½ ====================
        
        // ç¼“å­˜ DirectoryHandle ç”¨äºè®°ä½ä¸Šæ¬¡é€‰æ‹©çš„æ–‡ä»¶å¤¹
        let cachedSrcDirHandle = null;
        let cachedDestDirHandle = null;
        
        // é€‰æ‹©æºç›®å½•
        async function selectSrcDirectory() {
            if (!isFileSystemAccessSupported()) {
                showToast('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒæ­¤åŠŸèƒ½ï¼Œè¯·ä½¿ç”¨ Chrome æˆ– Edge æµè§ˆå™¨', 'error');
                return;
            }
            
            try {
                const dirHandle = await window.showDirectoryPicker({
                    mode: 'read',
                    id: 'strm-copy-src'  // å”¯ä¸€IDï¼Œæµè§ˆå™¨ä¼šè®°ä½è¿™ä¸ªé€‰æ‹©å™¨ä¸Šæ¬¡æ‰“å¼€çš„ä½ç½®
                });
                
                cachedSrcDirHandle = dirHandle;
                
                // æ›´æ–° UI
                const nameEl = document.getElementById('srcDirName');
                nameEl.textContent = dirHandle.name;
                nameEl.classList.add('selected');
                
                const btn = document.getElementById('selectSrcDirBtn');
                btn.classList.add('selected');
                btn.querySelector('span:last-child').textContent = 'æ›´æ¢ç›®å½•';
                
                showToast(`å·²é€‰æ‹©æºç›®å½•: ${dirHandle.name}`, 'success');
                
                // æ£€æŸ¥æ˜¯å¦å¯ä»¥å¼€å§‹å¤åˆ¶
                updateStartCopyButtonState();
                
            } catch (err) {
                if (err.name !== 'AbortError') {
                    console.error('é€‰æ‹©æºç›®å½•é”™è¯¯:', err);
                    showToast('é€‰æ‹©ç›®å½•å¤±è´¥: ' + err.message, 'error');
                }
            }
        }
        
        // é€‰æ‹©ç›®æ ‡ç›®å½•
        async function selectDestDirectory() {
            if (!isFileSystemAccessSupported()) {
                showToast('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒæ­¤åŠŸèƒ½ï¼Œè¯·ä½¿ç”¨ Chrome æˆ– Edge æµè§ˆå™¨', 'error');
                return;
            }
            
            try {
                const dirHandle = await window.showDirectoryPicker({
                    mode: 'readwrite',
                    id: 'strm-copy-dest'  // å”¯ä¸€IDï¼Œæµè§ˆå™¨ä¼šè®°ä½è¿™ä¸ªé€‰æ‹©å™¨ä¸Šæ¬¡æ‰“å¼€çš„ä½ç½®
                });
                
                cachedDestDirHandle = dirHandle;
                
                // æ›´æ–° UI
                const nameEl = document.getElementById('destDirName');
                nameEl.textContent = dirHandle.name;
                nameEl.classList.add('selected');
                
                const btn = document.getElementById('selectDestDirBtn');
                btn.classList.add('selected');
                btn.querySelector('span:last-child').textContent = 'æ›´æ¢ç›®å½•';
                
                showToast(`å·²é€‰æ‹©ç›®æ ‡ç›®å½•: ${dirHandle.name}`, 'success');
                
                // æ£€æŸ¥æ˜¯å¦å¯ä»¥å¼€å§‹å¤åˆ¶
                updateStartCopyButtonState();
                
            } catch (err) {
                if (err.name !== 'AbortError') {
                    console.error('é€‰æ‹©ç›®æ ‡ç›®å½•é”™è¯¯:', err);
                    showToast('é€‰æ‹©ç›®å½•å¤±è´¥: ' + err.message, 'error');
                }
            }
        }
        
        // æ›´æ–°å¼€å§‹å¤åˆ¶æŒ‰é’®çŠ¶æ€
        function updateStartCopyButtonState() {
            const startBtn = document.getElementById('startCopyBtn');
            if (cachedSrcDirHandle && cachedDestDirHandle) {
                startBtn.disabled = false;
            } else {
                startBtn.disabled = true;
            }
        }
        
        // å¼€å§‹å¤åˆ¶ STRM æ–‡ä»¶
        async function startStrmCopy() {
            if (!cachedSrcDirHandle || !cachedDestDirHandle) {
                showToast('è¯·å…ˆé€‰æ‹©æºç›®å½•å’Œç›®æ ‡ç›®å½•', 'error');
                return;
            }
            
            if (scrapeUnscrapedDirs.length === 0) {
                showToast('æ²¡æœ‰æœªåˆ®å‰Šç›®å½•', 'error');
                return;
            }
            
            // éªŒè¯æƒé™
            try {
                const srcPermission = await cachedSrcDirHandle.queryPermission({ mode: 'read' });
                if (srcPermission !== 'granted') {
                    const requestResult = await cachedSrcDirHandle.requestPermission({ mode: 'read' });
                    if (requestResult !== 'granted') {
                        showToast('éœ€è¦æºç›®å½•çš„è¯»å–æƒé™', 'error');
                        return;
                    }
                }
                
                const destPermission = await cachedDestDirHandle.queryPermission({ mode: 'readwrite' });
                if (destPermission !== 'granted') {
                    const requestResult = await cachedDestDirHandle.requestPermission({ mode: 'readwrite' });
                    if (requestResult !== 'granted') {
                        showToast('éœ€è¦ç›®æ ‡ç›®å½•çš„å†™å…¥æƒé™', 'error');
                        return;
                    }
                }
            } catch (err) {
                console.error('æƒé™éªŒè¯é”™è¯¯:', err);
                showToast('æƒé™éªŒè¯å¤±è´¥ï¼Œè¯·é‡æ–°é€‰æ‹©ç›®å½•', 'error');
                // æ¸…é™¤ç¼“å­˜ï¼Œè¦æ±‚é‡æ–°é€‰æ‹©
                cachedSrcDirHandle = null;
                cachedDestDirHandle = null;
                document.getElementById('srcDirName').textContent = 'æœªé€‰æ‹©';
                document.getElementById('srcDirName').classList.remove('selected');
                document.getElementById('destDirName').textContent = 'æœªé€‰æ‹©';
                document.getElementById('destDirName').classList.remove('selected');
                document.getElementById('selectSrcDirBtn').classList.remove('selected');
                document.getElementById('selectDestDirBtn').classList.remove('selected');
                document.getElementById('selectSrcDirBtn').querySelector('span:last-child').textContent = 'é€‰æ‹©ç›®å½•';
                document.getElementById('selectDestDirBtn').querySelector('span:last-child').textContent = 'é€‰æ‹©ç›®å½•';
                updateStartCopyButtonState();
                return;
            }
            
            // ç›´æ¥ä½¿ç”¨å·²è§£æçš„ strm æ–‡ä»¶è·¯å¾„
            const strmToCopy = scrapeStrmFilePaths;
            
            if (strmToCopy.length === 0) {
                showToast('æ²¡æœ‰éœ€è¦å¤åˆ¶çš„ STRM æ–‡ä»¶', 'info');
                return;
            }
            
            // æ˜¾ç¤ºè¿›åº¦
            const progressEl = document.getElementById('scrapeCopyProgress');
            const resultEl = document.getElementById('scrapeCopyResult');
            const statusText = document.getElementById('scrapeCopyStatusText');
            const progressFill = document.getElementById('scrapeCopyProgressFill');
            const copyCountEl = document.getElementById('scrapeCopyCount');
            const copyTotalEl = document.getElementById('scrapeCopyTotal');
            const startBtn = document.getElementById('startCopyBtn');
            
            progressEl.style.display = 'block';
            resultEl.style.display = 'none';
            startBtn.disabled = true;
            
            copyTotalEl.textContent = strmToCopy.length;
            statusText.textContent = 'æ­£åœ¨å¤åˆ¶...';
            progressFill.style.width = '0%';
            
            // è®°å½•æˆåŠŸå’Œå¤±è´¥çš„æ–‡ä»¶
            const successFiles = [];
            const failedFiles = [];  // {path: 'è·¯å¾„', error: 'é”™è¯¯ä¿¡æ¯'}
            
            // å¤åˆ¶æ–‡ä»¶
            for (const strmInfo of strmToCopy) {
                try {
                    // ä»æºç›®å½•æŒ‰å·²çŸ¥è·¯å¾„è·å–æ–‡ä»¶
                    const srcFile = await getFileByPath(cachedSrcDirHandle, strmInfo.filePath);
                    
                    // åœ¨ç›®æ ‡ç›®å½•åˆ›å»ºåŒæ ·çš„è·¯å¾„ç»“æ„å¹¶å†™å…¥
                    await copyFileToPath(cachedDestDirHandle, strmInfo.filePath, srcFile);
                    
                    successFiles.push(strmInfo.filePath);
                } catch (err) {
                    console.error(`å¤åˆ¶å¤±è´¥: ${strmInfo.filePath}`, err);
                    failedFiles.push({
                        path: strmInfo.filePath,
                        error: err.message || 'æœªçŸ¥é”™è¯¯'
                    });
                }
                
                // æ›´æ–°è¿›åº¦
                const processedCount = successFiles.length + failedFiles.length;
                copyCountEl.textContent = successFiles.length;
                const progress = (processedCount / strmToCopy.length) * 100;
                progressFill.style.width = `${progress}%`;
            }
            
            // éšè—è¿›åº¦ï¼Œæ˜¾ç¤ºç»“æœ
            progressEl.style.display = 'none';
            startBtn.disabled = false;
            
            // æ¸²æŸ“è¯¦ç»†ç»“æœ
            renderCopyResult(successFiles, failedFiles);
            
            if (failedFiles.length > 0) {
                showToast(`å¤åˆ¶å®Œæˆï¼šæˆåŠŸ ${successFiles.length} ä¸ªï¼Œå¤±è´¥ ${failedFiles.length} ä¸ª`, 'info');
            } else {
                showToast(`å¤åˆ¶å®Œæˆï¼šæˆåŠŸå¤åˆ¶ ${successFiles.length} ä¸ª STRM æ–‡ä»¶`, 'success');
            }
        }
        
        // æ¸²æŸ“å¤åˆ¶ç»“æœï¼ˆåŒ…å«æˆåŠŸå’Œå¤±è´¥çš„æ–‡ä»¶åˆ—è¡¨ï¼‰
        function renderCopyResult(successFiles, failedFiles) {
            const resultEl = document.getElementById('scrapeCopyResult');
            resultEl.style.display = 'block';
            
            let html = '';
            
            // æ‘˜è¦ä¿¡æ¯
            const hasErrors = failedFiles.length > 0;
            const summaryClass = hasErrors ? 'copy-result-summary has-errors' : 'copy-result-summary';
            html += `<div class="${summaryClass}">`;
            if (hasErrors) {
                html += `âœ… å¤åˆ¶å®Œæˆï¼šæˆåŠŸ ${successFiles.length} ä¸ªï¼Œå¤±è´¥ ${failedFiles.length} ä¸ª`;
            } else {
                html += `âœ… å¤åˆ¶å®Œæˆï¼šæˆåŠŸå¤åˆ¶ ${successFiles.length} ä¸ªæ–‡ä»¶`;
            }
            html += '</div>';
            
            // å¤±è´¥åˆ—è¡¨ï¼ˆå¦‚æœæœ‰ï¼‰
            if (failedFiles.length > 0) {
                html += '<div class="copy-failed-section" id="copyFailedSection">';
                html += '<h4>âŒ å¤±è´¥æ–‡ä»¶ï¼š</h4>';
                html += '<ul class="failed-list">';
                for (const item of failedFiles) {
                    html += `<li>${escapeHtml(item.path)} <span class="error-reason">- ${escapeHtml(item.error)}</span></li>`;
                }
                html += '</ul>';
                html += '</div>';
            }
            
            // æˆåŠŸåˆ—è¡¨ï¼ˆå¯æŠ˜å ï¼‰
            if (successFiles.length > 0) {
                html += '<details class="copy-success-section">';
                html += `<summary>âœ… æˆåŠŸæ–‡ä»¶ (${successFiles.length} ä¸ª)</summary>`;
                html += '<ul class="success-list">';
                for (const path of successFiles) {
                    html += `<li>${escapeHtml(path)}</li>`;
                }
                html += '</ul>';
                html += '</details>';
            }
            
            resultEl.innerHTML = html;
        }
        
        // ä¿ç•™æ—§å‡½æ•°åä»¥å…¼å®¹æ—§ä»£ç ï¼ˆå¦‚æœæœ‰å…¶ä»–åœ°æ–¹è°ƒç”¨ï¼‰
        async function copyStrmForScraping() {
            // å¦‚æœå·²ç»æœ‰ç¼“å­˜çš„ç›®å½•ï¼Œç›´æ¥å¼€å§‹å¤åˆ¶
            if (cachedSrcDirHandle && cachedDestDirHandle) {
                await startStrmCopy();
            } else {
                showToast('è¯·å…ˆé€‰æ‹©æºç›®å½•å’Œç›®æ ‡ç›®å½•', 'info');
            }
        }
        
        // æ ¹æ®ç›¸å¯¹è·¯å¾„è·å–æ–‡ä»¶ï¼ˆä¸æ‰«æç›®å½•ï¼Œç›´æ¥æŒ‰è·¯å¾„å®šä½ï¼‰
        async function getFileByPath(rootHandle, relativePath) {
            const parts = relativePath.split('/').filter(p => p);
            let currentHandle = rootHandle;
            
            // éå†ç›®å½•è·¯å¾„
            for (let i = 0; i < parts.length - 1; i++) {
                currentHandle = await currentHandle.getDirectoryHandle(parts[i]);
            }
            
            // è·å–æ–‡ä»¶
            const fileName = parts[parts.length - 1];
            const fileHandle = await currentHandle.getFileHandle(fileName);
            return await fileHandle.getFile();
        }
        
        // å¤åˆ¶æ–‡ä»¶åˆ°ç›®æ ‡è·¯å¾„ï¼ˆåˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„ï¼‰
        async function copyFileToPath(destRootHandle, relativePath, srcFile) {
            const parts = relativePath.split('/').filter(p => p);
            let currentHandle = destRootHandle;
            
            // åˆ›å»ºç›®å½•ç»“æ„
            for (let i = 0; i < parts.length - 1; i++) {
                currentHandle = await currentHandle.getDirectoryHandle(parts[i], { create: true });
            }
            
            // åˆ›å»ºæ–‡ä»¶å¹¶å†™å…¥å†…å®¹
            const fileName = parts[parts.length - 1];
            const content = await srcFile.text();
            const destFileHandle = await currentHandle.getFileHandle(fileName, { create: true });
            const writable = await destFileHandle.createWritable();
            await writable.write(content);
            await writable.close();
        }
        
        // åˆ›å»ºç›®å½•è·¯å¾„ï¼ˆé€’å½’åˆ›å»ºä¸å­˜åœ¨çš„ç›®å½•ï¼‰
        async function createDirectoryPath(rootDirHandle, relativePath) {
            if (!relativePath) return rootDirHandle;
            
            const parts = relativePath.split('/').filter(p => p);
            let currentHandle = rootDirHandle;
            
            for (const part of parts) {
                try {
                    currentHandle = await currentHandle.getDirectoryHandle(part, { create: true });
                } catch (err) {
                    console.error(`åˆ›å»ºç›®å½•å¤±è´¥: ${part}`, err);
                    throw err;
                }
            }
            
            return currentHandle;
        }
    </script>
</body>
</html>

